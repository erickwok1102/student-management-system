# 🔧 學員管理系統修復記錄 - 重要參考

## 📊 **系統配置 (絕對不能遺失)**

### **Google Apps Script 設定**
- **Web App URL**: `https://script.google.com/macros/s/AKfycbw_m3SjHokYxU-eUkFrMtcrVXnoxSGhRAfuUxYDt6P81UwmxcMrkKjz-h7A4teL8kKIjQ/exec`
- **Google Sheets ID**: `1paCFt-QxJ3HjTrA4lOnZFQjuw2I7jh8KkTPiNSbfcoo`
- **部署設定**:
  - 類型: 網頁應用程式
  - 執行身分: 我
  - 存取權限: 任何人
  - URL 必須以 `/exec` 結尾 (不是 `/dev`)

### **Google Sheets 工作表結構**
- ✅ **學員資料** - 存放學員信息
- ✅ **schedule** - 存放班別和課程資料 (含 2 個班別: 青年班, 兒童班)
- ✅ **出席記錄** - 存放點名記錄

### **測試過的學員資料**
```json
[
  {
    "id": 1752676331811,
    "name": "林嘉健",
    "nickname": "嘉健", 
    "class": "青年班",
    "phone": 12345678,
    "email": "abc@gamil.com",
    "status": "在讀"
  },
  {
    "id": 1752676371530,
    "name": "梁子俊",
    "nickname": "卡樂B",
    "class": "青年班", 
    "phone": "is there anyway we get our78",
    "email": "hvjdsk@gmail.com",
    "status": "在讀"
  }
]
```

### **測試過的班別資料**
```json
[
  {
    "date": "Sat",
    "class_id": "青年班",
    "special_time": 1500,
    "remarks": ""
  },
  {
    "date": "Sat", 
    "class_id": "兒童班",
    "special_time": 1730,
    "remarks": ""
  }
]
```

## 🚨 **已解決的關鍵問題**

### **問題 1: "Unexpected token 'T', 'The page c'... is not valid JSON"**
- **原因**: Vercel 部署失敗，無法連接到 Google Apps Script
- **解決**: 改為前端直接連接 Google Apps Script，繞過 Vercel

### **問題 2: "Failed to fetch"**
- **原因**: 從 file:// 協議發送 HTTPS 請求被瀏覽器阻擋
- **解決**: 使用本地 HTTP 伺服器 `python3 -m http.server 8080`

### **問題 3: "className.trim is not a function"**
- **原因**: Google Apps Script 返回對象格式 `{class_id: "青年班"}`，前端期望字符串格式
- **解決**: 更新 `updateClassOptions` 函數，支援對象格式提取

### **問題 4: Google Apps Script 302 重定向**
- **原因**: Google Apps Script 安全機制，返回 302 重定向
- **解決**: 在所有 fetch 請求中添加 `redirect: 'follow'`

## 💻 **正確的代碼實現**

### **Google Apps Script 必須使用的代碼**
```javascript
const SPREADSHEET_ID = '1paCFt-QxJ3HjTrA4lOnZFQjuw2I7jh8KkTPiNSbfcoo';

const SHEETS = {
  STUDENTS: '學員資料',
  SCHEDULE: 'schedule', 
  ATTENDANCE: '出席記錄'
};

function doGet(e) {
  const action = e.parameter.action;
  switch (action) {
    case 'getStudents': return getStudents();
    case 'getClasses': return getClasses(); 
    case 'getSchedule': return getSchedule();
    default: return createResponse({success: false, error: 'Invalid action'});
  }
}

function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  const action = data.action;
  switch (action) {
    case 'syncStudents': return syncStudents(data.students);
    case 'syncAttendance': return syncAttendanceFixed(data.attendance);
    default: return createResponse({success: false, error: 'Invalid action'});
  }
}
```

### **前端必須的 API 調用格式**
```javascript
// 載入班別
const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getClasses`, {
  method: 'GET',
  redirect: 'follow'
});

// 同步學員  
const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ 
    action: 'syncStudents',
    students: students 
  }),
  redirect: 'follow'
});

// 同步點名
const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
  method: 'POST', 
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    action: 'syncAttendance',
    attendance: attendanceData
  }),
  redirect: 'follow'
});
```

### **前端處理班別資料的正確方法**
```javascript
function updateClassOptions(classData) {
  // 處理 Google Apps Script 返回的對象格式
  let classNames = classData.map(item => {
    if (typeof item === 'object' && item !== null) {
      return item.class_id || item['名稱'] || item.name || item.className || '';
    }
    return item || '';
  });
  
  // 更新下拉選單...
}
```

## 🔧 **部署和測試流程**

### **1. Google Apps Script 部署檢查**
```
1. 前往 https://script.google.com
2. 確認代碼完整 (使用 google-apps-script-完整修復版.js)
3. 替換 SPREADSHEET_ID
4. 部署為網頁應用程式 (執行身分: 我, 存取權限: 任何人)
5. 複製 Web App URL (必須以 /exec 結尾)
6. 測試 URL: 直接訪問應返回 JSON 而非 HTML
```

### **2. 前端測試流程**
```
1. 啟動本地伺服器: python3 -m http.server 8080
2. 打開 http://localhost:8080 (不要用 file://)
3. 測試載入班別: 應顯示青年班和兒童班
4. 測試同步學員: 添加學員後同步到雲端
5. 測試點名功能: 進行點名並保存記錄
```

### **3. 測試工具**
- **快速測試工具**: `快速測試工具.html` - 直接測試 Google Apps Script
- **診斷工具**: `診斷工具.html` - 全面診斷系統問題

## ⚠️ **絕對不能忘記的要點**

### **Google Apps Script**
1. ✅ 必須使用完整修復版代碼
2. ✅ SPREADSHEET_ID 必須正確設定
3. ✅ 必須重新部署為網頁應用程式
4. ✅ URL 必須以 `/exec` 結尾
5. ✅ 必須完成權限授權

### **前端系統**
1. ✅ 必須使用 HTTP 伺服器 (不能用 file://)
2. ✅ 所有 API 調用必須包含 `redirect: 'follow'`
3. ✅ 必須正確處理 Google Apps Script 返回的對象格式
4. ✅ 必須包含正確的 action 參數

### **錯誤處理**
1. ✅ "Failed to fetch" → 使用 HTTP 伺服器
2. ✅ "trim is not a function" → 檢查資料格式處理  
3. ✅ "Invalid action" → 檢查 Google Apps Script 代碼
4. ✅ JSON 解析錯誤 → 檢查 Google Apps Script 部署

## 📋 **快速恢復清單**

如果系統又壞了，按這個順序檢查：

1. **[ ] Google Apps Script URL 是否正確**
2. **[ ] 是否使用 HTTP 伺服器而非 file://**  
3. **[ ] Google Apps Script 是否正確部署**
4. **[ ] 前端是否包含所有必要的修復代碼**
5. **[ ] 使用測試工具驗證各個組件**

## 🎯 **成功指標**

系統正常時應該看到：
- ✅ 載入班別: "成功載入 2 個班別"
- ✅ 同步學員: "成功同步 X 筆學員資料" 
- ✅ 點名功能: "成功同步 X 筆出席記錄"
- ✅ 下拉選單包含: 青年班, 兒童班

---

**最後更新**: 2025-01-16  
**狀態**: ✅ 所有功能正常工作  
**重要**: 此文件包含恢復系統所需的所有關鍵信息！ 