<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>學員管理系統 - 管理員版</title>
    <style>
        body { font-family: system-ui; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 30px; text-align: center; }
        .admin-badge { background: #dc3545; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; margin-left: 10px; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #dee2e6; flex-wrap: wrap; }
        .tab { padding: 15px 20px; border: none; background: none; cursor: pointer; font-size: 14px; color: #6c757d; }
        .tab.active { background: white; color: #495057; border-bottom: 3px solid #667eea; }
        .content { padding: 30px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin: 5px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-secondary { background: #6c757d; color: white; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 32px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        .chart-container { background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .notification { position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px; border-radius: 5px; z-index: 1001; display: none; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .tag { padding: 3px 8px; border-radius: 3px; font-size: 12px; color: white; margin-right: 5px; }
        .tag-youth { background: #007bff; }
        .tag-children { background: #28a745; }
        .tag-family { background: #6f42c1; }
        .tag-default { background: #6c757d; }
        .config-section { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 20px; margin-bottom: 20px; }
        .search-box input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 20px; }
        .empty-state { text-align: center; padding: 40px; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎓 學員管理系統</h1>
            <p>Student Management System</p>
            <span class="admin-badge">管理員版</span>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="dashboard">📊 儀表板</button>
            <button class="tab" data-tab="students">👥 學員管理</button>
            <button class="tab" data-tab="classes">📚 班組管理</button>
            <button class="tab" data-tab="attendance">✅ 點名系統</button>
            <button class="tab" data-tab="analytics">📈 數據分析</button>
            <button class="tab" data-tab="config">⚙️ 系統設定</button>
        </div>

        <div class="content">
            <!-- 儀表板 -->
            <div id="dashboard-tab" class="tab-content">
                <h2>📊 系統概覽</h2>
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-students">0</div>
                        <div class="stat-label">總學員數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="active-students">0</div>
                        <div class="stat-label">活躍學員</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-classes">0</div>
                        <div class="stat-label">班組數量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="attendance-rate">0%</div>
                        <div class="stat-label">本月出席率</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>📈 最近活動</h3>
                    <div id="recent-activities"></div>
                </div>
            </div>

            <!-- 學員管理 -->
            <div id="students-tab" class="tab-content" style="display: none;">
                <div class="page-header">
                    <h2>學員管理</h2>
                    <button class="btn btn-primary" id="add-student">➕ 新增學員</button>
                </div>
                <div class="search-box">
                    <input type="text" id="student-search" placeholder="搜尋學員...">
                </div>
                <div id="students-grid" class="grid"></div>
            </div>

            <!-- 班組管理 -->
            <div id="classes-tab" class="tab-content" style="display: none;">
                <div class="page-header">
                    <h2>班組管理</h2>
                    <button class="btn btn-primary" id="add-class">➕ 新增班組</button>
                </div>
                <div id="classes-grid" class="grid"></div>
            </div>

            <!-- 點名系統 -->
            <div id="attendance-tab" class="tab-content" style="display: none;">
                <div class="page-header">
                    <h2>點名系統</h2>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>選擇班別</label>
                        <select id="attendance-class">
                            <option value="">請選擇班別</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>選擇日期</label>
                        <input type="date" id="attendance-date">
                    </div>
                </div>
                <div id="attendance-list"></div>
            </div>

            <!-- 數據分析 -->
            <div id="analytics-tab" class="tab-content" style="display: none;">
                <h2>📈 數據分析</h2>
                
                <div class="chart-container">
                    <h3>📊 班組學員分佈</h3>
                    <div id="class-distribution"></div>
                </div>
                
                <div class="chart-container">
                    <h3>📅 出席率趨勢</h3>
                    <div id="attendance-trend"></div>
                </div>
                
                <div class="chart-container">
                    <h3>👥 學員增長趨勢</h3>
                    <div id="student-growth"></div>
                </div>
            </div>

            <!-- 系統設定 -->
            <div id="config-tab" class="tab-content" style="display: none;">
                <h2>⚙️ 系統設定</h2>
                
                <div class="config-section">
                    <h3>🔑 Google Sheets API 設定</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>API Key</label>
                            <input type="password" id="admin-api-key" placeholder="輸入 Google API Key">
                        </div>
                        <div class="form-group">
                            <label>Sheet ID</label>
                            <input type="text" id="admin-sheet-id" placeholder="輸入 Google Sheet ID">
                        </div>
                    </div>
                    <button class="btn btn-primary" id="save-config">💾 保存設定</button>
                    <button class="btn btn-success" id="test-connection">🔗 測試連接</button>
                </div>
                
                <div class="config-section">
                    <h3>📤 數據管理</h3>
                    <button class="btn btn-primary" id="export-all-data">📤 導出所有數據</button>
                    <button class="btn btn-warning" id="import-data">📥 導入數據</button>
                    <button class="btn btn-danger" id="reset-system">🔄 重置系統</button>
                </div>
                
                <div class="config-section">
                    <h3>👩‍🏫 導師版本連結</h3>
                    <p>分享給導師使用的簡化版本：</p>
                    <input type="text" id="teacher-link" readonly style="width: 100%; padding: 10px; background: #f8f9fa;">
                    <button class="btn btn-secondary" id="copy-teacher-link">📋 複製連結</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模態框省略，與之前版本相同 -->
    <div id="notification" class="notification"></div>

    <script>
        // 全局變數
        let students = [];
        let classes = [];
        let attendance = {};
        let currentTab = 'dashboard';
        let apiKey = '';
        let spreadsheetId = '';

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            bindEvents();
            updateSelects();
            setToday();
            render();
            updateDashboard();
            generateTeacherLink();
        });

        // 載入數據
        function loadData() {
            try {
                const savedStudents = localStorage.getItem('admin_students_v1');
                if (savedStudents) students = JSON.parse(savedStudents);

                const savedClasses = localStorage.getItem('admin_classes_v1');
                if (savedClasses) {
                    classes = JSON.parse(savedClasses);
                } else {
                    classes = [
                        { id: 'youth', name: '青年班', startTime: '16:00', endTime: '17:30', dayOfWeek: 6, description: '16-25歲青年興趣班' },
                        { id: 'children', name: '兒童班', startTime: '17:30', endTime: '19:00', dayOfWeek: 6, description: '6-15歲兒童興趣班' },
                        { id: 'family', name: '家規班', startTime: '10:00', endTime: '11:30', dayOfWeek: 6, description: '家庭規範教育班' }
                    ];
                    saveClasses();
                }

                const savedAttendance = localStorage.getItem('admin_attendance_v1');
                if (savedAttendance) attendance = JSON.parse(savedAttendance);

                // 載入 API 設定
                apiKey = localStorage.getItem('admin_api_key') || '';
                spreadsheetId = localStorage.getItem('admin_sheet_id') || '';
                
                if (apiKey) document.getElementById('admin-api-key').value = apiKey;
                if (spreadsheetId) document.getElementById('admin-sheet-id').value = spreadsheetId;
            } catch (e) {
                console.error('載入數據失敗:', e);
            }
        }

        // 綁定事件
        function bindEvents() {
            // 選項卡
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // 系統設定
            document.getElementById('save-config').addEventListener('click', saveConfig);
            document.getElementById('test-connection').addEventListener('click', testConnection);
            document.getElementById('copy-teacher-link').addEventListener('click', copyTeacherLink);

            // 其他事件綁定...
        }

        // 切換選項卡
        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            if (tabName === 'dashboard') updateDashboard();
            else if (tabName === 'analytics') updateAnalytics();
            else render();
        }

        // 更新儀表板
        function updateDashboard() {
            const totalStudents = students.length;
            const activeStudents = students.filter(s => s.status !== 'inactive').length;
            const totalClasses = classes.length;
            
            // 計算本月出席率
            const thisMonth = new Date().toISOString().slice(0, 7);
            let totalAttendance = 0;
            let presentCount = 0;
            
            Object.keys(attendance).forEach(key => {
                if (key.includes(thisMonth)) {
                    const dayAttendance = attendance[key];
                    Object.values(dayAttendance).forEach(status => {
                        totalAttendance++;
                        if (status === 'present') presentCount++;
                    });
                }
            });
            
            const attendanceRate = totalAttendance > 0 ? Math.round((presentCount / totalAttendance) * 100) : 0;

            document.getElementById('total-students').textContent = totalStudents;
            document.getElementById('active-students').textContent = activeStudents;
            document.getElementById('total-classes').textContent = totalClasses;
            document.getElementById('attendance-rate').textContent = attendanceRate + '%';

            // 更新最近活動
            updateRecentActivities();
        }

        // 更新最近活動
        function updateRecentActivities() {
            const activities = [];
            
            // 最近新增的學員
            const recentStudents = students
                .filter(s => s.createdAt)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 5);
            
            recentStudents.forEach(student => {
                activities.push({
                    type: 'student',
                    message: `新增學員：${student.name}`,
                    time: new Date(student.createdAt).toLocaleDateString()
                });
            });

            const activitiesHtml = activities.length > 0 
                ? activities.map(activity => `
                    <div style="padding: 10px; border-bottom: 1px solid #eee;">
                        <span style="color: #007bff;">📝</span> ${activity.message}
                        <span style="float: right; color: #6c757d; font-size: 12px;">${activity.time}</span>
                    </div>
                `).join('')
                : '<p style="text-align: center; color: #6c757d; padding: 20px;">暫無最近活動</p>';

            document.getElementById('recent-activities').innerHTML = activitiesHtml;
        }

        // 保存設定
        function saveConfig() {
            const newApiKey = document.getElementById('admin-api-key').value.trim();
            const newSheetId = document.getElementById('admin-sheet-id').value.trim();

            if (!newApiKey || !newSheetId) {
                showNotification('請填入完整的 API Key 和 Sheet ID！');
                return;
            }

            apiKey = newApiKey;
            spreadsheetId = newSheetId;

            localStorage.setItem('admin_api_key', apiKey);
            localStorage.setItem('admin_sheet_id', spreadsheetId);

            showNotification('✅ 設定已保存！');
            generateTeacherLink();
        }

        // 測試連接
        async function testConnection() {
            if (!apiKey || !spreadsheetId) {
                showNotification('請先保存 API 設定！');
                return;
            }

            try {
                const testUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?key=${apiKey}`;
                const response = await fetch(testUrl);
                
                if (response.ok) {
                    showNotification('✅ 連接測試成功！');
                } else {
                    throw new Error('連接失敗');
                }
            } catch (error) {
                console.error('測試連接失敗:', error);
                showNotification('❌ 連接測試失敗，請檢查設定');
            }
        }

        // 生成導師版本連結
        function generateTeacherLink() {
            const currentUrl = window.location.href;
            const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
            const teacherUrl = `${baseUrl}/導師版本.html?api=${encodeURIComponent(apiKey)}&sheet=${encodeURIComponent(spreadsheetId)}`;
            
            document.getElementById('teacher-link').value = teacherUrl;
        }

        // 複製導師連結
        function copyTeacherLink() {
            const linkInput = document.getElementById('teacher-link');
            linkInput.select();
            document.execCommand('copy');
            showNotification('📋 導師版本連結已複製！');
        }

        // 更新數據分析
        function updateAnalytics() {
            updateClassDistribution();
            updateAttendanceTrend();
            updateStudentGrowth();
        }

        // 班組分佈分析
        function updateClassDistribution() {
            const distribution = {};
            classes.forEach(cls => {
                const count = students.filter(s => s.className === cls.name && s.status !== 'inactive').length;
                distribution[cls.name] = count;
            });

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
            Object.keys(distribution).forEach(className => {
                const count = distribution[className];
                const percentage = students.length > 0 ? Math.round((count / students.length) * 100) : 0;
                
                html += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                        <h4 style="margin: 0 0 10px 0;">${className}</h4>
                        <div style="font-size: 24px; font-weight: bold; color: #007bff;">${count}</div>
                        <div style="font-size: 14px; color: #6c757d;">${percentage}%</div>
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('class-distribution').innerHTML = html;
        }

        // 出席率趨勢
        function updateAttendanceTrend() {
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push(date.toISOString().split('T')[0]);
            }

            let html = '<div style="display: flex; align-items: end; height: 200px; gap: 10px;">';
            last7Days.forEach(date => {
                const dayAttendance = attendance[`${classes[0]?.name}_${date}`] || {};
                const total = Object.keys(dayAttendance).length;
                const present = Object.values(dayAttendance).filter(status => status === 'present').length;
                const rate = total > 0 ? Math.round((present / total) * 100) : 0;
                const height = Math.max(rate * 1.5, 10);

                html += `
                    <div style="flex: 1; text-align: center;">
                        <div style="background: #007bff; height: ${height}px; margin-bottom: 5px; border-radius: 3px;"></div>
                        <div style="font-size: 12px; color: #6c757d;">${date.slice(-2)}</div>
                        <div style="font-size: 10px; color: #6c757d;">${rate}%</div>
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('attendance-trend').innerHTML = html;
        }

        // 學員增長趨勢
        function updateStudentGrowth() {
            const monthlyGrowth = {};
            students.forEach(student => {
                if (student.createdAt) {
                    const month = student.createdAt.slice(0, 7);
                    monthlyGrowth[month] = (monthlyGrowth[month] || 0) + 1;
                }
            });

            const months = Object.keys(monthlyGrowth).sort().slice(-6);
            let html = '<div style="display: flex; align-items: end; height: 200px; gap: 15px;">';
            
            months.forEach(month => {
                const count = monthlyGrowth[month];
                const height = Math.max(count * 20, 10);
                
                html += `
                    <div style="flex: 1; text-align: center;">
                        <div style="background: #28a745; height: ${height}px; margin-bottom: 5px; border-radius: 3px;"></div>
                        <div style="font-size: 12px; color: #6c757d;">${month}</div>
                        <div style="font-size: 10px; color: #6c757d;">${count}人</div>
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('student-growth').innerHTML = html;
        }

        // 其他函數省略，與之前版本相同...
        function render() {
            // 渲染邏輯
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function updateSelects() {
            // 更新選擇框
        }

        function setToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-date').value = today;
        }

        function saveStudents() {
            localStorage.setItem('admin_students_v1', JSON.stringify(students));
        }

        function saveClasses() {
            localStorage.setItem('admin_classes_v1', JSON.stringify(classes));
        }

        function saveAttendance() {
            localStorage.setItem('admin_attendance_v1', JSON.stringify(attendance));
        }
    </script>
</body>
</html> 