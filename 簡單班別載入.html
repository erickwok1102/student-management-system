<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡å–®ç­åˆ¥è¼‰å…¥æ¸¬è©¦</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 600px; 
            margin: 50px auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .card { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #0056b3; }
        select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            font-size: 16px;
            margin: 10px 0;
        }
        #log { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            white-space: pre-wrap; 
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ¯ ç°¡å–®ç­åˆ¥è¼‰å…¥æ¸¬è©¦</h1>
        <p>ç›®æ¨™ï¼šå¾ Google Sheets è¼‰å…¥èª²å ‚è³‡æ–™åˆ°ä¸‹æ‹‰é¸å–®</p>
        
        <button onclick="loadClassesSimple()">ğŸ“¥ è¼‰å…¥ç­åˆ¥ (æ–¹æ³•1: å¾å­¸å“¡è³‡æ–™)</button>
        <button onclick="loadClassesFromSchedule()">ğŸ“… è¼‰å…¥ç­åˆ¥ (æ–¹æ³•2: å¾èª²ç¨‹è¡¨)</button>
        <button onclick="clearLog()">ğŸ§¹ æ¸…é™¤æ—¥èªŒ</button>
        
        <h3>ç­åˆ¥é¸æ“‡:</h3>
        <select id="classSelect">
            <option value="">è«‹é¸æ“‡ç­åˆ¥</option>
        </select>
        
        <h3>åŸ·è¡Œæ—¥èªŒ:</h3>
        <div id="log"></div>
    </div>

    <script>
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw_m3SjHokYxU-eUkFrMtcrVXnoxSGhRAfuUxYDt6P81UwmxcMrkKjz-h7A4teL8kKIjQ/exec';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function updateClassSelect(classes) {
            const select = document.getElementById('classSelect');
            select.innerHTML = '<option value="">è«‹é¸æ“‡ç­åˆ¥</option>';
            
            if (Array.isArray(classes) && classes.length > 0) {
                classes.forEach(className => {
                    if (className) {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        select.appendChild(option);
                    }
                });
                log(`âœ… æˆåŠŸæ·»åŠ  ${classes.length} å€‹ç­åˆ¥åˆ°é¸å–®`, 'success');
            } else {
                log('âš ï¸ æ²’æœ‰ç­åˆ¥è³‡æ–™å¯ä»¥æ·»åŠ ', 'error');
            }
        }
        
        // æ–¹æ³•1: å¾å­¸å“¡è³‡æ–™æå–ç­åˆ¥
        async function loadClassesSimple() {
            try {
                log('ğŸ”„ é–‹å§‹å¾å­¸å“¡è³‡æ–™è¼‰å…¥ç­åˆ¥...', 'info');
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL + '?action=getStudents', {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                log(`ğŸ“¡ API å›æ‡‰ç‹€æ…‹: ${response.status}`, 'info');
                
                const result = await response.json();
                log(`ğŸ“‹ API å›æ‡‰: ${JSON.stringify(result, null, 2)}`, 'info');
                
                if (result.success && result.students) {
                    log(`ğŸ‘¥ æ‰¾åˆ° ${result.students.length} ä½å­¸å“¡`, 'info');
                    
                    // æå–ç­åˆ¥
                    const classSet = new Set();
                    result.students.forEach((student, index) => {
                        log(`æª¢æŸ¥å­¸å“¡ ${index + 1}: ${JSON.stringify(student)}`, 'info');
                        
                        // æª¢æŸ¥å„ç¨®å¯èƒ½çš„ç­åˆ¥æ¬„ä½
                        const possibleFields = ['class', 'ç­åˆ¥', 'class_id', 'className', 'ç­çµ„'];
                        let foundClass = null;
                        
                        possibleFields.forEach(field => {
                            if (student[field] && typeof student[field] === 'string') {
                                foundClass = student[field].trim();
                                log(`âœ… åœ¨æ¬„ä½ "${field}" æ‰¾åˆ°ç­åˆ¥: "${foundClass}"`, 'success');
                            }
                        });
                        
                        if (foundClass) {
                            classSet.add(foundClass);
                        }
                    });
                    
                    const uniqueClasses = Array.from(classSet);
                    log(`ğŸ¯ æå–åˆ°çš„å”¯ä¸€ç­åˆ¥: ${JSON.stringify(uniqueClasses)}`, 'success');
                    
                    updateClassSelect(uniqueClasses);
                    
                } else {
                    log(`âŒ è¼‰å…¥å¤±æ•—: ${result.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        // æ–¹æ³•2: ç›´æ¥å¾èª²ç¨‹è¡¨è¼‰å…¥
        async function loadClassesFromSchedule() {
            try {
                log('ğŸ”„ é–‹å§‹å¾èª²ç¨‹è¡¨è¼‰å…¥ç­åˆ¥...', 'info');
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL + '?action=getSchedule', {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                log(`ğŸ“¡ API å›æ‡‰ç‹€æ…‹: ${response.status}`, 'info');
                
                const result = await response.json();
                log(`ğŸ“… èª²ç¨‹è¡¨å›æ‡‰: ${JSON.stringify(result, null, 2)}`, 'info');
                
                if (result.success && result.schedule) {
                    log(`ğŸ“… æ‰¾åˆ° ${result.schedule.length} ç­†èª²ç¨‹è³‡æ–™`, 'info');
                    
                    // æå–ç­åˆ¥
                    const classSet = new Set();
                    result.schedule.forEach((scheduleItem, index) => {
                        log(`æª¢æŸ¥èª²ç¨‹ ${index + 1}: ${JSON.stringify(scheduleItem)}`, 'info');
                        
                        // æª¢æŸ¥å„ç¨®å¯èƒ½çš„ç­åˆ¥æ¬„ä½
                        const possibleFields = ['class_id', 'class_name', 'ç­åˆ¥', 'name', 'className'];
                        let foundClass = null;
                        
                        possibleFields.forEach(field => {
                            if (scheduleItem[field] && typeof scheduleItem[field] === 'string') {
                                foundClass = scheduleItem[field].trim();
                                log(`âœ… åœ¨æ¬„ä½ "${field}" æ‰¾åˆ°ç­åˆ¥: "${foundClass}"`, 'success');
                            }
                        });
                        
                        if (foundClass) {
                            classSet.add(foundClass);
                        }
                    });
                    
                    const uniqueClasses = Array.from(classSet);
                    log(`ğŸ¯ æå–åˆ°çš„å”¯ä¸€ç­åˆ¥: ${JSON.stringify(uniqueClasses)}`, 'success');
                    
                    updateClassSelect(uniqueClasses);
                    
                } else {
                    log(`âŒ è¼‰å…¥å¤±æ•—: ${result.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºè³‡è¨Š
        window.onload = function() {
            log('ğŸ¯ ç°¡å–®ç­åˆ¥è¼‰å…¥æ¸¬è©¦å·¥å…·å·²æº–å‚™å°±ç·’', 'info');
            log(`ğŸ“ Google Apps Script URL: ${GOOGLE_APPS_SCRIPT_URL}`, 'info');
            log('ğŸ’¡ è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ¸¬è©¦ä¸åŒçš„è¼‰å…¥æ–¹æ³•', 'info');
        };
    </script>
</body>
</html> 