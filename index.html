<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
    <title>å­¸å“¡ç®¡ç†ç³»çµ± - ä¿®å¾©ç‰ˆ v2.3</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            color: #333; 
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; padding: 40px; border-radius: 20px; margin-bottom: 30px; 
            text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        .card { 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
            padding: 30px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.2);
        }
        .btn { 
            padding: 14px 28px; border: none; border-radius: 12px; cursor: pointer; 
            font-size: 16px; margin: 8px; transition: all 0.3s ease; font-weight: 600;
        }
        .btn-primary { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
        .btn-success { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ffc107, #e0a800); color: #212529; }
        .btn-danger { background: linear-gradient(135deg, #dc3545, #c82333); color: white; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        
        .form-group { margin-bottom: 25px; }
        .form-group label { 
            display: block; margin-bottom: 8px; font-weight: 600; 
            color: #555; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 15px 20px; border: 2px solid #e1e5e9; 
            border-radius: 12px; font-size: 16px; transition: all 0.3s ease;
            background: rgba(255,255,255,0.8);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: #007bff; 
            box-shadow: 0 0 0 4px rgba(0,123,255,0.1);
            background: white;
        }
        
        .student-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 25px; border-radius: 15px; margin-bottom: 15px; 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
            transition: all 0.3s ease; border-left: 5px solid #007bff;
        }
        .student-item:hover { 
            background: linear-gradient(135deg, #e9ecef, #dee2e6); 
            transform: translateX(10px); box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .notification { 
            position: fixed; top: 30px; right: 30px; padding: 20px 30px; 
            border-radius: 15px; color: white; font-weight: 600; z-index: 1000; 
            opacity: 0; transition: all 0.4s ease; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .notification.success { background: linear-gradient(135deg, #28a745, #20c997); }
        .notification.error { background: linear-gradient(135deg, #dc3545, #e74c3c); }
        .notification.warning { background: linear-gradient(135deg, #ffc107, #f39c12); color: #333; }
        .notification.show { opacity: 1; transform: translateY(0); }
        
        .status-indicator { 
            display: inline-block; width: 14px; height: 14px; border-radius: 50%; 
            margin-left: 10px; animation: pulse 2s infinite;
        }
        .status-online { background: #28a745; box-shadow: 0 0 15px rgba(40,167,69,0.6); }
        .status-offline { background: #dc3545; box-shadow: 0 0 15px rgba(220,53,69,0.6); }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .tabs { 
            display: flex; border-bottom: 3px solid #e9ecef; margin-bottom: 30px; 
            background: rgba(255,255,255,0.9); border-radius: 15px 15px 0 0; 
            overflow: hidden; backdrop-filter: blur(10px);
        }
        .tab { 
            padding: 20px 35px; cursor: pointer; border: none; background: none; 
            font-size: 16px; font-weight: 600; transition: all 0.3s ease; 
            position: relative; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .tab.active { 
            background: linear-gradient(135deg, #007bff, #0056b3); 
            color: white; 
        }
        .tab:not(.active):hover { background: rgba(0,123,255,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .grid-form { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 25px; 
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 25px; 
        }
        .stat-card { 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
            padding: 30px; border-radius: 20px; text-align: center; 
            border-left: 6px solid #007bff; transition: all 0.3s ease;
        }
        .stat-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .sync-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 30px; 
        }
        .sync-card { 
            text-align: center; padding: 40px; border-radius: 20px; 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
            transition: all 0.3s ease;
        }
        .sync-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
        }
        
        .empty-state { 
            text-align: center; padding: 80px 20px; color: #999; 
        }
        .empty-state h3 { 
            margin-bottom: 15px; color: #666; font-size: 24px; 
        }
        .empty-state p { font-size: 16px; line-height: 1.6; }
        
        /* é»åæŒ‰éˆ•æ¨£å¼ */
        .attendance-btn, .attendance-choice-btn {
            transition: all 0.3s ease !important;
            border: 2px solid transparent !important;
            font-weight: 600 !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            cursor: pointer !important;
        }
        
        .attendance-btn:hover, .attendance-choice-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
        }
        
        .attendance-btn:active, .attendance-choice-btn:active {
            transform: translateY(0) !important;
        }
        
        .attendance-btn.selected, .attendance-choice-btn.selected {
            border: 3px solid #fff !important;
            box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.25), 0 4px 12px rgba(0,0,0,0.3) !important;
            transform: scale(0.95) !important;
        }
        
        .attendance-btn .check-mark, .attendance-choice-btn .check-mark {
            animation: checkMarkAppear 0.3s ease !important;
        }
        
        @keyframes checkMarkAppear {
            0% { 
                transform: scale(0) rotate(180deg); 
                opacity: 0; 
            }
            50% { 
                transform: scale(1.2) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }
        
        .btn-success.selected {
            background-color: #198754 !important;
            border-color: #146c43 !important;
        }
        
        .btn-warning.selected {
            background-color: #fd7e14 !important;
            border-color: #fd7e14 !important;
        }
        
        .btn-primary.selected {
            background-color: #0d6efd !important;
            border-color: #0a58ca !important;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header { padding: 30px 20px; }
            .header h1 { font-size: 2rem; }
            .grid-form { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; }
            .sync-grid { grid-template-columns: 1fr; }
            
            /* é¸å–®ä¸€è¡Œé¡¯ç¤º */
            .tabs { 
                flex-wrap: nowrap; 
                overflow-x: auto; 
                -webkit-overflow-scrolling: touch;
            }
            .tab { 
                padding: 12px 15px; 
                font-size: 14px;
                white-space: nowrap;
                min-width: auto;
                flex: 1;
            }
            
            /* é»åæŒ‰éˆ•å„ªåŒ– */
            .attendance-btn, .attendance-choice-btn { 
                padding: 8px 12px !important; 
                font-size: 14px !important;
                margin: 2px !important;
            }
            
            /* å­¸å“¡é …ç›®æ©«å‘ä½ˆå±€ */
            .student-attendance-item {
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                padding: 15px !important;
                margin-bottom: 10px !important;
                border-radius: 10px !important;
                background: #f8f9fa !important;
                border-left: 4px solid #007bff !important;
            }
            
            .student-info {
                flex: 1 !important;
                margin-right: 10px !important;
            }
            
            .student-name {
                font-size: 16px !important;
                font-weight: 600 !important;
                margin-bottom: 4px !important;
                color: #333 !important;
            }
            
            .student-class {
                font-size: 12px !important;
                color: #666 !important;
            }
            
            .attendance-buttons {
                display: flex !important;
                gap: 4px !important;
                flex-wrap: nowrap !important;
            }
            
            .attendance-choice-btn {
                min-width: 50px !important;
                padding: 8px 6px !important;
                font-size: 11px !important;
                border-radius: 6px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ å­¸å“¡ç®¡ç†ç³»çµ±</h1>
            <div style="margin-top: 20px;">
                <span style="font-size: 16px;">ç³»çµ±ç‹€æ…‹:</span>
                <span class="status-indicator status-online" id="serverStatus"></span>
                <span id="statusText" style="font-weight: 600;">æ­£å¸¸é‹è¡Œ</span>
            </div>
        </div>

        <!-- æ¨™ç±¤é å°èˆª -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('attendance', this)">âœ… é»åç³»çµ±</button>
            <button class="tab" onclick="showTab('students', this)">ğŸ‘¥ æ–°å¢å­¸å“¡</button>
            <button class="tab" onclick="showTab('sync', this)">â˜ï¸ é›²ç«¯åŒæ­¥</button>
        </div>

        <!-- é»åç³»çµ±æ¨™ç±¤ -->
        <div id="attendanceTab" class="tab-content active">
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #333; font-size: 24px;">âœ… é»åç³»çµ±</h3>
                
                <div class="grid-form">
                    <div class="form-group">
                        <label>æ—¥æœŸ *</label>
                        <input type="date" id="attendanceDate" required>
                    </div>
                    <div class="form-group">
                        <label>ç­åˆ¥ *</label>
                        <select id="attendanceClass" required onchange="loadStudentsForAttendance()">
                            <option value="">è«‹é¸æ“‡ç­åˆ¥</option>
                            <!-- ç­åˆ¥é¸é …å°‡å¾å­¸å“¡è³‡æ–™ä¸­å‹•æ…‹è¼‰å…¥ -->
                        </select>
                    </div>
                </div>

                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-primary" onclick="startAttendance()">ğŸš€ é–‹å§‹é»å</button>
                </div>
            </div>

            <!-- é»ååˆ—è¡¨ -->
            <div class="card" id="attendanceListCard" style="display: none;">
                <h3 style="margin-bottom: 25px; color: #333; font-size: 24px;">ğŸ“‹ é»ååˆ—è¡¨</h3>
                <div id="attendanceStudentsList"></div>
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-success" onclick="saveAndUploadAttendance()">ğŸ’¾ å„²å­˜ä¸¦è‡ªå‹•ä¸Šå‚³é»åè¨˜éŒ„</button>
                    <button class="btn btn-warning" onclick="resetAttendance()">ğŸ”„ é‡æ–°é»å</button>
                </div>
            </div>

            <!-- ä»Šæ—¥é»åè¨˜éŒ„ -->
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #333; font-size: 24px;">ğŸ“… ä»Šæ—¥é»åè¨˜éŒ„</h3>
                <div class="student-list" id="todayAttendanceList">
                    <div class="empty-state">
                        <h3>ğŸ“ é‚„æ²’æœ‰ä»Šæ—¥çš„é»åè¨˜éŒ„</h3>
                        <p>é¸æ“‡ç­åˆ¥ä¸¦é–‹å§‹é»å</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- å­¸å“¡ç®¡ç†æ¨™ç±¤ -->
        <div id="studentsTab" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom: 30px; color: #333; font-size: 24px;">â• æ–°å¢å­¸å“¡</h3>
                <div class="grid-form">
                    <div class="form-group">
                        <label>å­¸å“¡å§“å *</label>
                        <input type="text" id="studentName" placeholder="è«‹è¼¸å…¥å­¸å“¡å§“å" required>
                    </div>
                    <div class="form-group">
                        <label>åˆ¥å/è‹±æ–‡å</label>
                        <input type="text" id="studentNickname" placeholder="åˆ¥åæˆ–è‹±æ–‡å (é¸å¡«)">
                    </div>
                    <div class="form-group">
                        <label>ç­åˆ¥ *</label>
                        <select id="studentClass" required>
                            <option value="">è«‹é¸æ“‡ç­åˆ¥</option>
                            <!-- ç­åˆ¥é¸é …æœƒå‹•æ…‹è¼‰å…¥ -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è¯çµ¡é›»è©±</label>
                        <input type="tel" id="studentPhone" placeholder="è¯çµ¡é›»è©±">
                    </div>
                    <div class="form-group">
                        <label>é›»å­ä¿¡ç®±</label>
                        <input type="email" id="studentEmail" placeholder="é›»å­ä¿¡ç®±">
                    </div>
                    <div class="form-group">
                        <label>ç”Ÿæ—¥</label>
                        <input type="date" id="studentBirthday" placeholder="é¸æ“‡ç”Ÿæ—¥æ—¥æœŸ" onchange="handleBirthdayInput()">
                    </div>
                    <div class="form-group">
                        <label>ç·Šæ€¥è¯çµ¡äºº</label>
                        <input type="text" id="emergencyContact" placeholder="ç·Šæ€¥è¯çµ¡äººå§“å">
                    </div>
                    <div class="form-group">
                        <label>ç·Šæ€¥è¯çµ¡é›»è©±</label>
                        <input type="tel" id="emergencyPhone" placeholder="ç·Šæ€¥è¯çµ¡é›»è©±">
                    </div>
                </div>
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <textarea id="studentRemarks" placeholder="å…¶ä»–å‚™è¨»è³‡è¨Š" rows="4"></textarea>
                </div>
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-success" onclick="addStudent()">â• æ–°å¢å­¸å“¡</button>
                    <button class="btn btn-primary" onclick="loadStudents()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                    <button class="btn btn-warning" onclick="clearForm()">ğŸ§¹ æ¸…ç©ºè¡¨å–®</button>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 25px; color: #333; font-size: 24px;">ğŸ“‹ å­¸å“¡åˆ—è¡¨</h3>
                <div class="student-list" id="studentList">
                    <div class="empty-state">
                        <h3>ğŸ”„ è¼‰å…¥ä¸­...</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- é›²ç«¯åŒæ­¥æ¨™ç±¤ -->
        <div id="syncTab" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom: 30px; color: #333; font-size: 24px;">â˜ï¸ Google Sheets åŒæ­¥</h3>
                <div class="sync-grid">
                    <div class="sync-card">
                        <h4 style="color: #28a745; margin-bottom: 20px; font-size: 20px;">ğŸ“¤ ä¸Šå‚³å­¸å“¡è³‡æ–™</h4>
                        <button class="btn btn-success" onclick="syncToCloud()" style="width: 100%; margin-bottom: 20px;">
                            â˜ï¸ åŒæ­¥å­¸å“¡åˆ°é›²ç«¯
                        </button>
                        <p style="font-size: 14px; color: #666; line-height: 1.6;">
                            å°‡æœ¬åœ°å­¸å“¡è³‡æ–™ä¸Šå‚³åˆ° Google Sheets<br>
                            <strong>æ³¨æ„ï¼š</strong>æœƒè¦†è“‹é›²ç«¯ç¾æœ‰è³‡æ–™
                        </p>
                    </div>
                    <div class="sync-card">
                        <h4 style="color: #007bff; margin-bottom: 20px; font-size: 20px;">ğŸ“¥ è¼‰å…¥å­¸å“¡è³‡æ–™</h4>
                        <button class="btn btn-primary" onclick="loadFromCloud()" style="width: 100%; margin-bottom: 20px;">
                            ğŸ“¥ å¾é›²ç«¯è¼‰å…¥å­¸å“¡
                        </button>
                        <p style="font-size: 14px; color: #666; line-height: 1.6;">
                            å¾ Google Sheets è¼‰å…¥å­¸å“¡è³‡æ–™<br>
                            <strong>æ³¨æ„ï¼š</strong>æœƒè¦†è“‹æœ¬åœ°ç¾æœ‰è³‡æ–™
                        </p>
                    </div>
                    <div class="sync-card">
                        <h4 style="color: #ffc107; margin-bottom: 20px; font-size: 20px;">ğŸ“‹ é»åè¨˜éŒ„</h4>
                        <button class="btn btn-warning" onclick="syncAttendanceToCloud()" style="width: 100%; margin-bottom: 10px;">
                            ğŸš€ è‡ªå‹•ä¸Šå‚³åˆ° Google Sheets
                        </button>
                        <button class="btn btn-primary" onclick="showAttendanceRecords()" style="width: 100%; margin-bottom: 20px;">
                            ğŸ‘€ æŸ¥çœ‹æœ¬åœ°è¨˜éŒ„
                        </button>
                        <p style="font-size: 14px; color: #666; line-height: 1.6;">
                            è‡ªå‹•ä¸Šå‚³é»åè¨˜éŒ„åˆ° Google Sheets<br>
                            <strong>è¨˜éŒ„æ•¸ï¼š</strong><span id="attendanceCount">0</span> ç­†<br>
                            <small style="color: #e74c3c;">âš ï¸ ä¸Šå‚³æˆåŠŸå¾Œå°‡æ¸…ç©ºæœ¬åœ°è¨˜éŒ„</small>
                        </p>
                    </div>
                </div>

                <div style="margin-top: 40px; padding: 25px; background: rgba(248,249,250,0.8); border-radius: 15px;">
                    <h4 style="color: #333; margin-bottom: 15px; font-size: 18px;">ğŸ“‹ åŒæ­¥ç‹€æ…‹</h4>
                    <p id="syncStatus" style="color: #666; font-size: 16px;">ç³»çµ±å·²å•Ÿå‹•ï¼Œæº–å‚™å°±ç·’</p>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥å…ƒç´  -->
    <div id="notification" class="notification"></div>

    <script>
        // Google Apps Script URL è¨­å®š
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw_m3SjHokYxU-eUkFrMtcrVXnoxSGhRAfuUxYDt6P81UwmxcMrkKjz-h7A4teL8kKIjQ/exec';
        
        // å­¸å“¡è³‡æ–™é™£åˆ—
        let students = [];
        let todayAttendance = [];
        let currentAttendanceClass = '';
        let currentAttendanceDate = '';

        // å…¨åŸŸè®Šæ•¸ - ç”¨æ–¼è‡¨æ™‚å„²å­˜é»åé¸æ“‡
        let tempAttendanceChoices = {}; // æ ¼å¼: { studentId: status }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ å­¸å“¡ç®¡ç†ç³»çµ±å•Ÿå‹•ä¸­...');
            showNotification('æ­¡è¿ä½¿ç”¨å­¸å“¡ç®¡ç†ç³»çµ±ï¼', 'success');
            
            await loadStudents();
            updateClassOptions(); // å¾å­¸å“¡è³‡æ–™ä¸­æ›´æ–°ç­åˆ¥é¸é …
            await loadFromCloudSilently();
            
            // è‡ªå‹•å¾èª²ç¨‹è¡¨è¼‰å…¥ç­åˆ¥
            try {
                await loadClassesFromSchedule();
            } catch (error) {
                console.log('ğŸ“… è‡ªå‹•è¼‰å…¥èª²ç¨‹è¡¨ç­åˆ¥å¤±æ•—ï¼Œå°‡ä½¿ç”¨å­¸å“¡è³‡æ–™ä¸­çš„ç­åˆ¥');
            }
            
            // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            
            // è¨­ç½®é»åæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            setupAttendanceButtons();
            
            loadTodayAttendance();
        });

        // æ¨™ç±¤é åˆ‡æ›
        function showTab(tabName, element) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (element) {
                element.classList.add('active');
            }
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'attendance') {
                displayTodayAttendance();
            }
        }

        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // ç”Ÿæˆä¸‹ä¸€å€‹å­¸å“¡ID (Yé–‹é ­çš„åºè™Ÿ)
        function generateNextStudentId() {
            // æ‰¾å‡ºæ‰€æœ‰ç¾æœ‰çš„Yé–‹é ­ID
            const existingIds = students
                .map(s => s.id)
                .filter(id => id && id.startsWith('Y'))
                .map(id => {
                    const num = parseInt(id.substring(1));
                    return isNaN(num) ? 0 : num;
                })
                .sort((a, b) => b - a); // é™åºæ’åˆ—
            
            // æ‰¾å‡ºæœ€å¤§çš„åºè™Ÿï¼Œç„¶å¾Œ+1
            const maxId = existingIds.length > 0 ? existingIds[0] : 0;
            const nextId = maxId + 1;
            
            // æ ¼å¼åŒ–ç‚º Y + 4ä½æ•¸å­— (ä¾‹å¦‚: Y0001, Y0002...)
            const paddedId = nextId.toString().padStart(4, '0');
            const newId = `Y${paddedId}`;
            
            console.log(`ğŸ†” ç”Ÿæˆæ–°å­¸å“¡ID: ${newId} (ç•¶å‰æœ€å¤§ID: Y${maxId.toString().padStart(4, '0')})`);
            return newId;
        }

        // æ ¼å¼åŒ–æ—¥æœŸç‚ºå¹´æœˆæ—¥
        function formatDateOnly() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // æ ¼å¼åŒ–ç”Ÿæ—¥æ—¥æœŸé¡¯ç¤º (åªé¡¯ç¤ºæœˆ-æ—¥)
        function formatBirthday(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const day = date.getDate();
            const month = months[date.getMonth()];
            return `${day}-${month}`;
        }

        // æ–°å¢å­¸å“¡ (ç›´æ¥åŒæ­¥åˆ°é›²ç«¯ï¼Œä¸ä½¿ç”¨æœ¬åœ°è¨˜æ†¶)
        async function addStudent() {
            const name = document.getElementById('studentName').value.trim();
            const className = document.getElementById('studentClass').value.trim();
            
            if (!name) {
                showNotification('è«‹è¼¸å…¥å­¸å“¡å§“å', 'error');
                return;
            }
            
            if (!className) {
                showNotification('è«‹é¸æ“‡ç­åˆ¥', 'error');
                return;
            }

            // æ ¼å¼åŒ–ç”Ÿæ—¥ (åªè¦æ—¥-æœˆæ ¼å¼ï¼Œå¦‚ 5-Aug)
            const birthdayInput = document.getElementById('studentBirthday').value;
            const formattedBirthday = birthdayInput ? formatBirthday(birthdayInput) : '';

            // æº–å‚™å­¸å“¡è³‡æ–™ (ä¸ç”Ÿæˆæœ¬åœ°IDï¼Œè®“Google Sheetsæ±ºå®š)
            const studentData = {
                name: name,
                nickname: document.getElementById('studentNickname').value.trim(),
                class: className,
                phone: document.getElementById('studentPhone').value.trim(),
                email: document.getElementById('studentEmail').value.trim(),
                birthday: formattedBirthday,
                emergencyContact: document.getElementById('emergencyContact').value.trim(),
                emergencyPhone: document.getElementById('emergencyPhone').value.trim(),
                status: 'åœ¨è®€', // é è¨­ç‹€æ…‹
                remarks: document.getElementById('studentRemarks').value.trim(),
                createdAt: formatDateOnly()
            };

            showNotification('ğŸ”„ æ­£åœ¨æ–°å¢å­¸å“¡åˆ°é›²ç«¯...', 'info');

            try {
                // ç²å–ç¾æœ‰å­¸å“¡ä¾†ç”Ÿæˆæ–°IDï¼Œç„¶å¾ŒåªåŒæ­¥æ–°å­¸å“¡
                const getResponse = await fetch('/api/get-students');
                let existingStudents = [];
                
                if (getResponse.ok) {
                    const getResult = await getResponse.json();
                    if (getResult.success && getResult.students) {
                        existingStudents = getResult.students;
                    }
                }

                // ç”Ÿæˆæ–°çš„å­¸å“¡ID
                const maxId = existingStudents
                    .map(s => s.id)
                    .filter(id => id && id.startsWith('Y'))
                    .map(id => parseInt(id.substring(1)))
                    .filter(num => !isNaN(num))
                    .sort((a, b) => b - a)[0] || 0;
                
                const newId = `Y${(maxId + 1).toString().padStart(4, '0')}`;
                
                // æ·»åŠ IDåˆ°å­¸å“¡è³‡æ–™
                studentData.id = newId;

                // ä½¿ç”¨ç¾æœ‰çš„sync-students APIï¼Œä½†æ”¹æˆappendæ¨¡å¼
                const response = await fetch('/api/sync-students', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'appendStudent',  // æ–°çš„actionè¡¨ç¤ºè¿½åŠ è€Œä¸æ˜¯è¦†è“‹
                        students: [studentData]   // åªå‚³é€æ–°å­¸å“¡
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`âœ… å­¸å“¡ã€Œ${name}ã€å·²æˆåŠŸæ–°å¢ (ID: ${newId})`, 'success');
                    clearForm();
                    // é‡æ–°è¼‰å…¥å­¸å“¡åˆ—è¡¨
                    await loadStudentsFromCloud();
                } else {
                    throw new Error(result.message || 'æ–°å¢å¤±æ•—');
                }
            } catch (error) {
                console.error('æ–°å¢å­¸å“¡éŒ¯èª¤:', error);
                showNotification('âŒ æ–°å¢å­¸å“¡å¤±æ•—ï¼š' + error.message, 'error');
                
                // å‚™ç”¨ï¼šè¤‡è£½åˆ°å‰ªè²¼ç°¿ (åŒ…å«æ­£ç¢ºçš„æ¬„ä½é †åº)
                const csvData = `${studentData.id}\t${studentData.name}\t${studentData.nickname}\t${studentData.class}\t${studentData.phone}\t${studentData.email}\t${studentData.birthday}\t${studentData.emergencyContact}\t${studentData.emergencyPhone}\t${studentData.status}\t${studentData.remarks}\t${studentData.createdAt}`;
                
                try {
                    await navigator.clipboard.writeText(csvData);
                    showNotification('ğŸ“‹ å·²è¤‡è£½å­¸å“¡è³‡æ–™åˆ°å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è²¼ä¸Šåˆ° Google Sheets æ–°è¡Œ', 'info', 8000);
                } catch (clipError) {
                    console.error('è¤‡è£½åˆ°å‰ªè²¼ç°¿å¤±æ•—:', clipError);
                }
            }
        }

        // æ¸…ç©ºè¡¨å–®
        function clearForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('studentNickname').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentEmail').value = '';
            document.getElementById('studentBirthday').value = '';
            document.getElementById('emergencyContact').value = '';
            document.getElementById('emergencyPhone').value = '';
            document.getElementById('studentRemarks').value = '';
        }

        // è¼‰å…¥å­¸å“¡è³‡æ–™ (å·²æ”¹ç‚ºå¾é›²ç«¯è¼‰å…¥ï¼Œè¦‹ loadStudentsFromCloud å‡½æ•¸)
        // æ­¤å‡½æ•¸å·²åœç”¨ï¼Œè«‹ä½¿ç”¨ loadStudentsFromCloud()
        async function loadStudents() {
            console.log('âš ï¸ loadStudents å·²åœç”¨ï¼Œè«‹ä½¿ç”¨ loadStudentsFromCloud()');
            await loadStudentsFromCloud();
        }

        // é¡¯ç¤ºå­¸å“¡åˆ—è¡¨
        function displayStudents() {
            const list = document.getElementById('studentList');
            
            if (students.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>ğŸ“š é‚„æ²’æœ‰å­¸å“¡è³‡æ–™</h3>
                        <p>é»æ“Šä¸Šæ–¹çš„ã€Œæ–°å¢å­¸å“¡ã€æŒ‰éˆ•é–‹å§‹å»ºç«‹ä½ çš„å­¸å“¡åå†Š<br>
                        æ‰€æœ‰è³‡æ–™æœƒå®‰å…¨åœ°å„²å­˜åœ¨ä½ çš„ç€è¦½å™¨ä¸­</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = students.map(student => `
                <div class="student-item">
                    <div>
                        <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px; color: #333;">
                            ${student.name}
                            ${student.nickname ? `<span style="color: #666; font-weight: 400; font-size: 16px;">(${student.nickname})</span>` : ''}
                            <span style="color: #999; font-weight: 400; font-size: 14px; margin-left: 10px;">ID: ${student.id}</span>
                        </div>
                        <div style="color: #666; font-size: 15px; margin-bottom: 5px;">
                            <span style="margin-right: 20px; background: #e3f2fd; padding: 4px 12px; border-radius: 20px; color: #1976d2;">
                                ğŸ“š ${student.class || 'æœªåˆ†é…ç­åˆ¥'}
                            </span>
                            <span style="color: ${getStatusColor(student.status)}; font-weight: 600;">
                                â— ${student.status}
                            </span>
                        </div>
                        <div style="color: #999; font-size: 13px; line-height: 1.4;">
                            ğŸ“… ${student.createdAt} å»ºç«‹
                            ${student.phone ? ` | ğŸ“ ${student.phone}` : ''}
                            ${student.email ? ` | ğŸ“§ ${student.email}` : ''}
                            ${student.birthday ? ` | ğŸ‚ ${student.birthday}` : ''}
                        </div>
                        ${student.emergencyContact || student.emergencyPhone ? `
                            <div style="color: #e74c3c; font-size: 12px; margin-top: 4px;">
                                ğŸš¨ ç·Šæ€¥è¯çµ¡: ${student.emergencyContact || ''}${student.emergencyPhone ? ` (${student.emergencyPhone})` : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteStudent('${student.id}')" 
                                title="åˆªé™¤å­¸å“¡" style="padding: 10px 15px;">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // å–å¾—ç‹€æ…‹é¡è‰²
        function getStatusColor(status) {
            switch (status) {
                case 'åœ¨è®€': return '#28a745';
                case 'ä¼‘å­¸': return '#ffc107';
                case 'ç•¢æ¥­': return '#6c757d';
                case 'é€€å­¸': return '#dc3545';
                default: return '#007bff';
            }
        }

        // åˆªé™¤å­¸å“¡
        function deleteStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;
            
            if (confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤å­¸å“¡ã€Œ${student.name}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œè«‹è¬¹æ…è€ƒæ…®ã€‚`)) {
                students = students.filter(s => s.id !== id);
                localStorage.setItem('studentData', JSON.stringify(students));
                displayStudents();
                updateClassOptions(); // æ›´æ–°ç­åˆ¥é¸é …
                updateStatistics();
                showNotification(`ğŸ—‘ï¸ å­¸å“¡ã€Œ${student.name}ã€å·²åˆªé™¤`, 'warning');
            }
        }

        // æ›´æ–°ç­åˆ¥é¸é … - å¾ç¾æœ‰å­¸å“¡è³‡æ–™ä¸­æå–
        function updateClassOptions() {
            // å¾å­¸å“¡è³‡æ–™ä¸­æå–æ‰€æœ‰ç­åˆ¥
            const classNames = [...new Set(students.map(s => s.class).filter(c => c && c.trim()))];
            
            // æ›´æ–°æ–°å¢å­¸å“¡çš„ select
            const selectElement = document.getElementById('studentClass');
            if (selectElement) {
                const currentValue = selectElement.value;
                selectElement.innerHTML = '<option value="">è«‹é¸æ“‡ç­åˆ¥</option>' +
                    classNames.map(className => `<option value="${className}">${className}</option>`).join('');
                
                // æ¢å¾©ä¹‹å‰é¸æ“‡çš„å€¼
                if (currentValue && classNames.includes(currentValue)) {
                    selectElement.value = currentValue;
                }
            }
            
            // æ›´æ–°é»åç³»çµ±çš„ select (å¦‚æœå­˜åœ¨)
            const attendanceSelect = document.getElementById('attendanceClass');
            if (attendanceSelect) {
                const currentValue = attendanceSelect.value;
                attendanceSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç­åˆ¥</option>' +
                    classNames.map(className => `<option value="${className}">${className}</option>`).join('');
                
                // æ¢å¾©ä¹‹å‰é¸æ“‡çš„å€¼
                if (currentValue && classNames.includes(currentValue)) {
                    attendanceSelect.value = currentValue;
                }
            }
            
            console.log(`ğŸ“š æ›´æ–°ç­åˆ¥é¸é …: ${classNames.join(', ')}`);
        }

        // å¾èª²ç¨‹è¡¨è¼‰å…¥ç­åˆ¥
        async function loadClassesFromSchedule() {
            try {
                showNotification('æ­£åœ¨å¾èª²ç¨‹è¡¨è¼‰å…¥ç­åˆ¥...', 'warning');
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL + '?action=getSchedule', {
                    method: 'GET',
                    redirect: 'follow'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('ğŸ“… èª²ç¨‹è¡¨å›æ‡‰:', result);

                if (result.success && result.schedule) {
                    const classSelect = document.getElementById('studentClass');
                    const attendanceClassSelect = document.getElementById('attendanceClass');
                    
                    // æ¸…ç©ºç¾æœ‰é¸é …
                    classSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç­åˆ¥</option>';
                    if (attendanceClassSelect) {
                        attendanceClassSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç­åˆ¥</option>';
                    }

                    // å¾èª²ç¨‹è¡¨ä¸­æå–å”¯ä¸€çš„ç­åˆ¥ (ä¸»è¦å¾ class_id æ¬„ä½)
                    const classes = new Set();
                    
                    result.schedule.forEach(scheduleItem => {
                        // å„ªå…ˆæª¢æŸ¥ class_id æ¬„ä½ï¼Œç„¶å¾Œæ˜¯å…¶ä»–å¯èƒ½çš„ç­åˆ¥æ¬„ä½
                        const possibleFields = ['class_id', 'name', 'className', 'class', 'ç­åˆ¥', 'Class', 'class_name'];
                        
                        for (const field of possibleFields) {
                            if (scheduleItem[field] && typeof scheduleItem[field] === 'string') {
                                const className = scheduleItem[field].trim();
                                if (className && className !== '') {
                                    classes.add(className);
                                    console.log(`ğŸ“‹ å¾ ${field} æ¬„ä½æ‰¾åˆ°ç­åˆ¥: ${className}`);
                                    break; // æ‰¾åˆ°å¾Œè·³å‡ºå¾ªç’°
                                }
                            }
                        }
                    });

                    // æ·»åŠ ç­åˆ¥é¸é …
                    classes.forEach(className => {
                        const option = new Option(className, className);
                        classSelect.appendChild(option.cloneNode(true));
                        
                        if (attendanceClassSelect) {
                            attendanceClassSelect.appendChild(option);
                        }
                    });

                    if (classes.size > 0) {
                        showNotification(`âœ… æˆåŠŸè¼‰å…¥ ${classes.size} å€‹ç­åˆ¥`, 'success');
                    } else {
                        showNotification('âš ï¸ èª²ç¨‹è¡¨ä¸­æ²’æœ‰æ‰¾åˆ°ç­åˆ¥è³‡è¨Š', 'warning');
                    }
                } else {
                    throw new Error(result.message || 'è¼‰å…¥èª²ç¨‹è¡¨å¤±æ•—');
                }
            } catch (error) {
                console.error('è¼‰å…¥èª²ç¨‹è¡¨éŒ¯èª¤:', error);
                showNotification(`âŒ è¼‰å…¥èª²ç¨‹è¡¨å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // åŒæ­¥åˆ°é›²ç«¯
        async function syncToCloud() {
            if (students.length === 0) {
                showNotification('æ²’æœ‰å­¸å“¡è³‡æ–™éœ€è¦åŒæ­¥', 'warning');
                return;
            }

            showNotification('ğŸ”„ æ­£åœ¨åŒæ­¥åˆ°é›²ç«¯...', 'info');

            // æº–å‚™å­¸å“¡è³‡æ–™
            const data = students.map(student => ({
                id: student.id || '',
                name: student.name || '',
                nickname: student.nickname || '',
                class: student.class || '',
                phone: student.phone || '',
                email: student.email || '',
                birthday: student.birthday || '',
                emergency_contact: student.emergencyContact || '',  // ç¢ºä¿æ¬„ä½åç¨±å°æ‡‰
                emergency_phone: student.emergencyPhone || '',      // ç¢ºä¿æ¬„ä½åç¨±å°æ‡‰
                status: student.status || '',
                remarks: student.remarks || '',
                createdAt: student.createdAt || ''
            }));

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ students: data })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`âœ… æˆåŠŸåŒæ­¥ ${data.length} ç­†å­¸å“¡è³‡æ–™åˆ°é›²ç«¯`, 'success');
                } else {
                    throw new Error(result.message || 'åŒæ­¥å¤±æ•—');
                }
            } catch (error) {
                console.error('Sync error:', error);
                showNotification('âŒ åŒæ­¥å¤±æ•—ï¼š' + error.message, 'error');
                
                // é¡¯ç¤ºæ‰‹å‹•è¤‡è£½é¸é …
                const csvData = data.map(s => 
                    `${s.id}\t${s.name}\t${s.nickname}\t${s.class}\t${s.phone}\t${s.email}\t${s.birthday}\t${s.emergency_contact}\t${s.emergency_phone}\t${s.status}\t${s.remarks}\t${s.createdAt}`
                ).join('\n');
                
                navigator.clipboard.writeText(csvData);
                showNotification('ğŸ“‹ å·²è¤‡è£½è³‡æ–™åˆ°å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è²¼ä¸Šåˆ° Google Sheets', 'info', 8000);
            }
        }

        // éœé»˜åŒæ­¥åˆ°é›²ç«¯
        async function syncToCloudSilently() {
            if (students.length === 0) return;
            try {
                const isVercel = window.location.hostname.includes('vercel.app');
                const apiUrl = isVercel ? '/api/sync-students' : window.location.origin + '/api/sync-students';
                
                // ç¢ºä¿å­¸å“¡è³‡æ–™åŒ…å«æ‰€æœ‰å¿…è¦æ¬„ä½
                const studentsWithAllFields = students.map(student => ({
                    id: student.id || '',
                    name: student.name || '',
                    nickname: student.nickname || '',
                    class: student.class || '',
                    phone: student.phone || '',
                    email: student.email || '',
                    birthday: student.birthday || '',
                    emergencyContact: student.emergencyContact || '',
                    emergencyPhone: student.emergencyPhone || '',
                    status: student.status || '',
                    remarks: student.remarks || '',
                    createdAt: student.createdAt || ''
                }));
                
                await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ students: studentsWithAllFields })
                });
                console.log(`ğŸ”„ è‡ªå‹•åŒæ­¥ ${students.length} ç­†å­¸å“¡è³‡æ–™åˆ°é›²ç«¯ (åŒ…å«ç·Šæ€¥è¯çµ¡è³‡è¨Š)`);
            } catch (error) {
                console.log('ğŸ”„ è‡ªå‹•åŒæ­¥å¤±æ•—:', error);
            }
        }

        // å¾é›²ç«¯è¼‰å…¥
        async function loadFromCloud() {
            try {
                showNotification('æ­£åœ¨å¾é›²ç«¯è¼‰å…¥...', 'warning');
                document.getElementById('syncStatus').textContent = 'æ­£åœ¨å¾ Google Sheets è¼‰å…¥è³‡æ–™...';
                
                const isVercel = window.location.hostname.includes('vercel.app');
                const apiUrl = isVercel ? '/api/get-students' : window.location.origin + '/api/get-students';
                
                const response = await fetch(apiUrl);
                const result = await response.json();
                
                if (result.success && result.students) {
                    students = result.students;
                    localStorage.setItem('studentData', JSON.stringify(students));
                    displayStudents();
                    updateClassOptions();
                    updateStatistics();
                    showNotification(`âœ… æˆåŠŸè¼‰å…¥ ${result.count} ç­†å­¸å“¡è³‡æ–™`, 'success');
                    document.getElementById('syncStatus').textContent = `âœ… æˆåŠŸè¼‰å…¥ ${result.count} ç­†è³‡æ–™ (${new Date().toLocaleString('zh-TW')})`;
                } else {
                    throw new Error(result.error || 'è¼‰å…¥å¤±æ•—');
                }
            } catch (error) {
                console.error('è¼‰å…¥å¤±æ•—:', error);
                showNotification('âŒ è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
                document.getElementById('syncStatus').textContent = `âŒ è¼‰å…¥å¤±æ•—: ${error.message}`;
            }
        }

        // éœé»˜å¾é›²ç«¯è¼‰å…¥
        async function loadFromCloudSilently() {
            try {
                const isVercel = window.location.hostname.includes('vercel.app');
                const apiUrl = isVercel ? '/api/get-students' : window.location.origin + '/api/get-students';
                
                const response = await fetch(apiUrl);
                const result = await response.json();
                
                if (result.success && result.students && result.students.length > 0) {
                    if (result.students.length >= students.length) {
                        students = result.students;
                        localStorage.setItem('studentData', JSON.stringify(students));
                        displayStudents();
                        updateClassOptions();
                        console.log(`ğŸ”„ è‡ªå‹•è¼‰å…¥ ${result.count} ç­†é›²ç«¯å­¸å“¡è³‡æ–™`);
                    }
                }
            } catch (error) {
                console.log('ğŸ“± ä½¿ç”¨æœ¬åœ°æ¨¡å¼');
            }
        }

        // æ›´æ–°çµ±è¨ˆ
        function updateStatistics() {
            const total = students.length;
            const active = students.filter(s => s.status === 'åœ¨è®€').length;
            const suspended = students.filter(s => s.status === 'ä¼‘å­¸').length;
            const graduated = students.filter(s => s.status === 'ç•¢æ¥­').length;

            // å¦‚æœæœ‰çµ±è¨ˆå…ƒç´ æ‰æ›´æ–°
            const totalElement = document.getElementById('totalStudents');
            if (totalElement) {
                totalElement.textContent = total;
                document.getElementById('activeStudents').textContent = active;
                document.getElementById('suspendedStudents').textContent = suspended;
                document.getElementById('graduatedStudents').textContent = graduated;
            }
        }

        // é–‹å§‹é»å
        function startAttendance() {
            const date = document.getElementById('attendanceDate').value;
            const className = document.getElementById('attendanceClass').value;
            
            console.log('=== é–‹å§‹é»å ===');
            console.log('é¸æ“‡æ—¥æœŸ:', date);
            console.log('é¸æ“‡ç­åˆ¥:', className);
            
            if (!date || !className) {
                showNotification('è«‹é¸æ“‡æ—¥æœŸå’Œç­åˆ¥', 'error');
                console.log('âŒ æ—¥æœŸæˆ–ç­åˆ¥æœªé¸æ“‡');
                return;
            }
            
            currentAttendanceDate = date;
            currentAttendanceClass = className;
            
            console.log('âœ… è¨­å®šå…¨åŸŸè®Šæ•¸:');
            console.log('- currentAttendanceDate:', currentAttendanceDate);
            console.log('- currentAttendanceClass:', currentAttendanceClass);
            
            // ç²å–è©²ç­åˆ¥çš„å­¸å“¡ï¼Œä¸¦ä¸”åªç¯©é¸ã€Œåœ¨è®€ã€ç‹€æ…‹çš„å­¸å“¡
            const allClassStudents = students.filter(s => s.class === className);
            const activeStudents = allClassStudents.filter(s => s.status === 'åœ¨è®€');
            
            console.log(`ğŸ“š ${className} ç¸½å­¸å“¡æ•¸:`, allClassStudents.length);
            console.log(`âœ… ${className} åœ¨è®€å­¸å“¡æ•¸:`, activeStudents.length);
            console.log('åœ¨è®€å­¸å“¡åå–®:', activeStudents.map(s => s.name));
            
            if (allClassStudents.length === 0) {
                showNotification(`${className} æ²’æœ‰å­¸å“¡è³‡æ–™`, 'warning');
                console.log('âŒ è©²ç­åˆ¥æ²’æœ‰å­¸å“¡');
                return;
            }
            
            if (activeStudents.length === 0) {
                showNotification(`${className} æ²’æœ‰ã€Œåœ¨è®€ã€ç‹€æ…‹çš„å­¸å“¡`, 'warning');
                console.log('âŒ è©²ç­åˆ¥æ²’æœ‰åœ¨è®€å­¸å“¡');
                return;
            }
            
            console.log(`âœ… æ‰¾åˆ° ${activeStudents.length} ä½åœ¨è®€å­¸å“¡`);
            
            // é¡¯ç¤ºé»ååˆ—è¡¨ï¼ˆåªé¡¯ç¤ºåœ¨è®€å­¸å“¡ï¼‰
            displayAttendanceList(activeStudents);
            document.getElementById('attendanceListCard').style.display = 'block';
            
            // è¨­ç½®é»åæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            setupAttendanceButtons();
            
            showNotification(`é–‹å§‹ ${className} çš„é»å (${activeStudents.length} ä½åœ¨è®€å­¸å“¡)`, 'success');
            console.log('âœ… é»ååˆ—è¡¨å·²é¡¯ç¤ºï¼ˆåƒ…åœ¨è®€å­¸å“¡ï¼‰');
        }
        
        // é¡¯ç¤ºé»ååˆ—è¡¨
        function displayAttendanceList(classStudents) {
            const container = document.getElementById('attendanceStudentsList');
            
            // æ¸…ç©ºè‡¨æ™‚é¸æ“‡
            tempAttendanceChoices = {};
            
            container.innerHTML = classStudents.map(student => `
                <div class="student-attendance-item">
                    <div class="student-info">
                        <div class="student-name">
                            ${student.name}
                            ${student.nickname ? `<span style="color: #999; font-size: 14px;">(${student.nickname})</span>` : ''}
                        </div>
                        <div class="student-class">
                            ç­åˆ¥: ${student.class}
                        </div>
                    </div>
                    <div class="attendance-buttons">
                        <button class="attendance-choice-btn btn btn-success" 
                                onclick="selectAttendanceStatus('${student.id}', 'å‡ºå¸­', this)"
                                data-student-id="${student.id}" 
                                data-status="å‡ºå¸­" 
                                title="å‡ºå¸­">
                            âœ…
                        </button>
                        <button class="attendance-choice-btn btn btn-warning" 
                                onclick="selectAttendanceStatus('${student.id}', 'è«‹å‡', this)"
                                data-student-id="${student.id}" 
                                data-status="è«‹å‡" 
                                title="è«‹å‡">
                            ğŸ¥
                        </button>
                        <button class="attendance-choice-btn btn btn-primary" 
                                onclick="selectAttendanceStatus('${student.id}', 'é²åˆ°', this)"
                                data-student-id="${student.id}" 
                                data-status="é²åˆ°" 
                                title="é²åˆ°">
                            â°
                        </button>
                    </div>
                </div>
            `).join('');
            
            console.log('âœ… é»ååˆ—è¡¨å·²ç”Ÿæˆï¼ˆæ‰‹æ©Ÿå‹å¥½ä½ˆå±€ï¼‰');
            console.log('å­¸å“¡åˆ—è¡¨:', classStudents.map(s => ({ id: s.id, name: s.name })));
        }

        // é¸æ“‡å‡ºå¸­ç‹€æ…‹ï¼ˆåªæ›´æ–°ç•Œé¢ï¼Œä¸ç«‹å³å„²å­˜ï¼‰
        function selectAttendanceStatus(studentId, status, clickedButton) {
            console.log('=== é¸æ“‡å‡ºå¸­ç‹€æ…‹ ===');
            console.log('å­¸å“¡ID:', studentId);
            console.log('é¸æ“‡ç‹€æ…‹:', status);
            
            // è¨˜éŒ„è‡¨æ™‚é¸æ“‡
            tempAttendanceChoices[studentId] = status;
            console.log('ç›®å‰è‡¨æ™‚é¸æ“‡:', tempAttendanceChoices);
            
            // æ›´æ–°è©²å­¸å“¡çš„æŒ‰éˆ•è¦–è¦ºç‹€æ…‹
            const studentButtons = document.querySelectorAll(`button[data-student-id="${studentId}"]`);
            
            // é‡ç½®æ‰€æœ‰æŒ‰éˆ•
            studentButtons.forEach(btn => {
                btn.classList.remove('selected');
                btn.style.backgroundColor = '';
                btn.style.borderColor = '';
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = '';
            });
            
            // è¨­å®šé¸ä¸­æŒ‰éˆ•çš„æ¨£å¼
            if (clickedButton) {
                clickedButton.classList.add('selected');
                clickedButton.style.transform = 'scale(0.9)';
                clickedButton.style.boxShadow = '0 0 0 3px rgba(13, 110, 253, 0.25)';
                
                // æ ¹æ“šç‹€æ…‹è¨­å®šé¡è‰²
                switch(status) {
                    case 'å‡ºå¸­':
                        clickedButton.style.backgroundColor = '#198754';
                        clickedButton.style.borderColor = '#146c43';
                        break;
                    case 'è«‹å‡':
                        clickedButton.style.backgroundColor = '#fd7e14';
                        clickedButton.style.borderColor = '#fd7e14';
                        break;
                    case 'é²åˆ°':
                        clickedButton.style.backgroundColor = '#0d6efd';
                        clickedButton.style.borderColor = '#0a58ca';
                        break;
                }
            }
            
            // æ‰¾åˆ°å­¸å“¡è³‡æ–™é¡¯ç¤ºå§“å
            const student = students.find(s => s.id === studentId);
            const studentName = student ? student.name : `å­¸å“¡${studentId}`;
            
            showNotification(`${studentName}: ${status}`, 'success');
            
            // æ›´æ–°å„²å­˜æŒ‰éˆ•ç‹€æ…‹
            updateSaveButtonStatus();
        }

        // æ›´æ–°å„²å­˜æŒ‰éˆ•ç‹€æ…‹
        function updateSaveButtonStatus() {
            const totalStudents = document.querySelectorAll('[data-student-id]').length / 3; // æ¯å€‹å­¸å“¡æœ‰3å€‹æŒ‰éˆ•
            const selectedCount = Object.keys(tempAttendanceChoices).length;
            
            console.log(`å·²é¸æ“‡ ${selectedCount}/${totalStudents} ä½å­¸å“¡`);
            
            // é€™è£¡å¯ä»¥æ·»åŠ è¦–è¦ºæç¤ºï¼Œæ¯”å¦‚é¡¯ç¤ºé€²åº¦
            if (selectedCount === totalStudents && totalStudents > 0) {
                showNotification(`âœ… å·²ç‚ºæ‰€æœ‰ ${totalStudents} ä½å­¸å“¡é¸æ“‡ç‹€æ…‹ï¼Œå¯ä»¥å„²å­˜äº†ï¼`, 'success');
            }
        }
        
        // è¨­ç½®é»åæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨ - ç¾åœ¨æ”¹ç”¨ onclickï¼Œé€™å€‹å‡½æ•¸ä¿ç•™ä½†ç°¡åŒ–
        function setupAttendanceButtons() {
            console.log('âœ… é»åæŒ‰éˆ•ä½¿ç”¨ç›´æ¥ onclick äº‹ä»¶ï¼Œç„¡éœ€é¡å¤–è¨­ç½®');
        }

        // å„²å­˜é»åè¨˜éŒ„ - å°‡è‡¨æ™‚é¸æ“‡è½‰ç‚ºæ­£å¼è¨˜éŒ„
        async function saveAttendance() {
            console.log('=== é–‹å§‹å„²å­˜é»åè¨˜éŒ„ ===');
            console.log('è‡¨æ™‚é¸æ“‡:', tempAttendanceChoices);
            console.log('ç•¶å‰æ—¥æœŸ:', currentAttendanceDate);
            console.log('ç•¶å‰ç­åˆ¥:', currentAttendanceClass);
            
            // æª¢æŸ¥æ˜¯å¦æœ‰é¸æ“‡
            if (Object.keys(tempAttendanceChoices).length === 0) {
                showNotification('è«‹å…ˆç‚ºå­¸å“¡é¸æ“‡å‡ºå¸­ç‹€æ…‹', 'warning');
                console.log('âŒ æ²’æœ‰ä»»ä½•é¸æ“‡');
                return;
            }
            
            // æª¢æŸ¥å¿…è¦è®Šæ•¸
            if (!currentAttendanceDate || !currentAttendanceClass) {
                showNotification('ç¼ºå°‘æ—¥æœŸæˆ–ç­åˆ¥è³‡è¨Šï¼Œè«‹é‡æ–°é–‹å§‹é»å', 'error');
                console.log('âŒ ç¼ºå°‘å¿…è¦è®Šæ•¸');
                return;
            }
            
            try {
                // æ¸…é™¤è©²æ—¥æœŸè©²ç­åˆ¥çš„èˆŠè¨˜éŒ„
                const originalLength = todayAttendance.length;
                todayAttendance = todayAttendance.filter(att => 
                    !(att.date === currentAttendanceDate && att.className === currentAttendanceClass)
                );
                
                if (todayAttendance.length < originalLength) {
                    console.log(`ğŸ—‘ï¸ æ¸…é™¤äº† ${originalLength - todayAttendance.length} ç­†èˆŠè¨˜éŒ„`);
                }
                
                // å°‡è‡¨æ™‚é¸æ“‡è½‰ç‚ºæ­£å¼è¨˜éŒ„
                const newRecords = [];
                for (const [studentId, status] of Object.entries(tempAttendanceChoices)) {
                    const student = students.find(s => s.id === studentId);
                    const studentName = student ? student.name : `æœªçŸ¥å­¸å“¡(${studentId})`;
                    
                    const record = {
                        id: 'ATT_' + Date.now() + '_' + studentId,
                        date: currentAttendanceDate,
                        className: currentAttendanceClass,
                        studentId: studentId,
                        studentName: studentName,
                        status: status,
                        createdAt: new Date().toLocaleString('zh-TW')
                    };
                    
                    newRecords.push(record);
                    todayAttendance.push(record);
                }
                
                console.log('âœ… æ–°å¢çš„è¨˜éŒ„:', newRecords);
                console.log('ç›®å‰ç¸½è¨˜éŒ„æ•¸:', todayAttendance.length);
                
                // å„²å­˜åˆ°æœ¬åœ°
                localStorage.setItem('todayAttendance', JSON.stringify(todayAttendance));
                console.log('âœ… å·²å„²å­˜åˆ° localStorage');
                
                // é©—è­‰å„²å­˜
                const savedData = localStorage.getItem('todayAttendance');
                const parsedData = JSON.parse(savedData);
                console.log('âœ… é©—è­‰å„²å­˜æˆåŠŸï¼Œç¸½è¨˜éŒ„æ•¸:', parsedData.length);
                
                // æ¸…ç©ºè‡¨æ™‚é¸æ“‡
                tempAttendanceChoices = {};
                
                // æ›´æ–°é¡¯ç¤º
                displayTodayAttendance();
                updateAttendanceCount();
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                showNotification(`âœ… å·²å„²å­˜ ${newRecords.length} ç­†é»åè¨˜éŒ„`, 'success');
                console.log(`âœ… å„²å­˜å®Œæˆï¼Œæ–°å¢ ${newRecords.length} ç­†è¨˜éŒ„`);
                
                // éš±è—é»ååˆ—è¡¨
                document.getElementById('attendanceListCard').style.display = 'none';
                
            } catch (error) {
                console.error('âŒ å„²å­˜å¤±æ•—:', error);
                showNotification('âŒ å„²å­˜å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // é‡æ–°é»å
        function resetAttendance() {
            if (confirm('ç¢ºå®šè¦é‡æ–°é»åå—ï¼Ÿé€™æœƒæ¸…é™¤ç›®å‰çš„é»åç‹€æ…‹ã€‚')) {
                // æ¸…é™¤ä»Šæ—¥è©²ç­åˆ¥çš„è¨˜éŒ„
                todayAttendance = todayAttendance.filter(att => 
                    !(att.date === currentAttendanceDate && att.className === currentAttendanceClass)
                );
                
                // é‡æ–°é–‹å§‹é»å
                startAttendance();
                showNotification('å·²é‡æ–°é–‹å§‹é»å', 'success');
            }
        }
        
        // è¼‰å…¥ä»Šæ—¥å‡ºå¸­è¨˜éŒ„
        function loadTodayAttendance() {
            const saved = localStorage.getItem('todayAttendance');
            if (saved) {
                todayAttendance = JSON.parse(saved);
            }
            displayTodayAttendance();
            updateAttendanceCount();
        }

        // æ›´æ–°é»åè¨˜éŒ„æ•¸é‡
        function updateAttendanceCount() {
            const countElement = document.getElementById('attendanceCount');
            if (countElement) {
                countElement.textContent = todayAttendance.length;
            }
        }

        // é¡¯ç¤ºé»åè¨˜éŒ„
        function showAttendanceRecords() {
            if (todayAttendance.length === 0) {
                showNotification('æ²’æœ‰é»åè¨˜éŒ„', 'warning');
                return;
            }
            
            let recordsText = 'ğŸ“‹ æœ¬åœ°é»åè¨˜éŒ„ï¼š\n\n';
            todayAttendance.forEach(record => {
                recordsText += `ğŸ“… ${record.date} | ğŸ“š ${record.className}\n`;
                recordsText += `ğŸ‘¤ ${record.studentName} (ID: ${record.studentId}) - ${record.status}\n`;
                recordsText += `â° ${record.createdAt}\n\n`;
            });
            
            alert(recordsText);
        }

        // åŒæ­¥é»åè¨˜éŒ„åˆ°é›²ç«¯ï¼ˆè‡ªå‹•ä¸Šå‚³ç‰ˆ + æ¸…ç©ºæ©Ÿåˆ¶ï¼‰
        async function syncAttendanceToCloud() {
            if (todayAttendance.length === 0) {
                showNotification('æ²’æœ‰é»åè¨˜éŒ„å¯åŒæ­¥', 'warning');
                return;
            }
            
            // ğŸ’¡ ä¸Šå‚³å‰ç¢ºèª
            const recordCount = todayAttendance.length;
            if (!confirm(`ğŸ“¤ æº–å‚™è‡ªå‹•ä¸Šå‚³ ${recordCount} ç­†é»åè¨˜éŒ„åˆ° Google Sheets\n\nâš ï¸ ä¸Šå‚³æˆåŠŸå¾Œå°‡æ¸…ç©ºæœ¬åœ°è¨˜éŒ„ï¼Œé¿å…é‡è¤‡ä¸Šå‚³\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`)) {
                showNotification('å·²å–æ¶ˆä¸Šå‚³', 'warning');
                return;
            }
            
            try {
                showNotification('æ­£åœ¨è‡ªå‹•ä¸Šå‚³é»åè¨˜éŒ„åˆ° Google Sheets...', 'warning');
                
                // æº–å‚™ä¸Šå‚³è³‡æ–™ - æŒ‰ç…§æ­£ç¢ºæ ¼å¼ï¼šæ—¥æœŸã€ç­åˆ¥ã€å­¸å“¡IDã€å­¸å“¡å§“åã€å‡ºå¸­ç‹€æ…‹
                const attendanceForSync = todayAttendance.map(record => ({
                    date: record.date,
                    class: record.className,
                    studentId: record.studentId,
                    studentName: record.studentName,
                    status: record.status
                }));
                
                console.log('æº–å‚™è‡ªå‹•ä¸Šå‚³çš„é»åè¨˜éŒ„:', attendanceForSync);
                
                // æª¢æŸ¥æ˜¯å¦ç‚º Vercel éƒ¨ç½²ç‰ˆæœ¬
                const isVercel = window.location.hostname.includes('vercel.app');
                const apiUrl = isVercel ? '/api/sync-attendance' : window.location.origin + '/api/sync-attendance';
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({
                        attendance: attendanceForSync
                    })
                });
                
                console.log('API éŸ¿æ‡‰ç‹€æ…‹:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('API éŸ¿æ‡‰çµæœ:', result);
                
                if (result.success) {
                    showNotification(`âœ… å·²æˆåŠŸè‡ªå‹•ä¸Šå‚³ ${recordCount} ç­†é»åè¨˜éŒ„åˆ° Google Sheets`, 'success');
                    console.log('âœ… é»åè¨˜éŒ„è‡ªå‹•ä¸Šå‚³æˆåŠŸ');
                    
                    // ğŸ”§ æˆåŠŸä¸Šå‚³å¾Œæ¸…ç©ºæœ¬åœ°è¨˜éŒ„
                    todayAttendance = [];
                    localStorage.setItem('todayAttendance', JSON.stringify(todayAttendance));
                    
                    // æ›´æ–°é¡¯ç¤º
                    displayTodayAttendance();
                    updateAttendanceCount();
                    
                    console.log(`âœ… å·²æ¸…ç©ºæœ¬åœ°é»åè¨˜éŒ„ï¼Œé¿å…é‡è¤‡ä¸Šå‚³`);
                    showNotification(`ğŸ‰ ä¸Šå‚³å®Œæˆï¼æœ¬åœ°è¨˜éŒ„å·²æ¸…ç©ºï¼Œå¯ä»¥é€²è¡Œä¸‹ä¸€è¼ªé»å`, 'success');
                    
                } else {
                    throw new Error(result.error || 'è‡ªå‹•ä¸Šå‚³å¤±æ•—');
                }
                
            } catch (error) {
                console.error('âŒ è‡ªå‹•ä¸Šå‚³é»åè¨˜éŒ„å¤±æ•—:', error);
                
                // å¦‚æœè‡ªå‹•ä¸Šå‚³å¤±æ•—ï¼Œæä¾›å‚™ç”¨çš„æ‰‹å‹•æ–¹å¼
                if (error.message.includes('Unexpected token') || error.message.includes('not valid JSON') || error.message.includes('404')) {
                    showNotification('âš ï¸ è‡ªå‹•ä¸Šå‚³å¤±æ•—ï¼Œç‚ºæ‚¨æº–å‚™æ‰‹å‹•ä¸Šå‚³è³‡æ–™...', 'warning');
                    
                    // å‚™ç”¨ï¼šæº–å‚™æ‰‹å‹•è¤‡è£½çš„è³‡æ–™
                    const recordsForCopy = todayAttendance.map(record => 
                        `${record.date}\t${record.className}\t${record.studentId}\t${record.studentName}\t${record.status}`
                    ).join('\n');
                    
                    const header = 'æ—¥æœŸ\tç­åˆ¥\tå­¸å“¡ID\tå­¸å“¡å§“å\tå‡ºå¸­ç‹€æ…‹\n';
                    const fullData = header + recordsForCopy;
                    
                    try {
                        await navigator.clipboard.writeText(fullData);
                        showNotification('ğŸ“‹ å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼Œè«‹æ‰‹å‹•è²¼åˆ° Google Sheets', 'warning');
                        
                        // è©¢å•ç”¨æˆ¶æ˜¯å¦è¦æ¸…ç©ºæœ¬åœ°è¨˜éŒ„
                        if (confirm(`è‡ªå‹•ä¸Šå‚³å¤±æ•—ï¼Œä½†è³‡æ–™å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼\n\nè«‹åˆ° Google Sheets æ‰‹å‹•è²¼ä¸Šè³‡æ–™ã€‚\n\næ˜¯å¦è¦æ¸…ç©ºæœ¬åœ°è¨˜éŒ„ï¼Ÿ\nï¼ˆå»ºè­°åœ¨ç¢ºèªè²¼ä¸ŠæˆåŠŸå¾Œå†æ¸…ç©ºï¼‰`)) {
                            todayAttendance = [];
                            localStorage.setItem('todayAttendance', JSON.stringify(todayAttendance));
                            displayTodayAttendance();
                            updateAttendanceCount();
                            console.log(`âœ… ç”¨æˆ¶é¸æ“‡æ¸…ç©ºæœ¬åœ°è¨˜éŒ„`);
                            showNotification('âœ… æœ¬åœ°è¨˜éŒ„å·²æ¸…ç©º', 'success');
                        }
                        
                        alert(`è‡ªå‹•ä¸Šå‚³å¤±æ•—ï¼Œä½†è³‡æ–™å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼\n\nè«‹åˆ°æ‚¨çš„ Google Sheets æ‰‹å‹•è²¼ä¸Šï¼š\n1. é–‹å•Ÿæ‚¨çš„ Google Sheets\n2. é¸æ“‡ã€Œattendanceã€å·¥ä½œè¡¨\n3. æŒ‰ Ctrl+V è²¼ä¸Šè³‡æ–™`);
                    } catch (clipboardError) {
                        showNotification('âŒ è‡ªå‹•ä¸Šå‚³å’Œè¤‡è£½éƒ½å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥', 'error');
                    }
                } else {
                    showNotification('âŒ è‡ªå‹•ä¸Šå‚³å¤±æ•—: ' + error.message, 'error');
                }
            }
        }
        
        // é¡¯ç¤ºä»Šæ—¥å‡ºå¸­è¨˜éŒ„
        function displayTodayAttendance() {
            const list = document.getElementById('todayAttendanceList');
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = todayAttendance.filter(att => att.date === today);
            
            if (todayRecords.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>ğŸ“ é‚„æ²’æœ‰ä»Šæ—¥çš„é»åè¨˜éŒ„</h3>
                        <p>é¸æ“‡ç­åˆ¥ä¸¦é–‹å§‹é»å</p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰ç­åˆ¥åˆ†çµ„
            const groupedByClass = {};
            todayRecords.forEach(att => {
                if (!groupedByClass[att.className]) {
                    groupedByClass[att.className] = [];
                }
                groupedByClass[att.className].push(att);
            });
            
            let html = '';
            Object.keys(groupedByClass).forEach(className => {
                const classRecords = groupedByClass[className];
                html += `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #333; margin-bottom: 15px; font-size: 18px;">ğŸ“š ${className}</h4>
                        ${classRecords.map(att => `
                            <div class="student-item" style="margin-bottom: 10px;">
                                <div>
                                    <div style="font-size: 16px; font-weight: 600; color: #333;">
                                        ${att.studentName}
                                        <span style="color: ${getAttendanceColor(att.status)}; font-weight: 600; margin-left: 10px;">
                                            ${getAttendanceIcon(att.status)} ${att.status}
                                        </span>
                                    </div>
                                    <div style="color: #999; font-size: 13px;">
                                        ğŸ“ ${att.createdAt}
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-danger" onclick="deleteAttendance('${att.id}')" 
                                            title="åˆªé™¤è¨˜éŒ„" style="padding: 8px 12px; font-size: 12px;">
                                        ğŸ—‘ï¸
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        // ç²å–å‡ºå¸­ç‹€æ…‹é¡è‰²
        function getAttendanceColor(status) {
            switch (status) {
                case 'å‡ºå¸­': return '#28a745';
                case 'ç¼ºå¸­': return '#dc3545';
                case 'è«‹å‡': return '#6c757d';
                case 'é²åˆ°': return '#ffc107';
                default: return '#007bff';
            }
        }

        // ç²å–å‡ºå¸­ç‹€æ…‹åœ–æ¨™
        function getAttendanceIcon(status) {
            switch (status) {
                case 'å‡ºå¸­': return 'âœ…';
                case 'ç¼ºå¸­': return 'âŒ';
                case 'è«‹å‡': return 'ğŸ¥';
                case 'é²åˆ°': return 'â°';
                default: return 'ğŸ“';
            }
        }

        // åˆªé™¤å‡ºå¸­è¨˜éŒ„
        function deleteAttendance(id) {
            const att = todayAttendance.find(a => a.id === id);
            if (!att) return;
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${att.studentName}ã€çš„é»åè¨˜éŒ„å—ï¼Ÿ`)) {
                todayAttendance = todayAttendance.filter(a => a.id !== id);
                localStorage.setItem('todayAttendance', JSON.stringify(todayAttendance));
                displayTodayAttendance();
                showNotification('ğŸ—‘ï¸ å·²åˆªé™¤é»åè¨˜éŒ„', 'warning');
            }
        }

        // åŒ¯å‡ºå­¸å“¡æ¸…å–®
        function exportStudentList() {
            if (students.length === 0) {
                showNotification('æ²’æœ‰å­¸å“¡è³‡æ–™å¯åŒ¯å‡º', 'warning');
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8," 
                + "å­¸å“¡ID,å­¸å“¡å§“å,åˆ¥å,ç­åˆ¥,é›»è©±,ä¿¡ç®±,ç”Ÿæ—¥,ç·Šæ€¥è¯çµ¡äºº,ç·Šæ€¥è¯çµ¡é›»è©±,ç‹€æ…‹,å»ºç«‹æ—¥æœŸ,å‚™è¨»\n"
                + students.map(student => 
                    `"${student.id || ''}","${student.name}","${student.nickname || ''}","${student.class || ''}","${student.phone || ''}","${student.email || ''}","${student.birthday ? formatBirthday(student.birthday) : ''}","${student.emergencyContact || ''}","${student.emergencyPhone || ''}","${student.status}","${student.createdAt}","${student.remarks || ''}"`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `å­¸å“¡æ¸…å–®_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`ğŸ“„ å­¸å“¡æ¸…å–®å·²åŒ¯å‡º (${students.length} ç­†è³‡æ–™)`, 'success');
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ (ç°¡åŒ–ç‰ˆï¼Œç§»é™¤ç„¡ç”¨ä»£ç¢¼)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ å­¸å“¡ç®¡ç†ç³»çµ±å•Ÿå‹• - é›²ç«¯åŒæ­¥æ¨¡å¼');
            fetchClassList();
            loadStudentsFromCloud();
        });

        // æ ¼å¼åŒ–ç”Ÿæ—¥æ—¥æœŸé¡¯ç¤º
        function formatBirthday(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const day = date.getDate();
            const month = months[date.getMonth()];
            return `${day}-${month}`;
        }

        // è™•ç†ç”Ÿæ—¥è¼¸å…¥ï¼Œè‡ªå‹•è½‰æ›æ ¼å¼
        function handleBirthdayInput() {
            const birthdayInput = document.getElementById('studentBirthday');
            if (birthdayInput.value) {
                const formatted = formatBirthday(birthdayInput.value);
                console.log(`ğŸ‚ ç”Ÿæ—¥æ ¼å¼åŒ–: ${birthdayInput.value} â†’ ${formatted}`);
            }
        }

        // å¾scheduleé é¢ç²å–ç­åˆ¥åˆ—è¡¨
        async function fetchClassList() {
            try {
                // ä½¿ç”¨Vercel API routeä¾†ç²å–ç­åˆ¥
                const response = await fetch('/api/get-classes', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                if (result.success && result.classes) {
                    updateClassSelect(result.classes);
                    console.log('âœ… æˆåŠŸè¼‰å…¥ç­åˆ¥åˆ—è¡¨:', result.classes);
                } else {
                    throw new Error('ç„¡æ³•ç²å–ç­åˆ¥åˆ—è¡¨');
                }
            } catch (error) {
                console.error('ç²å–ç­åˆ¥åˆ—è¡¨å¤±æ•—:', error);
                showNotification('âŒ ç„¡æ³•è¼‰å…¥ç­åˆ¥åˆ—è¡¨ï¼Œä½¿ç”¨é è¨­é¸é …', 'warning');
                
                // å¦‚æœAPIå¤±æ•—ï¼Œæä¾›æ‰‹å‹•è¼¸å…¥é¸é …
                const select = document.getElementById('studentClass');
                select.innerHTML = `
                    <option value="">è«‹é¸æ“‡ç­åˆ¥</option>
                    <option value="é’å¹´ç­">é’å¹´ç­</option>
                    <option value="æˆäººç­">æˆäººç­</option>
                    <option value="å…’ç«¥ç­">å…’ç«¥ç­</option>
                `;
            }
        }

        // æ›´æ–°ç­åˆ¥ä¸‹æ‹‰é¸å–®
        function updateClassSelect(classes) {
            const select = document.getElementById('studentClass');
            // ä¿ç•™ç¬¬ä¸€å€‹"è«‹é¸æ“‡ç­åˆ¥"é¸é …
            select.innerHTML = '<option value="">è«‹é¸æ“‡ç­åˆ¥</option>';
            
            // è™•ç†ä¸åŒçš„è³‡æ–™æ ¼å¼
            if (Array.isArray(classes)) {
                classes.forEach(classItem => {
                    const option = document.createElement('option');
                    
                    // æ”¯æ´ä¸åŒçš„è³‡æ–™æ ¼å¼
                    if (typeof classItem === 'string') {
                        // ç°¡å–®å­—ä¸²æ ¼å¼
                        option.value = classItem;
                        option.textContent = classItem;
                    } else if (classItem.class_id) {
                        // ç‰©ä»¶æ ¼å¼ {class_id: "é’å¹´ç­", class_name: "é’å¹´ç­æè¿°"}
                        option.value = classItem.class_id;
                        option.textContent = classItem.class_name ? 
                            `${classItem.class_id} (${classItem.class_name})` : 
                            classItem.class_id;
                    } else if (classItem.name) {
                        // ç‰©ä»¶æ ¼å¼ {name: "é’å¹´ç­"}
                        option.value = classItem.name;
                        option.textContent = classItem.name;
                    }
                    
                    select.appendChild(option);
                });
                
                console.log(`âœ… å·²è¼‰å…¥ ${classes.length} å€‹ç­åˆ¥é¸é …`);
            } else {
                console.warn('âš ï¸ ç­åˆ¥è³‡æ–™æ ¼å¼ä¸æ­£ç¢º:', classes);
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', () => {
            console.log('ğŸš€ å­¸å“¡ç®¡ç†ç³»çµ±å•Ÿå‹• - é›²ç«¯åŒæ­¥æ¨¡å¼');
            fetchClassList();
            loadStudentsFromCloud();
        });

        // å¾é›²ç«¯è¼‰å…¥å­¸å“¡åˆ—è¡¨
        async function loadStudentsFromCloud() {
            showNotification('ğŸ”„ æ­£åœ¨è¼‰å…¥å­¸å“¡åˆ—è¡¨...', 'info');
            
            try {
                const response = await fetch('/api/get-students', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.students) {
                    displayStudents(result.students);
                    updateStatistics(result.students);
                    console.log('âœ… æˆåŠŸè¼‰å…¥å­¸å“¡åˆ—è¡¨:', result.students.length, 'ç­†è³‡æ–™');
                    showNotification(`âœ… å·²è¼‰å…¥ ${result.students.length} ç­†å­¸å“¡è³‡æ–™`, 'success');
                } else {
                    throw new Error('ç„¡æ³•è¼‰å…¥å­¸å“¡åˆ—è¡¨');
                }
            } catch (error) {
                console.error('è¼‰å…¥å­¸å“¡åˆ—è¡¨å¤±æ•—:', error);
                showNotification('âŒ è¼‰å…¥å­¸å“¡åˆ—è¡¨å¤±æ•—ï¼š' + error.message, 'error');
                
                // é¡¯ç¤ºç©ºç‹€æ…‹
                const list = document.getElementById('studentList');
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>âš ï¸ ç„¡æ³•è¼‰å…¥å­¸å“¡è³‡æ–™</h3>
                        <p>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯ç¹«ç³»çµ±ç®¡ç†å“¡<br>
                        éŒ¯èª¤è©³æƒ…ï¼š${error.message}</p>
                        <button class="btn btn-primary" onclick="loadStudentsFromCloud()" style="margin-top: 15px;">
                            ğŸ”„ é‡æ–°è¼‰å…¥
                        </button>
                    </div>
                `;
            }
        }

        // é¡¯ç¤ºå­¸å“¡åˆ—è¡¨ (æ¥æ”¶å­¸å“¡é™£åˆ—ä½œç‚ºåƒæ•¸)
        function displayStudents(studentArray = []) {
            const list = document.getElementById('studentList');
            
            if (studentArray.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>ğŸ“š é‚„æ²’æœ‰å­¸å“¡è³‡æ–™</h3>
                        <p>é»æ“Šä¸Šæ–¹çš„ã€Œæ–°å¢å­¸å“¡ã€æŒ‰éˆ•é–‹å§‹å»ºç«‹ä½ çš„å­¸å“¡åå†Š<br>
                        æ‰€æœ‰è³‡æ–™æœƒç›´æ¥å„²å­˜åˆ° Google Sheets ä¸­</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = studentArray.map(student => `
                <div class="student-item">
                    <div>
                        <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px; color: #333;">
                            ${student.name}
                            ${student.nickname ? `<span style="color: #666; font-weight: 400; font-size: 16px;">(${student.nickname})</span>` : ''}
                            <span style="color: #999; font-weight: 400; font-size: 14px; margin-left: 10px;">ID: ${student.id}</span>
                        </div>
                        <div style="color: #666; font-size: 15px; margin-bottom: 5px;">
                            <span style="margin-right: 20px; background: #e3f2fd; padding: 4px 12px; border-radius: 20px; color: #1976d2;">
                                ğŸ“š ${student.class || 'æœªåˆ†é…ç­åˆ¥'}
                            </span>
                            <span style="color: ${getStatusColor(student.status)}; font-weight: 600;">
                                â— ${student.status}
                            </span>
                        </div>
                        <div style="color: #999; font-size: 13px; line-height: 1.4;">
                            ğŸ“… ${student.createdAt} å»ºç«‹
                            ${student.phone ? ` | ğŸ“ ${student.phone}` : ''}
                            ${student.email ? ` | ğŸ“§ ${student.email}` : ''}
                            ${student.birthday ? ` | ğŸ‚ ${student.birthday}` : ''}
                        </div>
                        ${student.emergencyContact || student.emergencyPhone ? `
                            <div style="color: #e74c3c; font-size: 12px; margin-top: 4px;">
                                ğŸš¨ ç·Šæ€¥è¯çµ¡: ${student.emergencyContact || ''}${student.emergencyPhone ? ` (${student.emergencyPhone})` : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteStudentFromCloud('${student.id}')" 
                                title="åˆªé™¤å­¸å“¡" style="padding: 10px 15px;">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // å¾é›²ç«¯åˆªé™¤å­¸å“¡
        async function deleteStudentFromCloud(studentId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å­¸å“¡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                return;
            }

            showNotification('ğŸ”„ æ­£åœ¨åˆªé™¤å­¸å“¡...', 'info');

            try {
                // æ³¨æ„ï¼šç›®å‰å¯èƒ½æ²’æœ‰å°ˆé–€çš„åˆªé™¤APIï¼Œæ‰€ä»¥å…ˆæç¤ºæ‰‹å‹•åˆªé™¤
                showNotification('âš ï¸ è«‹æ‰‹å‹•åˆ° Google Sheets åˆªé™¤æ­¤å­¸å“¡è¨˜éŒ„', 'warning', 5000);
                
                // å¦‚æœæœ‰åˆªé™¤APIï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç¢¼ï¼š
                /*
                const response = await fetch('/api/delete-student', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        studentId: studentId
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('âœ… å­¸å“¡å·²æˆåŠŸåˆªé™¤', 'success');
                    await loadStudentsFromCloud();
                } else {
                    throw new Error(result.message || 'åˆªé™¤å¤±æ•—');
                }
                */
            } catch (error) {
                console.error('åˆªé™¤å­¸å“¡éŒ¯èª¤:', error);
                showNotification('âŒ åˆªé™¤å­¸å“¡å¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStatistics(studentArray = []) {
            const totalStudents = studentArray.length;
            const activeStudents = studentArray.filter(s => s.status === 'åœ¨è®€').length;
            const classes = [...new Set(studentArray.map(s => s.class))].filter(c => c).length;
            
            console.log(`ğŸ“Š çµ±è¨ˆ: ç¸½å­¸å“¡ ${totalStudents}, åœ¨è®€ ${activeStudents}, ç­åˆ¥ ${classes}`);
        }

        // å„²å­˜ä¸¦è‡ªå‹•ä¸Šå‚³é»åè¨˜éŒ„ (ä¸€éµå®Œæˆ)
        async function saveAndUploadAttendance() {
            console.log('=== é–‹å§‹å„²å­˜ä¸¦è‡ªå‹•ä¸Šå‚³é»åè¨˜éŒ„ ===');
            
            // å…ˆå„²å­˜åˆ°æœ¬åœ°
            await saveAttendance();
            
            // ç­‰å¾…ä¸€ä¸‹è®“æœ¬åœ°å„²å­˜å®Œæˆ
            setTimeout(async () => {
                // æª¢æŸ¥æ˜¯å¦æœ‰è¨˜éŒ„
                if (todayAttendance.length > 0) {
                    console.log('âœ… æœ¬åœ°å„²å­˜å®Œæˆï¼Œé–‹å§‹è‡ªå‹•ä¸Šå‚³...');
                    // è‡ªå‹•ä¸Šå‚³åˆ° Google Sheets
                    await syncAttendanceToCloud();
                } else {
                    console.log('âš ï¸ æ²’æœ‰é»åè¨˜éŒ„å¯ä¸Šå‚³');
                }
            }, 1000);
        }
    </script>
</body>
</html>
