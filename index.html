<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Â≠∏Âì°ÁÆ°ÁêÜÁ≥ªÁµ± - VercelÁâà v2.1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            color: #333; 
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; padding: 40px; border-radius: 20px; margin-bottom: 30px; 
            text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        .card { 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
            padding: 30px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.2);
        }
        .btn { 
            padding: 14px 28px; border: none; border-radius: 12px; cursor: pointer; 
            font-size: 16px; margin: 8px; transition: all 0.3s ease; font-weight: 600;
        }
        .btn-primary { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
        .btn-success { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ffc107, #e0a800); color: #212529; }
        .btn-danger { background: linear-gradient(135deg, #dc3545, #c82333); color: white; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        
        .form-group { margin-bottom: 25px; }
        .form-group label { 
            display: block; margin-bottom: 8px; font-weight: 600; 
            color: #555; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 15px 20px; border: 2px solid #e1e5e9; 
            border-radius: 12px; font-size: 16px; transition: all 0.3s ease;
            background: rgba(255,255,255,0.8);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: #007bff; 
            box-shadow: 0 0 0 4px rgba(0,123,255,0.1);
            background: white;
        }
        
        .student-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 25px; border-radius: 15px; margin-bottom: 15px; 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
            transition: all 0.3s ease; border-left: 5px solid #007bff;
        }
        .student-item:hover { 
            background: linear-gradient(135deg, #e9ecef, #dee2e6); 
            transform: translateX(10px); box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .notification { 
            position: fixed; top: 30px; right: 30px; padding: 20px 30px; 
            border-radius: 15px; color: white; font-weight: 600; z-index: 1000; 
            opacity: 0; transition: all 0.4s ease; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .notification.success { background: linear-gradient(135deg, #28a745, #20c997); }
        .notification.error { background: linear-gradient(135deg, #dc3545, #e74c3c); }
        .notification.warning { background: linear-gradient(135deg, #ffc107, #f39c12); color: #333; }
        .notification.show { opacity: 1; transform: translateY(0); }
        
        .status-indicator { 
            display: inline-block; width: 14px; height: 14px; border-radius: 50%; 
            margin-left: 10px; animation: pulse 2s infinite;
        }
        .status-online { background: #28a745; box-shadow: 0 0 15px rgba(40,167,69,0.6); }
        .status-offline { background: #dc3545; box-shadow: 0 0 15px rgba(220,53,69,0.6); }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .tabs { 
            display: flex; border-bottom: 3px solid #e9ecef; margin-bottom: 30px; 
            background: rgba(255,255,255,0.9); border-radius: 15px 15px 0 0; 
            overflow: hidden; backdrop-filter: blur(10px);
        }
        .tab { 
            padding: 20px 35px; cursor: pointer; border: none; background: none; 
            font-size: 16px; font-weight: 600; transition: all 0.3s ease; 
            position: relative; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .tab.active { 
            background: linear-gradient(135deg, #007bff, #0056b3); 
            color: white; 
        }
        .tab:not(.active):hover { background: rgba(0,123,255,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .grid-form { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 25px; 
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 25px; 
        }
        .stat-card { 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
            padding: 30px; border-radius: 20px; text-align: center; 
            border-left: 6px solid #007bff; transition: all 0.3s ease;
        }
        .stat-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .sync-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 30px; 
        }
        .sync-card { 
            text-align: center; padding: 40px; border-radius: 20px; 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
            transition: all 0.3s ease;
        }
        .sync-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
        }
        
        .empty-state { 
            text-align: center; padding: 80px 20px; color: #999; 
        }
        .empty-state h3 { 
            margin-bottom: 15px; color: #666; font-size: 24px; 
        }
        .empty-state p { font-size: 16px; line-height: 1.6; }
        
        /* ÈªûÂêçÊåâÈàïÊ®£Âºè */
        .attendance-btn {
            transition: all 0.3s ease !important;
            border: 2px solid transparent !important;
            font-weight: 600 !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        
        .attendance-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
        }
        
        .attendance-btn:active {
            transform: translateY(0) !important;
        }
        
        .attendance-btn.active {
            border: 2px solid #fff !important;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25) !important;
        }
        
        .btn-success.active {
            background-color: #198754 !important;
            transform: scale(0.95) !important;
        }
        
        .btn-warning.active {
            background-color: #ffc107 !important;
            transform: scale(0.95) !important;
        }
        
        .btn-primary.active {
            background-color: #0d6efd !important;
            transform: scale(0.95) !important;
        }

        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header { padding: 30px 20px; }
            .header h1 { font-size: 2rem; }
            .grid-form { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; }
            .sync-grid { grid-template-columns: 1fr; }
            .tabs { flex-wrap: wrap; }
            .tab { padding: 15px 20px; }
            .attendance-btn { padding: 8px 16px !important; font-size: 14px !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Â≠∏Âì°ÁÆ°ÁêÜÁ≥ªÁµ±</h1>
            <p>Vercel + Google Sheets ÁâàÊú¨</p>
            <div style="margin-top: 20px;">
                <span style="font-size: 16px;">‰º∫ÊúçÂô®ÁãÄÊÖã:</span>
                <span class="status-indicator status-offline" id="serverStatus"></span>
                <span id="statusText" style="font-weight: 600;">Ê™¢Ê∏¨‰∏≠...</span>
            </div>
                </div>

        <!-- Ê®ôÁ±§È†ÅÂ∞éËà™ -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('students', this)">üë• Êñ∞Â¢ûÂ≠∏Âì°</button>
            <button class="tab" onclick="showTab('attendance', this)">‚úÖ ÈªûÂêçÁ≥ªÁµ±</button>
            <button class="tab" onclick="showTab('sync', this)">‚òÅÔ∏è Èõ≤Á´ØÂêåÊ≠•</button>
                </div>

        <!-- Â≠∏Âì°ÁÆ°ÁêÜÊ®ôÁ±§ -->
        <div id="studentsTab" class="tab-content active">
            <div class="card">
                <h3 style="margin-bottom: 30px; color: #333; font-size: 24px;">‚ûï Êñ∞Â¢ûÂ≠∏Âì°</h3>
                <div class="grid-form">
                    <div class="form-group">
                        <label>Â≠∏Âì°ÂßìÂêç *</label>
                        <input type="text" id="studentName" placeholder="Ë´ãËº∏ÂÖ•Â≠∏Âì°ÂßìÂêç" required>
                </div>
                    <div class="form-group">
                        <label>Âà•Âêç/Ëã±ÊñáÂêç</label>
                        <input type="text" id="studentNickname" placeholder="Âà•ÂêçÊàñËã±ÊñáÂêç (ÈÅ∏Â°´)">
                </div>
                    <div class="form-group">
                        <label>Áè≠Âà•</label>
                        <select id="studentClass">
                            <option value="">Ë´ãÈÅ∏ÊìáÁè≠Âà•</option>
                            <!-- Áè≠Âà•ÈÅ∏È†ÖÂ∞áÂæû Google Sheets ÂãïÊÖãËºâÂÖ• -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ËÅØÁµ°ÈõªË©±</label>
                        <input type="tel" id="studentPhone" placeholder="ËÅØÁµ°ÈõªË©±">
                        </div>
                    <div class="form-group">
                        <label>ÈõªÂ≠ê‰ø°ÁÆ±</label>
                        <input type="email" id="studentEmail" placeholder="ÈõªÂ≠ê‰ø°ÁÆ±">
                    </div>
                    <div class="form-group">
                        <label>ÁãÄÊÖã</label>
                        <select id="studentStatus">
                            <option value="Âú®ËÆÄ">Âú®ËÆÄ</option>
                            <option value="‰ºëÂ≠∏">‰ºëÂ≠∏</option>
                            <option value="Áï¢Ê•≠">Áï¢Ê•≠</option>
                            <option value="ÈÄÄÂ≠∏">ÈÄÄÂ≠∏</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>ÂÇôË®ª</label>
                    <textarea id="studentRemarks" placeholder="ÂÖ∂‰ªñÂÇôË®ªË≥áË®ä" rows="4"></textarea>
                </div>
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-success" onclick="addStudent()">‚ûï Êñ∞Â¢ûÂ≠∏Âì°</button>
                    <button class="btn btn-primary" onclick="loadStudents()">üîÑ ÈáçÊñ∞ËºâÂÖ•</button>
                    <button class="btn btn-warning" onclick="clearForm()">üßπ Ê∏ÖÁ©∫Ë°®ÂñÆ</button>
                </div>
                </div>

            <div class="card">
                <h3 style="margin-bottom: 25px; color: #333; font-size: 24px;">üìã Â≠∏Âì°ÂàóË°®</h3>
                <div class="student-list" id="studentList">
                    <div class="empty-state">
                        <h3>üîÑ ËºâÂÖ•‰∏≠...</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÈªûÂêçÁ≥ªÁµ±Ê®ôÁ±§ -->
        <div id="attendanceTab" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #333; font-size: 24px;">‚úÖ ÈªûÂêçÁ≥ªÁµ±</h3>
                
                <div class="grid-form">
                    <div class="form-group">
                        <label>Êó•Êúü *</label>
                        <input type="date" id="attendanceDate" required>
                    </div>
                    <div class="form-group">
                        <label>Áè≠Âà• *</label>
                        <select id="attendanceClass" required onchange="loadStudentsForAttendance()">
                            <option value="">Ë´ãÈÅ∏ÊìáÁè≠Âà•</option>
                            <!-- Áè≠Âà•ÈÅ∏È†ÖÂ∞áÂæû Google Sheets ÂãïÊÖãËºâÂÖ• -->
                        </select>
                    </div>
                </div>

                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-primary" onclick="startAttendance()">üöÄ ÈñãÂßãÈªûÂêç</button>
                </div>
                </div>

            <!-- ÈªûÂêçÂàóË°® -->
            <div class="card" id="attendanceListCard" style="display: none;">
                <h3 style="margin-bottom: 25px; color: #333; font-size: 24px;">üìã ÈªûÂêçÂàóË°®</h3>
                <div id="attendanceStudentsList"></div>
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-success" onclick="saveAttendance()">üíæ ÂÑ≤Â≠òÈªûÂêçË®òÈåÑ</button>
                    <button class="btn btn-warning" onclick="resetAttendance()">üîÑ ÈáçÊñ∞ÈªûÂêç</button>
                </div>
            </div>

            <!-- ‰ªäÊó•ÈªûÂêçË®òÈåÑ -->
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #333; font-size: 24px;">üìÖ ‰ªäÊó•ÈªûÂêçË®òÈåÑ</h3>
                <div class="student-list" id="todayAttendanceList">
                    <div class="empty-state">
                        <h3>üìù ÈÇÑÊ≤íÊúâ‰ªäÊó•ÁöÑÈªûÂêçË®òÈåÑ</h3>
                        <p>ÈÅ∏ÊìáÁè≠Âà•‰∏¶ÈñãÂßãÈªûÂêç</p>
                    </div>
                </div>
            </div>
                </div>

        <!-- Èõ≤Á´ØÂêåÊ≠•Ê®ôÁ±§ -->
        <div id="syncTab" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom: 30px; color: #333; font-size: 24px;">‚òÅÔ∏è Google Sheets ÂêåÊ≠•</h3>
                <div class="sync-grid">
                    <div class="sync-card">
                        <h4 style="color: #28a745; margin-bottom: 20px; font-size: 20px;">üì§ ‰∏äÂÇ≥Âà∞Èõ≤Á´Ø</h4>
                        <button class="btn btn-success" onclick="syncToCloud()" style="width: 100%; margin-bottom: 20px;">
                            ‚òÅÔ∏è ÂêåÊ≠•Â≠∏Âì°Âà∞Èõ≤Á´Ø
                        </button>
                        <p style="font-size: 14px; color: #666; line-height: 1.6;">
                            Â∞áÊú¨Âú∞Â≠∏Âì°Ë≥áÊñô‰∏äÂÇ≥Âà∞ Google Sheets<br>
                            <strong>Ê≥®ÊÑèÔºö</strong>ÊúÉË¶ÜËìãÈõ≤Á´ØÁèæÊúâË≥áÊñô
                        </p>
                    </div>
                    <div class="sync-card">
                        <h4 style="color: #007bff; margin-bottom: 20px; font-size: 20px;">üì• ÂæûÈõ≤Á´ØËºâÂÖ•</h4>
                        <button class="btn btn-primary" onclick="loadFromCloud()" style="width: 100%; margin-bottom: 20px;">
                            üì• ÂæûÈõ≤Á´ØËºâÂÖ•Â≠∏Âì°
                        </button>
                        <p style="font-size: 14px; color: #666; line-height: 1.6;">
                            Âæû Google Sheets ËºâÂÖ•Â≠∏Âì°Ë≥áÊñô<br>
                            <strong>Ê≥®ÊÑèÔºö</strong>ÊúÉË¶ÜËìãÊú¨Âú∞ÁèæÊúâË≥áÊñô
                        </p>
                    </div>
                </div>

                <div style="margin-top: 40px; padding: 25px; background: rgba(248,249,250,0.8); border-radius: 15px;">
                    <h4 style="color: #333; margin-bottom: 15px; font-size: 18px;">üìã ÂêåÊ≠•ÁãÄÊÖã</h4>
                    <p id="syncStatus" style="color: #666; font-size: 16px;">Â∞öÊú™ÈÄ≤Ë°åÂêåÊ≠•Êìç‰Ωú</p>
                </div>
            </div>
        </div>

        <!-- Áµ±Ë®àÂ†±Ë°®Ê®ôÁ±§ -->
        <div id="statsTab" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom: 30px; color: #333; font-size: 24px;">üìä Áµ±Ë®àÂ†±Ë°®</h3>
                <div class="stats-grid">
                    <div class="stat-card" style="border-left-color: #007bff;">
                        <h4 style="color: #007bff; margin-bottom: 15px; font-size: 18px;">Á∏ΩÂ≠∏Âì°Êï∏</h4>
                        <p style="font-size: 48px; font-weight: bold; margin: 15px 0; color: #333;" id="totalStudents">0</p>
                        <small style="color: #666;">ÂÖ®ÈÉ®Â≠∏Âì°</small>
                    </div>
                    <div class="stat-card" style="border-left-color: #28a745;">
                        <h4 style="color: #28a745; margin-bottom: 15px; font-size: 18px;">Âú®ËÆÄÂ≠∏Âì°</h4>
                        <p style="font-size: 48px; font-weight: bold; margin: 15px 0; color: #333;" id="activeStudents">0</p>
                        <small style="color: #666;">ÁõÆÂâçÂ∞±ËÆÄ</small>
                    </div>
                    <div class="stat-card" style="border-left-color: #ffc107;">
                        <h4 style="color: #f39c12; margin-bottom: 15px; font-size: 18px;">‰ºëÂ≠∏Â≠∏Âì°</h4>
                        <p style="font-size: 48px; font-weight: bold; margin: 15px 0; color: #333;" id="suspendedStudents">0</p>
                        <small style="color: #666;">Êö´ÊôÇ‰ºëÂ≠∏</small>
                    </div>
                    <div class="stat-card" style="border-left-color: #6c757d;">
                        <h4 style="color: #6c757d; margin-bottom: 15px; font-size: 18px;">Áï¢Ê•≠Â≠∏Âì°</h4>
                        <p style="font-size: 48px; font-weight: bold; margin: 15px 0; color: #333;" id="graduatedStudents">0</p>
                        <small style="color: #666;">Â∑≤Á∂ìÁï¢Ê•≠</small>
                    </div>
                </div>
                
                <div style="margin-top: 40px; text-align: center;">
                    <button class="btn btn-primary" onclick="updateStatistics()">üîÑ Êõ¥Êñ∞Áµ±Ë®à</button>
                    <button class="btn btn-success" onclick="exportStudentList()">üìÑ ÂåØÂá∫Â≠∏Âì°Ê∏ÖÂñÆ</button>
                </div>
            </div>
                        </div>
                        </div>

    <!-- ÈÄöÁü•ÂÖÉÁ¥† -->
    <div id="notification" class="notification"></div>

    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        let students = [];
        let todayAttendance = [];
        let currentAttendanceClass = '';
        let currentAttendanceDate = '';

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Â≠∏Âì°ÁÆ°ÁêÜÁ≥ªÁµ±ÂïüÂãï‰∏≠...');
            showNotification('Ê≠°Ëøé‰ΩøÁî®Â≠∏Âì°ÁÆ°ÁêÜÁ≥ªÁµ±ÔºÅ', 'success');
            await checkServerStatus();
            await loadStudents();
            await loadClasses(); // ËºâÂÖ•Áè≠Âà•ÈÅ∏È†Ö
            await loadFromCloudSilently();
            
            // Ë®≠ÂÆöÈ†êË®≠Êó•ÊúüÁÇ∫‰ªäÂ§©
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            
            loadTodayAttendance();
        });

        // Ê™¢Êü•‰º∫ÊúçÂô®ÁãÄÊÖã
        async function checkServerStatus() {
            console.log('üîç ÈñãÂßãÊ™¢Êü•‰º∫ÊúçÂô®ÁãÄÊÖã...');
            
            try {
                document.getElementById('statusText').textContent = 'Ê™¢Ê∏¨‰∏≠...';
                
                // ‰ΩøÁî®ÁµïÂ∞çË∑ØÂæëÁ¢∫‰øùÊ≠£Á¢∫Ë®™Âïè
                const apiUrl = window.location.origin + '/api/get-students';
                console.log('üì° API URL:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                console.log('üì° Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ API ÈüøÊáâ:', result);
                    
                    document.getElementById('serverStatus').className = 'status-indicator status-online';
                    document.getElementById('statusText').textContent = 'Á∑ö‰∏ä';
                    console.log('‚úÖ API ‰º∫ÊúçÂô®ÈÄ£Á∑öÊ≠£Â∏∏');
                    showNotification('Èõ≤Á´ØÊúçÂãôÂ∑≤ÈÄ£Êé•', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå API ÈÄ£Êé•Â§±Êïó:', error);
                document.getElementById('serverStatus').className = 'status-indicator status-offline';
                document.getElementById('statusText').textContent = 'Èõ¢Á∑ö';
                console.log('‚ö†Ô∏è API ‰º∫ÊúçÂô®Èõ¢Á∑öÔºå‰ΩøÁî®Êú¨Âú∞Ê®°Âºè');
                showNotification('‰ΩøÁî®Êú¨Âú∞Ê®°ÂºèÔºàÈõ≤Á´ØÂäüËÉΩÊö´‰∏çÂèØÁî®Ôºâ', 'warning');
            }
        }

        // Ê®ôÁ±§È†ÅÂàáÊèõ
        function showTab(tabName, element) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (element) {
                element.classList.add('active');
            }
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'attendance') {
                displayTodayAttendance();
            }
        }

        // È°ØÁ§∫ÈÄöÁü•
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Êñ∞Â¢ûÂ≠∏Âì°
        async function addStudent() {
            const name = document.getElementById('studentName').value.trim();
            if (!name) {
                showNotification('Ë´ãËº∏ÂÖ•Â≠∏Âì°ÂßìÂêç', 'error');
                return;
            }

            const student = {
                id: Date.now().toString(),
                name: name,
                nickname: document.getElementById('studentNickname').value.trim(),
                class: document.getElementById('studentClass').value,
                phone: document.getElementById('studentPhone').value.trim(),
                email: document.getElementById('studentEmail').value.trim(),
                status: document.getElementById('studentStatus').value,
                remarks: document.getElementById('studentRemarks').value.trim(),
                createdAt: new Date().toLocaleDateString('zh-TW')
            };

            students.push(student);
            localStorage.setItem('studentData', JSON.stringify(students));
            
            clearForm();
            displayStudents();
            updateStatistics();
            showNotification(`‚úÖ Â≠∏Âì°„Äå${name}„ÄçÂ∑≤ÊàêÂäüÊñ∞Â¢û`, 'success');
            
            setTimeout(() => {
                syncToCloudSilently();
            }, 1000);
        }

        // Ê∏ÖÁ©∫Ë°®ÂñÆ
        function clearForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('studentNickname').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentEmail').value = '';
            document.getElementById('studentStatus').value = 'Âú®ËÆÄ';
            document.getElementById('studentRemarks').value = '';
        }

        // ËºâÂÖ•Â≠∏Âì°Ë≥áÊñô
        async function loadStudents() {
            const localData = localStorage.getItem('studentData');
            if (localData) {
                try {
                    students = JSON.parse(localData);
                    console.log(`üìö ËºâÂÖ• ${students.length} Á≠ÜÊú¨Âú∞Â≠∏Âì°Ë≥áÊñô`);
                } catch (error) {
                    console.error('Êú¨Âú∞Ë≥áÊñôËß£ÊûêÂ§±Êïó:', error);
                    students = [];
                }
            } else {
                students = [];
            }
            
            displayStudents();
            updateStatistics();
        }

        // È°ØÁ§∫Â≠∏Âì°ÂàóË°®
        function displayStudents() {
            const list = document.getElementById('studentList');
            
            if (students.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>üìö ÈÇÑÊ≤íÊúâÂ≠∏Âì°Ë≥áÊñô</h3>
                        <p>ÈªûÊìä‰∏äÊñπÁöÑ„ÄåÊñ∞Â¢ûÂ≠∏Âì°„ÄçÊåâÈàïÈñãÂßãÂª∫Á´ã‰Ω†ÁöÑÂ≠∏Âì°ÂêçÂÜä<br>
                        ÊâÄÊúâË≥áÊñôÊúÉÂÆâÂÖ®Âú∞ÂÑ≤Â≠òÂú®‰Ω†ÁöÑÁÄèË¶ΩÂô®‰∏≠</p>
                        </div>
                `;
                return;
            }

            list.innerHTML = students.map(student => `
                <div class="student-item">
                    <div>
                        <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px; color: #333;">
                            ${student.name}
                            ${student.nickname ? `<span style="color: #666; font-weight: 400; font-size: 16px;">(${student.nickname})</span>` : ''}
                        </div>
                        <div style="color: #666; font-size: 15px; margin-bottom: 5px;">
                            <span style="margin-right: 20px; background: #e3f2fd; padding: 4px 12px; border-radius: 20px; color: #1976d2;">
                                üìö ${student.class || 'Êú™ÂàÜÈÖçÁè≠Âà•'}
                            </span>
                            <span style="color: ${getStatusColor(student.status)}; font-weight: 600;">
                                ‚óè ${student.status}
                            </span>
                        </div>
                        <div style="color: #999; font-size: 13px;">
                            üìÖ ${student.createdAt} Âª∫Á´ã
                            ${student.phone ? ` | üìû ${student.phone}` : ''}
                            ${student.email ? ` | üìß ${student.email}` : ''}
                        </div>
                        </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteStudent('${student.id}')" 
                                title="Âà™Èô§Â≠∏Âì°" style="padding: 10px 15px;">
                            üóëÔ∏è
                        </button>
                </div>
                </div>
            `).join('');
        }

        // ÂèñÂæóÁãÄÊÖãÈ°èËâ≤
        function getStatusColor(status) {
            switch (status) {
                case 'Âú®ËÆÄ': return '#28a745';
                case '‰ºëÂ≠∏': return '#ffc107';
                case 'Áï¢Ê•≠': return '#6c757d';
                case 'ÈÄÄÂ≠∏': return '#dc3545';
                default: return '#007bff';
            }
        }

        // Âà™Èô§Â≠∏Âì°
        function deleteStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;
            
            if (confirm(`‚ö†Ô∏è Á¢∫ÂÆöË¶ÅÂà™Èô§Â≠∏Âì°„Äå${student.name}„ÄçÂóéÔºü\n\nÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºåË´ãË¨πÊÖéËÄÉÊÖÆ„ÄÇ`)) {
                students = students.filter(s => s.id !== id);
                localStorage.setItem('studentData', JSON.stringify(students));
                displayStudents();
                updateStatistics();
                showNotification(`üóëÔ∏è Â≠∏Âì°„Äå${student.name}„ÄçÂ∑≤Âà™Èô§`, 'warning');
            }
        }

        // ÂêåÊ≠•Âà∞Èõ≤Á´Ø
        async function syncToCloud() {
            if (students.length === 0) {
                showNotification('Ê≤íÊúâÂ≠∏Âì°Ë≥áÊñôÂèØÂêåÊ≠•', 'warning');
                return;
            }

            try {
                showNotification('Ê≠£Âú®ÂêåÊ≠•Âà∞Èõ≤Á´Ø...', 'warning');
                document.getElementById('syncStatus').textContent = 'Ê≠£Âú®‰∏äÂÇ≥Ë≥áÊñôÂà∞ Google Sheets...';
                
                const response = await fetch(window.location.origin + '/api/sync-students', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ students })
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ ${result.message}`, 'success');
                    document.getElementById('syncStatus').textContent = `‚úÖ ${result.message} (${new Date().toLocaleString('zh-TW')})`;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('ÂêåÊ≠•Â§±Êïó:', error);
                showNotification('‚ùå ÂêåÊ≠•Â§±Êïó: ' + error.message, 'error');
                document.getElementById('syncStatus').textContent = `‚ùå ÂêåÊ≠•Â§±Êïó: ${error.message}`;
            }
        }

        // ÈùúÈªòÂêåÊ≠•Âà∞Èõ≤Á´Ø
        async function syncToCloudSilently() {
            if (students.length === 0) return;
            try {
                await fetch(window.location.origin + '/api/sync-students', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ students })
                });
                console.log(`üîÑ Ëá™ÂãïÂêåÊ≠• ${students.length} Á≠ÜÂ≠∏Âì°Ë≥áÊñôÂà∞Èõ≤Á´Ø`);
            } catch (error) {
                console.log('üîÑ Ëá™ÂãïÂêåÊ≠•Â§±Êïó');
            }
        }

        // ÂæûÈõ≤Á´ØËºâÂÖ•
        async function loadFromCloud() {
            try {
                showNotification('Ê≠£Âú®ÂæûÈõ≤Á´ØËºâÂÖ•...', 'warning');
                document.getElementById('syncStatus').textContent = 'Ê≠£Âú®Âæû Google Sheets ËºâÂÖ•Ë≥áÊñô...';
                
                const response = await fetch(window.location.origin + '/api/get-students');
                const result = await response.json();
                
                if (result.success && result.students) {
                    students = result.students;
                    localStorage.setItem('studentData', JSON.stringify(students));
                    displayStudents();
                    updateStatistics();
                    showNotification(`‚úÖ ÊàêÂäüËºâÂÖ• ${result.count} Á≠ÜÂ≠∏Âì°Ë≥áÊñô`, 'success');
                    document.getElementById('syncStatus').textContent = `‚úÖ ÊàêÂäüËºâÂÖ• ${result.count} Á≠ÜË≥áÊñô (${new Date().toLocaleString('zh-TW')})`;
                } else {
                    throw new Error(result.error || 'ËºâÂÖ•Â§±Êïó');
                }
            } catch (error) {
                console.error('ËºâÂÖ•Â§±Êïó:', error);
                showNotification('‚ùå ËºâÂÖ•Â§±Êïó: ' + error.message, 'error');
                document.getElementById('syncStatus').textContent = `‚ùå ËºâÂÖ•Â§±Êïó: ${error.message}`;
            }
        }

        // ÈùúÈªòÂæûÈõ≤Á´ØËºâÂÖ•
        async function loadFromCloudSilently() {
            try {
                const response = await fetch(window.location.origin + '/api/get-students');
                const result = await response.json();
                
                if (result.success && result.students && result.students.length > 0) {
                    if (result.students.length >= students.length) {
                        students = result.students;
                        localStorage.setItem('studentData', JSON.stringify(students));
                        displayStudents();
                        console.log(`üîÑ Ëá™ÂãïËºâÂÖ• ${result.count} Á≠ÜÈõ≤Á´ØÂ≠∏Âì°Ë≥áÊñô`);
                    }
                }
            } catch (error) {
                console.log('üì± ‰ΩøÁî®Êú¨Âú∞Ê®°Âºè');
            }
        }

        // Êõ¥Êñ∞Áµ±Ë®à
        function updateStatistics() {
            const total = students.length;
            const active = students.filter(s => s.status === 'Âú®ËÆÄ').length;
            const suspended = students.filter(s => s.status === '‰ºëÂ≠∏').length;
            const graduated = students.filter(s => s.status === 'Áï¢Ê•≠').length;

            document.getElementById('totalStudents').textContent = total;
            document.getElementById('activeStudents').textContent = active;
            document.getElementById('suspendedStudents').textContent = suspended;
            document.getElementById('graduatedStudents').textContent = graduated;
        }

        // ÂåØÂá∫Â≠∏Âì°Ê∏ÖÂñÆ
        function exportStudentList() {
            if (students.length === 0) {
                showNotification('Ê≤íÊúâÂ≠∏Âì°Ë≥áÊñôÂèØÂåØÂá∫', 'warning');
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8," 
                + "Â≠∏Âì°ÂßìÂêç,Âà•Âêç,Áè≠Âà•,ÈõªË©±,‰ø°ÁÆ±,ÁãÄÊÖã,Âª∫Á´ãÊó•Êúü,ÂÇôË®ª\n"
                + students.map(student => 
                    `"${student.name}","${student.nickname || ''}","${student.class || ''}","${student.phone || ''}","${student.email || ''}","${student.status}","${student.createdAt}","${student.remarks || ''}"`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Â≠∏Âì°Ê∏ÖÂñÆ_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`üìÑ Â≠∏Âì°Ê∏ÖÂñÆÂ∑≤ÂåØÂá∫ (${students.length} Á≠ÜË≥áÊñô)`, 'success');
        }

        // ËºâÂÖ•Áè≠Âà•Ë≥áÊñô
        async function loadClasses() {
            try {
                showNotification('Ê≠£Âú®ËºâÂÖ•Áè≠Âà•Ë≥áÊñô...', 'warning');
                document.getElementById('syncStatus').textContent = 'Ê≠£Âú®Âæû Google Sheets ËºâÂÖ•Áè≠Âà•Ë≥áÊñô...';
                
                const response = await fetch(window.location.origin + '/api/get-classes');
                const result = await response.json();
                
                if (result.success && result.classes) {
                    updateClassOptions(result.classes);
                    showNotification(`‚úÖ ÊàêÂäüËºâÂÖ• ${result.count} ÂÄãÁè≠Âà•`, 'success');
                    document.getElementById('syncStatus').textContent = `‚úÖ ÊàêÂäüËºâÂÖ• ${result.count} ÂÄãÁè≠Âà• (${new Date().toLocaleString('zh-TW')})`;
                } else if (result.error === 'Missing Google Apps Script URL configuration') {
                    showNotification('‚ö†Ô∏è Ë´ãÂÖàË®≠ÂÆö Google Apps Script URL', 'warning');
                    document.getElementById('syncStatus').textContent = '‚ö†Ô∏è Ë´ãÂÖàË®≠ÂÆö Google Apps Script URL';
                } else if (result.error === 'Invalid action') {
                    showNotification('‚ö†Ô∏è Ë´ãÊõ¥Êñ∞ Google Apps Script ‰ª£Á¢º‰ª•ÊîØÊè¥Áè≠Âà•ËºâÂÖ•ÂäüËÉΩ', 'warning');
                    document.getElementById('syncStatus').textContent = '‚ö†Ô∏è Ë´ãÊõ¥Êñ∞ Google Apps Script ‰ª£Á¢º‰ª•ÊîØÊè¥ getClasses ÂäüËÉΩ';
                } else {
                    throw new Error(result.error || 'ËºâÂÖ•Áè≠Âà•Â§±Êïó');
                }
            } catch (error) {
                console.error('ËºâÂÖ•Áè≠Âà•Â§±Êïó:', error);
                showNotification('‚ùå ËºâÂÖ•Áè≠Âà•Â§±ÊïóÔºåË´ãÊ™¢Êü• Google Apps Script Ë®≠ÂÆö', 'error');
                document.getElementById('syncStatus').textContent = `‚ùå ËºâÂÖ•Áè≠Âà•Â§±Êïó: ${error.message}`;
            }
        }



        // Êõ¥Êñ∞Áè≠Âà•ÈÅ∏È†Ö
        function updateClassOptions(classNames) {
            const selects = [
                document.getElementById('studentClass'),
                document.getElementById('attendanceClass')
            ];
            
            selects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Ë´ãÈÅ∏ÊìáÁè≠Âà•</option>';
                    
                    classNames.forEach(className => {
                        if (className && className.trim()) {
                            const option = document.createElement('option');
                            option.value = className.trim();
                            option.textContent = className.trim();
                            select.appendChild(option);
                        }
                    });
                }
            });
        }



        // ËºâÂÖ•Ë™≤Â†ÇË≥áÊñô
        async function loadSchedule() {
            try {
                showNotification('Ê≠£Âú®ËºâÂÖ•Ë™≤Â†ÇË≥áÊñô...', 'warning');
                document.getElementById('syncStatus').textContent = 'Ê≠£Âú®Âæû Google Sheets ËºâÂÖ•Ë™≤Â†ÇË≥áÊñô...';
                
                const response = await fetch(window.location.origin + '/api/get-schedule');
                const result = await response.json();
                
                if (result.success && result.schedule) {
                    classes = result.schedule;
                    localStorage.setItem('classesData', JSON.stringify(classes));
                    displayClasses();
                    console.log('üìÖ Ë™≤Â†ÇË≥áÊñô:', result.schedule);
                    showNotification(`‚úÖ ÊàêÂäüËºâÂÖ• ${result.count} Â†ÇË™≤Á®ã`, 'success');
                    document.getElementById('syncStatus').textContent = `‚úÖ ÊàêÂäüËºâÂÖ• ${result.count} Â†ÇË™≤Á®ã (${new Date().toLocaleString('zh-TW')})`;
                } else {
                    throw new Error(result.error || 'ËºâÂÖ•Ë™≤Â†ÇË≥áÊñôÂ§±Êïó');
                }
            } catch (error) {
                console.error('ËºâÂÖ•Ë™≤Â†ÇË≥áÊñôÂ§±Êïó:', error);
                showNotification('‚ùå ËºâÂÖ•Ë™≤Â†ÇË≥áÊñôÂ§±Êïó: ' + error.message, 'error');
                document.getElementById('syncStatus').textContent = `‚ùå ËºâÂÖ•Ë™≤Â†ÇË≥áÊñôÂ§±Êïó: ${error.message}`;
            }
        }

        // Êñ∞Â¢ûÁè≠ÁµÑ
        function addClass() {
            const id = document.getElementById('classId').value.trim();
            const name = document.getElementById('className').value.trim();
            const startTime = document.getElementById('classStartTime').value;
            const endTime = document.getElementById('classEndTime').value;
            const weekday = document.getElementById('classWeekday').value;
            const description = document.getElementById('classDescription').value.trim();

            if (!name) {
                showNotification('Ë´ãÂ°´ÂØ´Áè≠ÁµÑÂêçÁ®±', 'error');
                return;
            }

            const newClass = {
                id: id || 'CLASS_' + Date.now(),
                name: name,
                startTime: startTime,
                endTime: endTime,
                weekday: weekday,
                description: description,
                createdAt: new Date().toLocaleString('zh-TW')
            };

            classes.push(newClass);
            localStorage.setItem('classesData', JSON.stringify(classes));
            displayClasses();
            clearClassForm();
            showNotification(`‚úÖ Áè≠ÁµÑ„Äå${name}„ÄçÊñ∞Â¢ûÊàêÂäü`, 'success');
        }

        // È°ØÁ§∫Áè≠ÁµÑÂàóË°®
        function displayClasses() {
            const list = document.getElementById('classesList');
            
            if (classes.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>üìö ÈÇÑÊ≤íÊúâÁè≠ÁµÑË≥áÊñô</h3>
                        <p>ÈªûÊìä‰∏äÊñπÁöÑ„ÄåÊñ∞Â¢ûÁè≠ÁµÑ„ÄçÊåâÈàïÈñãÂßãÂª∫Á´ã‰Ω†ÁöÑÁè≠ÁµÑË≥áÊñô</p>
                </div>
                `;
                return;
            }

            list.innerHTML = classes.map(cls => `
                <div class="student-item">
                    <div>
                        <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px; color: #333;">
                            ${cls.name}
                            ${cls.id ? `<span style="color: #666; font-weight: 400; font-size: 14px;">(${cls.id})</span>` : ''}
                        </div>
                        <div style="color: #666; font-size: 15px; margin-bottom: 5px;">
                            ${cls.startTime && cls.endTime ? `‚è∞ ${cls.startTime} - ${cls.endTime}` : ''}
                            ${cls.weekday ? ` | üìÖ ÊòüÊúü${cls.weekday}` : ''}
                        </div>
                        <div style="color: #999; font-size: 13px;">
                            ${cls.description ? `üìù ${cls.description}` : ''}
                            ${cls.createdAt ? ` | üìÖ ${cls.createdAt} Âª∫Á´ã` : ''}
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteClass('${cls.id}')" 
                                title="Âà™Èô§Áè≠ÁµÑ" style="padding: 10px 15px;">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Âà™Èô§Áè≠ÁµÑ
        function deleteClass(id) {
            const cls = classes.find(c => c.id === id);
            if (!cls) return;
            
            if (confirm(`‚ö†Ô∏è Á¢∫ÂÆöË¶ÅÂà™Èô§Áè≠ÁµÑ„Äå${cls.name}„ÄçÂóéÔºü\n\nÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºåË´ãË¨πÊÖéËÄÉÊÖÆ„ÄÇ`)) {
                classes = classes.filter(c => c.id !== id);
                localStorage.setItem('classesData', JSON.stringify(classes));
                displayClasses();
                showNotification(`üóëÔ∏è Áè≠ÁµÑ„Äå${cls.name}„ÄçÂ∑≤Âà™Èô§`, 'warning');
            }
        }

        // Ê∏ÖÁ©∫Áè≠ÁµÑË°®ÂñÆ
        function clearClassForm() {
            document.getElementById('classId').value = '';
            document.getElementById('className').value = '';
            document.getElementById('classStartTime').value = '';
            document.getElementById('classEndTime').value = '';
            document.getElementById('classWeekday').value = '';
            document.getElementById('classDescription').value = '';
        }

        // ËºâÂÖ•Áè≠ÁµÑË≥áÊñô
        function loadClassesData() {
            const saved = localStorage.getItem('classesData');
            if (saved) {
                classes = JSON.parse(saved);
                displayClasses();
            }
        }

        // ÈñãÂßãÈªûÂêç
        function startAttendance() {
            const date = document.getElementById('attendanceDate').value;
            const className = document.getElementById('attendanceClass').value;
            
            if (!date || !className) {
                showNotification('Ë´ãÈÅ∏ÊìáÊó•ÊúüÂíåÁè≠Âà•', 'error');
                return;
            }
            
            currentAttendanceDate = date;
            currentAttendanceClass = className;
            
            // Áç≤ÂèñË©≤Áè≠Âà•ÁöÑÂ≠∏Âì°
            const classStudents = students.filter(s => s.class === className);
            
            if (classStudents.length === 0) {
                showNotification(`${className} Ê≤íÊúâÂ≠∏Âì°Ë≥áÊñô`, 'warning');
                return;
            }
            
            // È°ØÁ§∫ÈªûÂêçÂàóË°®
            displayAttendanceList(classStudents);
            document.getElementById('attendanceListCard').style.display = 'block';
            
            // Ë®≠ÁΩÆÈªûÂêçÊåâÈàï‰∫ã‰ª∂Áõ£ËÅΩÂô®
            setupAttendanceButtons();
            
            showNotification(`ÈñãÂßã ${className} ÁöÑÈªûÂêç`, 'success');
        }
        
        // È°ØÁ§∫ÈªûÂêçÂàóË°®
        function displayAttendanceList(classStudents) {
            const container = document.getElementById('attendanceStudentsList');
            
            container.innerHTML = classStudents.map(student => `
                <div class="student-item" style="margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                            ${student.name}
                            ${student.nickname ? `<span style="color: #666; font-size: 14px;">(${student.nickname})</span>` : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success attendance-btn" data-student-id="${student.id}" data-status="Âá∫Â∏≠" 
                                style="padding: 10px 20px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                            ‚úÖ Âá∫Â∏≠
                        </button>
                        <button class="btn btn-warning attendance-btn" data-student-id="${student.id}" data-status="Ë´ãÂÅá" 
                                style="padding: 10px 20px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                            üè• Ë´ãÂÅá
                        </button>
                        <button class="btn btn-primary attendance-btn" data-student-id="${student.id}" data-status="ÈÅ≤Âà∞" 
                                style="padding: 10px 20px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                            ‚è∞ ÈÅ≤Âà∞
                        </button>
                        </div>
                </div>
            `).join('');
        }
        
        // Ê®ôË®òÂá∫Â∏≠ÁãÄÊÖã
        function markAttendance(studentId, status) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // ÁßªÈô§Ë©≤Â≠∏Âì°ÁöÑËàäË®òÈåÑ
            todayAttendance = todayAttendance.filter(att => 
                !(att.studentId === studentId && att.date === currentAttendanceDate && att.className === currentAttendanceClass)
            );
            
            // Ê∑ªÂä†Êñ∞Ë®òÈåÑ
            todayAttendance.push({
                id: 'ATT_' + Date.now(),
                date: currentAttendanceDate,
                className: currentAttendanceClass,
                studentId: studentId,
                studentName: student.name,
                status: status,
                createdAt: new Date().toLocaleString('zh-TW')
            });
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã - ‰ΩøÁî®Êñ∞ÁöÑ data Â±¨ÊÄß
            const studentButtons = document.querySelectorAll(`button[data-student-id="${studentId}"]`);
            studentButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.opacity = '1';
                btn.style.transform = 'scale(1)';
            });
            
            const clickedButton = document.querySelector(`button[data-student-id="${studentId}"][data-status="${status}"]`);
            if (clickedButton) {
                clickedButton.classList.add('active');
                clickedButton.style.opacity = '0.8';
                clickedButton.style.transform = 'scale(0.95)';
            }
            
            showNotification(`${student.name} Ê®ôË®òÁÇ∫ ${status}`, 'success');
        }

        // Ë®≠ÁΩÆÈªûÂêçÊåâÈàï‰∫ã‰ª∂Áõ£ËÅΩÂô®
        function setupAttendanceButtons() {
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('attendance-btn')) {
                    event.preventDefault();
                    const studentId = event.target.getAttribute('data-student-id');
                    const status = event.target.getAttribute('data-status');
                    if (studentId && status) {
                        markAttendance(studentId, status);
                    }
                }
            });
        }
        
        // ÂÑ≤Â≠òÈªûÂêçË®òÈåÑ
        async function saveAttendance() {
            if (todayAttendance.length === 0) {
                showNotification('Ê≤íÊúâÈªûÂêçË®òÈåÑÂèØÂÑ≤Â≠ò', 'warning');
                return;
            }
            
            // ÂÑ≤Â≠òÂà∞Êú¨Âú∞
            localStorage.setItem('todayAttendance', JSON.stringify(todayAttendance));
            displayTodayAttendance();
            
            // ÂêåÊ≠•Âà∞ Google Sheets
            try {
                showNotification('Ê≠£Âú®ÂêåÊ≠•ÈªûÂêçË®òÈåÑÂà∞ Google Sheets...', 'warning');
                
                // Ê∫ñÂÇôÂêåÊ≠•Ë≥áÊñô
                const attendanceForSync = todayAttendance.map(record => {
                    const student = currentStudents.find(s => s.id === record.studentId);
                    return {
                        date: record.date,
                        class: record.className,
                        studentId: record.studentId,
                        studentName: student ? student.name : record.studentId,
                        status: record.status
                    };
                });
                
                const response = await fetch(window.location.origin + '/api/sync-attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        attendance: attendanceForSync
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ Â∑≤ÂÑ≤Â≠ò‰∏¶ÂêåÊ≠• ${todayAttendance.length} Á≠ÜÈªûÂêçË®òÈåÑÂà∞ Google Sheets`, 'success');
                } else {
                    throw new Error(result.error || 'ÂêåÊ≠•Â§±Êïó');
                }
                
            } catch (error) {
                console.error('ÂêåÊ≠•ÈªûÂêçË®òÈåÑÂ§±Êïó:', error);
                showNotification(`‚ö†Ô∏è Êú¨Âú∞ÂÑ≤Â≠òÊàêÂäüÔºå‰ΩÜÂêåÊ≠•Âà∞ Google Sheets Â§±Êïó: ${error.message}`, 'warning');
            }
            
            // Èö±ËóèÈªûÂêçÂàóË°®
            document.getElementById('attendanceListCard').style.display = 'none';
        }
        
        // ÈáçÊñ∞ÈªûÂêç
        function resetAttendance() {
            if (confirm('Á¢∫ÂÆöË¶ÅÈáçÊñ∞ÈªûÂêçÂóéÔºüÈÄôÊúÉÊ∏ÖÈô§ÁõÆÂâçÁöÑÈªûÂêçÁãÄÊÖã„ÄÇ')) {
                // Ê∏ÖÈô§‰ªäÊó•Ë©≤Áè≠Âà•ÁöÑË®òÈåÑ
                todayAttendance = todayAttendance.filter(att => 
                    !(att.date === currentAttendanceDate && att.className === currentAttendanceClass)
                );
                
                // ÈáçÊñ∞ÈñãÂßãÈªûÂêç
                startAttendance();
                showNotification('Â∑≤ÈáçÊñ∞ÈñãÂßãÈªûÂêç', 'success');
            }
        }
        
        // ËºâÂÖ•‰ªäÊó•Âá∫Â∏≠Ë®òÈåÑ
        function loadTodayAttendance() {
            const saved = localStorage.getItem('todayAttendance');
            if (saved) {
                todayAttendance = JSON.parse(saved);
            }
            displayTodayAttendance();
        }
        
        // È°ØÁ§∫‰ªäÊó•Âá∫Â∏≠Ë®òÈåÑ
        function displayTodayAttendance() {
            const list = document.getElementById('todayAttendanceList');
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = todayAttendance.filter(att => att.date === today);
            
            if (todayRecords.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>üìù ÈÇÑÊ≤íÊúâ‰ªäÊó•ÁöÑÈªûÂêçË®òÈåÑ</h3>
                        <p>ÈÅ∏ÊìáÁè≠Âà•‰∏¶ÈñãÂßãÈªûÂêç</p>
                    </div>
                `;
                return;
            }
            
            // ÊåâÁè≠Âà•ÂàÜÁµÑ
            const groupedByClass = {};
            todayRecords.forEach(att => {
                if (!groupedByClass[att.className]) {
                    groupedByClass[att.className] = [];
                }
                groupedByClass[att.className].push(att);
            });
            
            let html = '';
            Object.keys(groupedByClass).forEach(className => {
                const classRecords = groupedByClass[className];
                html += `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #333; margin-bottom: 15px; font-size: 18px;">üìö ${className}</h4>
                        ${classRecords.map(att => `
                            <div class="student-item" style="margin-bottom: 10px;">
                                <div>
                                    <div style="font-size: 16px; font-weight: 600; color: #333;">
                                        ${att.studentName}
                                        <span style="color: ${getAttendanceColor(att.status)}; font-weight: 600; margin-left: 10px;">
                                            ${getAttendanceIcon(att.status)} ${att.status}
                                        </span>
                </div>
                                    <div style="color: #999; font-size: 13px;">
                                        üìù ${att.createdAt}
            </div>
        </div>
                                <div>
                                    <button class="btn btn-danger" onclick="deleteAttendance('${att.id}')" 
                                            title="Âà™Èô§Ë®òÈåÑ" style="padding: 8px 12px; font-size: 12px;">
                                        üóëÔ∏è
                                    </button>
            </div>
        </div>
                        `).join('')}
    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        // Áç≤ÂèñÂá∫Â∏≠ÁãÄÊÖãÈ°èËâ≤
        function getAttendanceColor(status) {
            switch (status) {
                case 'Âá∫Â∏≠': return '#28a745';
                case 'Áº∫Â∏≠': return '#dc3545';
                case 'Ë´ãÂÅá': return '#6c757d';
                case 'ÈÅ≤Âà∞': return '#ffc107';
                default: return '#007bff';
            }
        }

        // Áç≤ÂèñÂá∫Â∏≠ÁãÄÊÖãÂúñÊ®ô
        function getAttendanceIcon(status) {
            switch (status) {
                case 'Âá∫Â∏≠': return '‚úÖ';
                case 'Áº∫Â∏≠': return '‚ùå';
                case 'Ë´ãÂÅá': return 'üè•';
                case 'ÈÅ≤Âà∞': return '‚è∞';
                default: return 'üìù';
            }
        }

        // Âà™Èô§Âá∫Â∏≠Ë®òÈåÑ
        function deleteAttendance(id) {
            const att = todayAttendance.find(a => a.id === id);
            if (!att) return;
            
            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå${att.studentName}„ÄçÁöÑÈªûÂêçË®òÈåÑÂóéÔºü`)) {
                todayAttendance = todayAttendance.filter(a => a.id !== id);
                localStorage.setItem('todayAttendance', JSON.stringify(todayAttendance));
                displayTodayAttendance();
                showNotification(`üóëÔ∏è Â∑≤Âà™Èô§ÈªûÂêçË®òÈåÑ`, 'warning');
            }
        }
    </script>
</body>
</html> 