<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>å­¸å“¡ç®¡ç†ç³»çµ± - Vercelç‰ˆ v2.1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            color: #333; 
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; padding: 40px; border-radius: 20px; margin-bottom: 30px; 
            text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        .card { 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
            padding: 30px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.2);
        }
        .btn { 
            padding: 14px 28px; border: none; border-radius: 12px; cursor: pointer; 
            font-size: 16px; margin: 8px; transition: all 0.3s ease; font-weight: 600;
        }
        .btn-primary { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
        .btn-success { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ffc107, #e0a800); color: #212529; }
        .btn-danger { background: linear-gradient(135deg, #dc3545, #c82333); color: white; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        
        .form-group { margin-bottom: 25px; }
        .form-group label { 
            display: block; margin-bottom: 8px; font-weight: 600; 
            color: #555; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 15px 20px; border: 2px solid #e1e5e9; 
            border-radius: 12px; font-size: 16px; transition: all 0.3s ease;
            background: rgba(255,255,255,0.8);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: #007bff; 
            box-shadow: 0 0 0 4px rgba(0,123,255,0.1);
            background: white;
        }
        
        .student-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 25px; border-radius: 15px; margin-bottom: 15px; 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
            transition: all 0.3s ease; border-left: 5px solid #007bff;
        }
        .student-item:hover { 
            background: linear-gradient(135deg, #e9ecef, #dee2e6); 
            transform: translateX(10px); box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .notification { 
            position: fixed; top: 30px; right: 30px; padding: 20px 30px; 
            border-radius: 15px; color: white; font-weight: 600; z-index: 1000; 
            opacity: 0; transition: all 0.4s ease; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .notification.success { background: linear-gradient(135deg, #28a745, #20c997); }
        .notification.error { background: linear-gradient(135deg, #dc3545, #e74c3c); }
        .notification.warning { background: linear-gradient(135deg, #ffc107, #f39c12); color: #333; }
        .notification.show { opacity: 1; transform: translateY(0); }
        
        .status-indicator { 
            display: inline-block; width: 14px; height: 14px; border-radius: 50%; 
            margin-left: 10px; animation: pulse 2s infinite;
        }
        .status-online { background: #28a745; box-shadow: 0 0 15px rgba(40,167,69,0.6); }
        .status-offline { background: #dc3545; box-shadow: 0 0 15px rgba(220,53,69,0.6); }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .tabs { 
            display: flex; border-bottom: 3px solid #e9ecef; margin-bottom: 30px; 
            background: rgba(255,255,255,0.9); border-radius: 15px 15px 0 0; 
            overflow: hidden; backdrop-filter: blur(10px);
        }
        .tab { 
            padding: 20px 35px; cursor: pointer; border: none; background: none; 
            font-size: 16px; font-weight: 600; transition: all 0.3s ease; 
            position: relative; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .tab.active { 
            background: linear-gradient(135deg, #007bff, #0056b3); 
            color: white; 
        }
        .tab:not(.active):hover { background: rgba(0,123,255,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .grid-form { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 25px; 
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 25px; 
        }
        .stat-card { 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
            padding: 30px; border-radius: 20px; text-align: center; 
            border-left: 6px solid #007bff; transition: all 0.3s ease;
        }
        .stat-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .sync-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 30px; 
        }
        .sync-card { 
            text-align: center; padding: 40px; border-radius: 20px; 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
            transition: all 0.3s ease;
        }
        .sync-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
        }
        
        .empty-state { 
            text-align: center; padding: 80px 20px; color: #999; 
        }
        .empty-state h3 { 
            margin-bottom: 15px; color: #666; font-size: 24px; 
        }
        .empty-state p { font-size: 16px; line-height: 1.6; }
        
        /* é»åæŒ‰éˆ•æ¨£å¼ */
        .attendance-btn {
            transition: all 0.3s ease !important;
            border: 2px solid transparent !important;
            font-weight: 600 !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        
        .attendance-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
        }
        
        .attendance-btn:active {
            transform: translateY(0) !important;
        }
        
        .attendance-btn.active {
            border: 2px solid #fff !important;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25) !important;
        }
        
        .btn-success.active {
            background-color: #198754 !important;
            transform: scale(0.95) !important;
        }
        
        .btn-warning.active {
            background-color: #ffc107 !important;
            transform: scale(0.95) !important;
        }
        
        .btn-primary.active {
            background-color: #0d6efd !important;
            transform: scale(0.95) !important;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header { padding: 30px 20px; }
            .header h1 { font-size: 2rem; }
            .grid-form { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; }
            .sync-grid { grid-template-columns: 1fr; }
            .tabs { flex-wrap: wrap; }
            .tab { padding: 15px 20px; }
            .attendance-btn { padding: 8px 16px !important; font-size: 14px !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ å­¸å“¡ç®¡ç†ç³»çµ±</h1>
            <p>Vercel + Google Sheets ç‰ˆæœ¬</p>
            <div style="margin-top: 20px;">
                <span style="font-size: 16px;">ä¼ºæœå™¨ç‹€æ…‹:</span>
                <span class="status-indicator status-offline" id="serverStatus"></span>
                <span id="statusText" style="font-weight: 600;">æª¢æ¸¬ä¸­...</span>
            </div>
                </div>

        <!-- æ¨™ç±¤é å°èˆª -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('students', this)">ğŸ‘¥ æ–°å¢å­¸å“¡</button>
            <button class="tab" onclick="showTab('attendance', this)">âœ… é»åç³»çµ±</button>
            <button class="tab" onclick="showTab('sync', this)">â˜ï¸ é›²ç«¯åŒæ­¥</button>
                </div>

        <!-- å­¸å“¡ç®¡ç†æ¨™ç±¤ -->
        <div id="studentsTab" class="tab-content active">
            <div class="card">
                <h3 style="margin-bottom: 30px; color: #333; font-size: 24px;">â• æ–°å¢å­¸å“¡</h3>
                <div class="grid-form">
                    <div class="form-group">
                        <label>å­¸å“¡å§“å *</label>
                        <input type="text" id="studentName" placeholder="è«‹è¼¸å…¥å­¸å“¡å§“å" required>
                </div>
                    <div class="form-group">
                        <label>åˆ¥å/è‹±æ–‡å</label>
                        <input type="text" id="studentNickname" placeholder="åˆ¥åæˆ–è‹±æ–‡å (é¸å¡«)">
                </div>
                    <div class="form-group">
                        <label>ç­åˆ¥</label>
                        <select id="studentClass">
                            <option value="">è«‹é¸æ“‡ç­åˆ¥</option>
                            <!-- ç­åˆ¥é¸é …å°‡å¾ Google Sheets å‹•æ…‹è¼‰å…¥ -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è¯çµ¡é›»è©±</label>
                        <input type="tel" id="studentPhone" placeholder="è¯çµ¡é›»è©±">
                        </div>
                    <div class="form-group">
                        <label>é›»å­ä¿¡ç®±</label>
                        <input type="email" id="studentEmail" placeholder="é›»å­ä¿¡ç®±">
                    </div>
                    <div class="form-group">
                        <label>ç‹€æ…‹</label>
                        <select id="studentStatus">
                            <option value="åœ¨è®€">åœ¨è®€</option>
                            <option value="ä¼‘å­¸">ä¼‘å­¸</option>
                            <option value="ç•¢æ¥­">ç•¢æ¥­</option>
                            <option value="é€€å­¸">é€€å­¸</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <textarea id="studentRemarks" placeholder="å…¶ä»–å‚™è¨»è³‡è¨Š" rows="4"></textarea>
                </div>
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-success" onclick="addStudent()">â• æ–°å¢å­¸å“¡</button>
                    <button class="btn btn-primary" onclick="loadStudents()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                    <button class="btn btn-warning" onclick="clearForm()">ğŸ§¹ æ¸…ç©ºè¡¨å–®</button>
                </div>
                </div>

            <div class="card">
                <h3 style="margin-bottom: 25px; color: #333; font-size: 24px;">ğŸ“‹ å­¸å“¡åˆ—è¡¨</h3>
                <div class="student-list" id="studentList">
                    <div class="empty-state">
                        <h3>ğŸ”„ è¼‰å…¥ä¸­...</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- é»åç³»çµ±æ¨™ç±¤ -->
        <div id="attendanceTab" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #333; font-size: 24px;">âœ… é»åç³»çµ±</h3>
                
                <div class="grid-form">
                    <div class="form-group">
                        <label>æ—¥æœŸ *</label>
                        <input type="date" id="attendanceDate" required>
                    </div>
                    <div class="form-group">
                        <label>ç­åˆ¥ *</label>
                        <select id="attendanceClass" required onchange="loadStudentsForAttendance()">
                            <option value="">è«‹é¸æ“‡ç­åˆ¥</option>
                            <!-- ç­åˆ¥é¸é …å°‡å¾ Google Sheets å‹•æ…‹è¼‰å…¥ -->
                        </select>
                    </div>
                </div>

                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-primary" onclick="startAttendance()">ğŸš€ é–‹å§‹é»å</button>
                </div>
                </div>

            <!-- é»ååˆ—è¡¨ -->
            <div class="card" id="attendanceListCard" style="display: none;">
                <h3 style="margin-bottom: 25px; color: #333; font-size: 24px;">ğŸ“‹ é»ååˆ—è¡¨</h3>
                <div id="attendanceStudentsList"></div>
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-success" onclick="saveAttendance()">ğŸ’¾ å„²å­˜é»åè¨˜éŒ„</button>
                    <button class="btn btn-warning" onclick="resetAttendance()">ğŸ”„ é‡æ–°é»å</button>
                </div>
            </div>

            <!-- ä»Šæ—¥é»åè¨˜éŒ„ -->
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #333; font-size: 24px;">ğŸ“… ä»Šæ—¥é»åè¨˜éŒ„</h3>
                <div class="student-list" id="todayAttendanceList">
                    <div class="empty-state">
                        <h3>ğŸ“ é‚„æ²’æœ‰ä»Šæ—¥çš„é»åè¨˜éŒ„</h3>
                        <p>é¸æ“‡ç­åˆ¥ä¸¦é–‹å§‹é»å</p>
                    </div>
                </div>
            </div>
                </div>

        <!-- é›²ç«¯åŒæ­¥æ¨™ç±¤ -->
        <div id="syncTab" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom: 30px; color: #333; font-size: 24px;">â˜ï¸ Google Sheets åŒæ­¥</h3>
                <div class="sync-grid">
                    <div class="sync-card">
                        <h4 style="color: #28a745; margin-bottom: 20px; font-size: 20px;">ğŸ“¤ ä¸Šå‚³åˆ°é›²ç«¯</h4>
                        <button class="btn btn-success" onclick="syncToCloud()" style="width: 100%; margin-bottom: 20px;">
                            â˜ï¸ åŒæ­¥å­¸å“¡åˆ°é›²ç«¯
                        </button>
                        <p style="font-size: 14px; color: #666; line-height: 1.6;">
                            å°‡æœ¬åœ°å­¸å“¡è³‡æ–™ä¸Šå‚³åˆ° Google Sheets<br>
                            <strong>æ³¨æ„ï¼š</strong>æœƒè¦†è“‹é›²ç«¯ç¾æœ‰è³‡æ–™
                        </p>
                    </div>
                    <div class="sync-card">
                        <h4 style="color: #007bff; margin-bottom: 20px; font-size: 20px;">ğŸ“¥ å¾é›²ç«¯è¼‰å…¥</h4>
                        <button class="btn btn-primary" onclick="loadFromCloud()" style="width: 100%; margin-bottom: 20px;">
                            ğŸ“¥ å¾é›²ç«¯è¼‰å…¥å­¸å“¡
                        </button>
                        <p style="font-size: 14px; color: #666; line-height: 1.6;">
                            å¾ Google Sheets è¼‰å…¥å­¸å“¡è³‡æ–™<br>
                            <strong>æ³¨æ„ï¼š</strong>æœƒè¦†è“‹æœ¬åœ°ç¾æœ‰è³‡æ–™
                        </p>
                    </div>
                </div>

                <div style="margin-top: 40px; padding: 25px; background: rgba(248,249,250,0.8); border-radius: 15px;">
                    <h4 style="color: #333; margin-bottom: 15px; font-size: 18px;">ğŸ“‹ åŒæ­¥ç‹€æ…‹</h4>
                    <p id="syncStatus" style="color: #666; font-size: 16px;">å°šæœªé€²è¡ŒåŒæ­¥æ“ä½œ</p>
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆå ±è¡¨æ¨™ç±¤ -->
        <div id="statsTab" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom: 30px; color: #333; font-size: 24px;">ğŸ“Š çµ±è¨ˆå ±è¡¨</h3>
                <div class="stats-grid">
                    <div class="stat-card" style="border-left-color: #007bff;">
                        <h4 style="color: #007bff; margin-bottom: 15px; font-size: 18px;">ç¸½å­¸å“¡æ•¸</h4>
                        <p style="font-size: 48px; font-weight: bold; margin: 15px 0; color: #333;" id="totalStudents">0</p>
                        <small style="color: #666;">å…¨éƒ¨å­¸å“¡</small>
                    </div>
                    <div class="stat-card" style="border-left-color: #28a745;">
                        <h4 style="color: #28a745; margin-bottom: 15px; font-size: 18px;">åœ¨è®€å­¸å“¡</h4>
                        <p style="font-size: 48px; font-weight: bold; margin: 15px 0; color: #333;" id="activeStudents">0</p>
                        <small style="color: #666;">ç›®å‰å°±è®€</small>
                    </div>
                    <div class="stat-card" style="border-left-color: #ffc107;">
                        <h4 style="color: #f39c12; margin-bottom: 15px; font-size: 18px;">ä¼‘å­¸å­¸å“¡</h4>
                        <p style="font-size: 48px; font-weight: bold; margin: 15px 0; color: #333;" id="suspendedStudents">0</p>
                        <small style="color: #666;">æš«æ™‚ä¼‘å­¸</small>
                    </div>
                    <div class="stat-card" style="border-left-color: #6c757d;">
                        <h4 style="color: #6c757d; margin-bottom: 15px; font-size: 18px;">ç•¢æ¥­å­¸å“¡</h4>
                        <p style="font-size: 48px; font-weight: bold; margin: 15px 0; color: #333;" id="graduatedStudents">0</p>
                        <small style="color: #666;">å·²ç¶“ç•¢æ¥­</small>
                    </div>
                </div>
                
                <div style="margin-top: 40px; text-align: center;">
                    <button class="btn btn-primary" onclick="updateStatistics()">ğŸ”„ æ›´æ–°çµ±è¨ˆ</button>
                    <button class="btn btn-success" onclick="exportStudentList()">ğŸ“„ åŒ¯å‡ºå­¸å“¡æ¸…å–®</button>
                </div>
            </div>
                        </div>
                        </div>

    <!-- é€šçŸ¥å…ƒç´  -->
    <div id="notification" class="notification"></div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let students = [];
        let todayAttendance = [];
        let currentAttendanceClass = '';
        let currentAttendanceDate = '';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ å­¸å“¡ç®¡ç†ç³»çµ±å•Ÿå‹•ä¸­...');
            showNotification('æ­¡è¿ä½¿ç”¨å­¸å“¡ç®¡ç†ç³»çµ±ï¼', 'success');
            await checkServerStatus();
            await loadStudents();
            await loadClasses(); // è¼‰å…¥ç­åˆ¥é¸é …
            await loadFromCloudSilently();
            
            // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            
            loadTodayAttendance();
        });

        // æª¢æŸ¥ä¼ºæœå™¨ç‹€æ…‹
        async function checkServerStatus() {
            console.log('ğŸ” é–‹å§‹æª¢æŸ¥ä¼ºæœå™¨ç‹€æ…‹...');
            
            try {
                document.getElementById('statusText').textContent = 'æª¢æ¸¬ä¸­...';
                
                // ä½¿ç”¨çµ•å°è·¯å¾‘ç¢ºä¿æ­£ç¢ºè¨ªå•
                const apiUrl = window.location.origin + '/api/get-students';
                console.log('ğŸ“¡ API URL:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                console.log('ğŸ“¡ Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('âœ… API éŸ¿æ‡‰:', result);
                    
                    document.getElementById('serverStatus').className = 'status-indicator status-online';
                    document.getElementById('statusText').textContent = 'ç·šä¸Š';
                    console.log('âœ… API ä¼ºæœå™¨é€£ç·šæ­£å¸¸');
                    showNotification('é›²ç«¯æœå‹™å·²é€£æ¥', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('âŒ API é€£æ¥å¤±æ•—:', error);
                document.getElementById('serverStatus').className = 'status-indicator status-offline';
                document.getElementById('statusText').textContent = 'é›¢ç·š';
                console.log('âš ï¸ API ä¼ºæœå™¨é›¢ç·šï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
                showNotification('ä½¿ç”¨æœ¬åœ°æ¨¡å¼ï¼ˆé›²ç«¯åŠŸèƒ½æš«ä¸å¯ç”¨ï¼‰', 'warning');
            }
        }

        // æ¨™ç±¤é åˆ‡æ›
        function showTab(tabName, element) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (element) {
                element.classList.add('active');
            }
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'attendance') {
                displayTodayAttendance();
            }
        }

        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // æ–°å¢å­¸å“¡
        async function addStudent() {
            const name = document.getElementById('studentName').value.trim();
            if (!name) {
                showNotification('è«‹è¼¸å…¥å­¸å“¡å§“å', 'error');
                return;
            }

            const student = {
                id: Date.now().toString(),
                name: name,
                nickname: document.getElementById('studentNickname').value.trim(),
                class: document.getElementById('studentClass').value,
                phone: document.getElementById('studentPhone').value.trim(),
                email: document.getElementById('studentEmail').value.trim(),
                status: document.getElementById('studentStatus').value,
                remarks: document.getElementById('studentRemarks').value.trim(),
                createdAt: new Date().toLocaleDateString('zh-TW')
            };

            students.push(student);
            localStorage.setItem('studentData', JSON.stringify(students));
            
            clearForm();
            displayStudents();
            updateStatistics();
            showNotification(`âœ… å­¸å“¡ã€Œ${name}ã€å·²æˆåŠŸæ–°å¢`, 'success');
            
            setTimeout(() => {
                syncToCloudSilently();
            }, 1000);
        }

        // æ¸…ç©ºè¡¨å–®
        function clearForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('studentNickname').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentEmail').value = '';
            document.getElementById('studentStatus').value = 'åœ¨è®€';
            document.getElementById('studentRemarks').value = '';
        }

        // è¼‰å…¥å­¸å“¡è³‡æ–™
        async function loadStudents() {
            const localData = localStorage.getItem('studentData');
            if (localData) {
                try {
                    students = JSON.parse(localData);
                    console.log(`ğŸ“š è¼‰å…¥ ${students.length} ç­†æœ¬åœ°å­¸å“¡è³‡æ–™`);
                } catch (error) {
                    console.error('æœ¬åœ°è³‡æ–™è§£æå¤±æ•—:', error);
                    students = [];
                }
            } else {
                students = [];
            }
            
            displayStudents();
            updateStatistics();
        }

        // é¡¯ç¤ºå­¸å“¡åˆ—è¡¨
        function displayStudents() {
            const list = document.getElementById('studentList');
            
            if (students.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>ğŸ“š é‚„æ²’æœ‰å­¸å“¡è³‡æ–™</h3>
                        <p>é»æ“Šä¸Šæ–¹çš„ã€Œæ–°å¢å­¸å“¡ã€æŒ‰éˆ•é–‹å§‹å»ºç«‹ä½ çš„å­¸å“¡åå†Š<br>
                        æ‰€æœ‰è³‡æ–™æœƒå®‰å…¨åœ°å„²å­˜åœ¨ä½ çš„ç€è¦½å™¨ä¸­</p>
                        </div>
                `;
                return;
            }

            list.innerHTML = students.map(student => `
                <div class="student-item">
                    <div>
                        <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px; color: #333;">
                            ${student.name}
                            ${student.nickname ? `<span style="color: #666; font-weight: 400; font-size: 16px;">(${student.nickname})</span>` : ''}
                        </div>
                        <div style="color: #666; font-size: 15px; margin-bottom: 5px;">
                            <span style="margin-right: 20px; background: #e3f2fd; padding: 4px 12px; border-radius: 20px; color: #1976d2;">
                                ğŸ“š ${student.class || 'æœªåˆ†é…ç­åˆ¥'}
                            </span>
                            <span style="color: ${getStatusColor(student.status)}; font-weight: 600;">
                                â— ${student.status}
                            </span>
                        </div>
                        <div style="color: #999; font-size: 13px;">
                            ğŸ“… ${student.createdAt} å»ºç«‹
                            ${student.phone ? ` | ğŸ“ ${student.phone}` : ''}
                            ${student.email ? ` | ğŸ“§ ${student.email}` : ''}
                        </div>
                        </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteStudent('${student.id}')" 
                                title="åˆªé™¤å­¸å“¡" style="padding: 10px 15px;">
                            ğŸ—‘ï¸
                        </button>
                </div>
                </div>
            `).join('');
        }

        // å–å¾—ç‹€æ…‹é¡è‰²
        function getStatusColor(status) {
            switch (status) {
                case 'åœ¨è®€': return '#28a745';
                case 'ä¼‘å­¸': return '#ffc107';
                case 'ç•¢æ¥­': return '#6c757d';
                case 'é€€å­¸': return '#dc3545';
                default: return '#007bff';
            }
        }

        // åˆªé™¤å­¸å“¡
        function deleteStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;
            
            if (confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤å­¸å“¡ã€Œ${student.name}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œè«‹è¬¹æ…è€ƒæ…®ã€‚`)) {
                students = students.filter(s => s.id !== id);
                localStorage.setItem('studentData', JSON.stringify(students));
                displayStudents();
                updateStatistics();
                showNotification(`ğŸ—‘ï¸ å­¸å“¡ã€Œ${student.name}ã€å·²åˆªé™¤`, 'warning');
            }
        }

        // åŒæ­¥åˆ°é›²ç«¯
        async function syncToCloud() {
            if (students.length === 0) {
                showNotification('æ²’æœ‰å­¸å“¡è³‡æ–™å¯åŒæ­¥', 'warning');
                return;
            }

            try {
                showNotification('æ­£åœ¨åŒæ­¥åˆ°é›²ç«¯...', 'warning');
                document.getElementById('syncStatus').textContent = 'æ­£åœ¨ä¸Šå‚³è³‡æ–™åˆ° Google Sheets...';
                
                const response = await fetch(window.location.origin + '/api/sync-students', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ students })
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification(`âœ… ${result.message}`, 'success');
                    document.getElementById('syncStatus').textContent = `âœ… ${result.message} (${new Date().toLocaleString('zh-TW')})`;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('åŒæ­¥å¤±æ•—:', error);
                showNotification('âŒ åŒæ­¥å¤±æ•—: ' + error.message, 'error');
                document.getElementById('syncStatus').textContent = `âŒ åŒæ­¥å¤±æ•—: ${error.message}`;
            }
        }

        // éœé»˜åŒæ­¥åˆ°é›²ç«¯
        async function syncToCloudSilently() {
            if (students.length === 0) return;
            try {
                await fetch(window.location.origin + '/api/sync-students', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ students })
                });
                console.log(`ğŸ”„ è‡ªå‹•åŒæ­¥ ${students.length} ç­†å­¸å“¡è³‡æ–™åˆ°é›²ç«¯`);
            } catch (error) {
                console.log('ğŸ”„ è‡ªå‹•åŒæ­¥å¤±æ•—');
            }
        }

        // å¾é›²ç«¯è¼‰å…¥
        async function loadFromCloud() {
            try {
                showNotification('æ­£åœ¨å¾é›²ç«¯è¼‰å…¥...', 'warning');
                document.getElementById('syncStatus').textContent = 'æ­£åœ¨å¾ Google Sheets è¼‰å…¥è³‡æ–™...';
                
                const response = await fetch(window.location.origin + '/api/get-students');
                const result = await response.json();
                
                if (result.success && result.students) {
                    students = result.students;
                    localStorage.setItem('studentData', JSON.stringify(students));
                    displayStudents();
                    updateStatistics();
                    showNotification(`âœ… æˆåŠŸè¼‰å…¥ ${result.count} ç­†å­¸å“¡è³‡æ–™`, 'success');
                    document.getElementById('syncStatus').textContent = `âœ… æˆåŠŸè¼‰å…¥ ${result.count} ç­†è³‡æ–™ (${new Date().toLocaleString('zh-TW')})`;
                } else {
                    throw new Error(result.error || 'è¼‰å…¥å¤±æ•—');
                }
            } catch (error) {
                console.error('è¼‰å…¥å¤±æ•—:', error);
                showNotification('âŒ è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
                document.getElementById('syncStatus').textContent = `âŒ è¼‰å…¥å¤±æ•—: ${error.message}`;
            }
        }

        // éœé»˜å¾é›²ç«¯è¼‰å…¥
        async function loadFromCloudSilently() {
            try {
                const response = await fetch(window.location.origin + '/api/get-students');
                const result = await response.json();
                
                if (result.success && result.students && result.students.length > 0) {
                    if (result.students.length >= students.length) {
                        students = result.students;
                        localStorage.setItem('studentData', JSON.stringify(students));
                        displayStudents();
                        console.log(`ğŸ”„ è‡ªå‹•è¼‰å…¥ ${result.count} ç­†é›²ç«¯å­¸å“¡è³‡æ–™`);
                    }
                }
            } catch (error) {
                console.log('ğŸ“± ä½¿ç”¨æœ¬åœ°æ¨¡å¼');
            }
        }

        // æ›´æ–°çµ±è¨ˆ
        function updateStatistics() {
            const total = students.length;
            const active = students.filter(s => s.status === 'åœ¨è®€').length;
            const suspended = students.filter(s => s.status === 'ä¼‘å­¸').length;
            const graduated = students.filter(s => s.status === 'ç•¢æ¥­').length;

            document.getElementById('totalStudents').textContent = total;
            document.getElementById('activeStudents').textContent = active;
            document.getElementById('suspendedStudents').textContent = suspended;
            document.getElementById('graduatedStudents').textContent = graduated;
        }

        // åŒ¯å‡ºå­¸å“¡æ¸…å–®
        function exportStudentList() {
            if (students.length === 0) {
                showNotification('æ²’æœ‰å­¸å“¡è³‡æ–™å¯åŒ¯å‡º', 'warning');
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8," 
                + "å­¸å“¡å§“å,åˆ¥å,ç­åˆ¥,é›»è©±,ä¿¡ç®±,ç‹€æ…‹,å»ºç«‹æ—¥æœŸ,å‚™è¨»\n"
                + students.map(student => 
                    `"${student.name}","${student.nickname || ''}","${student.class || ''}","${student.phone || ''}","${student.email || ''}","${student.status}","${student.createdAt}","${student.remarks || ''}"`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `å­¸å“¡æ¸…å–®_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`ğŸ“„ å­¸å“¡æ¸…å–®å·²åŒ¯å‡º (${students.length} ç­†è³‡æ–™)`, 'success');
        }

        // è¼‰å…¥ç­åˆ¥è³‡æ–™
        async function loadClasses() {
            try {
                showNotification('æ­£åœ¨è¼‰å…¥ç­åˆ¥è³‡æ–™...', 'warning');
                document.getElementById('syncStatus').textContent = 'æ­£åœ¨å¾ Google Sheets è¼‰å…¥ç­åˆ¥è³‡æ–™...';
                
                const response = await fetch(window.location.origin + '/api/get-classes');
                const result = await response.json();
                
                if (result.success && result.classes) {
                    updateClassOptions(result.classes);
                    showNotification(`âœ… æˆåŠŸè¼‰å…¥ ${result.count} å€‹ç­åˆ¥`, 'success');
                    document.getElementById('syncStatus').textContent = `âœ… æˆåŠŸè¼‰å…¥ ${result.count} å€‹ç­åˆ¥ (${new Date().toLocaleString('zh-TW')})`;
                } else if (result.error === 'Missing Google Apps Script URL configuration') {
                    showNotification('âš ï¸ è«‹å…ˆè¨­å®š Google Apps Script URL', 'warning');
                    document.getElementById('syncStatus').textContent = 'âš ï¸ è«‹å…ˆè¨­å®š Google Apps Script URL';
                } else if (result.error === 'Invalid action') {
                    showNotification('âš ï¸ è«‹æ›´æ–° Google Apps Script ä»£ç¢¼ä»¥æ”¯æ´ç­åˆ¥è¼‰å…¥åŠŸèƒ½', 'warning');
                    document.getElementById('syncStatus').textContent = 'âš ï¸ è«‹æ›´æ–° Google Apps Script ä»£ç¢¼ä»¥æ”¯æ´ getClasses åŠŸèƒ½';
                } else {
                    throw new Error(result.error || 'è¼‰å…¥ç­åˆ¥å¤±æ•—');
                }
            } catch (error) {
                console.error('è¼‰å…¥ç­åˆ¥å¤±æ•—:', error);
                showNotification('âŒ è¼‰å…¥ç­åˆ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Google Apps Script è¨­å®š', 'error');
                document.getElementById('syncStatus').textContent = `âŒ è¼‰å…¥ç­åˆ¥å¤±æ•—: ${error.message}`;
            }
        }



        // æ›´æ–°ç­åˆ¥é¸é …
        function updateClassOptions(classNames) {
            const selects = [
                document.getElementById('studentClass'),
                document.getElementById('attendanceClass')
            ];
            
            selects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">è«‹é¸æ“‡ç­åˆ¥</option>';
                    
                    classNames.forEach(className => {
                        if (className && className.trim()) {
                            const option = document.createElement('option');
                            option.value = className.trim();
                            option.textContent = className.trim();
                            select.appendChild(option);
                        }
                    });
                }
            });
        }



        // è¼‰å…¥èª²å ‚è³‡æ–™
        async function loadSchedule() {
            try {
                showNotification('æ­£åœ¨è¼‰å…¥èª²å ‚è³‡æ–™...', 'warning');
                document.getElementById('syncStatus').textContent = 'æ­£åœ¨å¾ Google Sheets è¼‰å…¥èª²å ‚è³‡æ–™...';
                
                const response = await fetch(window.location.origin + '/api/get-schedule');
                const result = await response.json();
                
                if (result.success && result.schedule) {
                    classes = result.schedule;
                    localStorage.setItem('classesData', JSON.stringify(classes));
                    displayClasses();
                    console.log('ğŸ“… èª²å ‚è³‡æ–™:', result.schedule);
                    showNotification(`âœ… æˆåŠŸè¼‰å…¥ ${result.count} å ‚èª²ç¨‹`, 'success');
                    document.getElementById('syncStatus').textContent = `âœ… æˆåŠŸè¼‰å…¥ ${result.count} å ‚èª²ç¨‹ (${new Date().toLocaleString('zh-TW')})`;
                } else {
                    throw new Error(result.error || 'è¼‰å…¥èª²å ‚è³‡æ–™å¤±æ•—');
                }
            } catch (error) {
                console.error('è¼‰å…¥èª²å ‚è³‡æ–™å¤±æ•—:', error);
                showNotification('âŒ è¼‰å…¥èª²å ‚è³‡æ–™å¤±æ•—: ' + error.message, 'error');
                document.getElementById('syncStatus').textContent = `âŒ è¼‰å…¥èª²å ‚è³‡æ–™å¤±æ•—: ${error.message}`;
            }
        }

        // æ–°å¢ç­çµ„
        function addClass() {
            const id = document.getElementById('classId').value.trim();
            const name = document.getElementById('className').value.trim();
            const startTime = document.getElementById('classStartTime').value;
            const endTime = document.getElementById('classEndTime').value;
            const weekday = document.getElementById('classWeekday').value;
            const description = document.getElementById('classDescription').value.trim();

            if (!name) {
                showNotification('è«‹å¡«å¯«ç­çµ„åç¨±', 'error');
                return;
            }

            const newClass = {
                id: id || 'CLASS_' + Date.now(),
                name: name,
                startTime: startTime,
                endTime: endTime,
                weekday: weekday,
                description: description,
                createdAt: new Date().toLocaleString('zh-TW')
            };

            classes.push(newClass);
            localStorage.setItem('classesData', JSON.stringify(classes));
            displayClasses();
            clearClassForm();
            showNotification(`âœ… ç­çµ„ã€Œ${name}ã€æ–°å¢æˆåŠŸ`, 'success');
        }

        // é¡¯ç¤ºç­çµ„åˆ—è¡¨
        function displayClasses() {
            const list = document.getElementById('classesList');
            
            if (classes.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>ğŸ“š é‚„æ²’æœ‰ç­çµ„è³‡æ–™</h3>
                        <p>é»æ“Šä¸Šæ–¹çš„ã€Œæ–°å¢ç­çµ„ã€æŒ‰éˆ•é–‹å§‹å»ºç«‹ä½ çš„ç­çµ„è³‡æ–™</p>
                </div>
                `;
                return;
            }

            list.innerHTML = classes.map(cls => `
                <div class="student-item">
                    <div>
                        <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px; color: #333;">
                            ${cls.name}
                            ${cls.id ? `<span style="color: #666; font-weight: 400; font-size: 14px;">(${cls.id})</span>` : ''}
                        </div>
                        <div style="color: #666; font-size: 15px; margin-bottom: 5px;">
                            ${cls.startTime && cls.endTime ? `â° ${cls.startTime} - ${cls.endTime}` : ''}
                            ${cls.weekday ? ` | ğŸ“… æ˜ŸæœŸ${cls.weekday}` : ''}
                        </div>
                        <div style="color: #999; font-size: 13px;">
                            ${cls.description ? `ğŸ“ ${cls.description}` : ''}
                            ${cls.createdAt ? ` | ğŸ“… ${cls.createdAt} å»ºç«‹` : ''}
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteClass('${cls.id}')" 
                                title="åˆªé™¤ç­çµ„" style="padding: 10px 15px;">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // åˆªé™¤ç­çµ„
        function deleteClass(id) {
            const cls = classes.find(c => c.id === id);
            if (!cls) return;
            
            if (confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤ç­çµ„ã€Œ${cls.name}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œè«‹è¬¹æ…è€ƒæ…®ã€‚`)) {
                classes = classes.filter(c => c.id !== id);
                localStorage.setItem('classesData', JSON.stringify(classes));
                displayClasses();
                showNotification(`ğŸ—‘ï¸ ç­çµ„ã€Œ${cls.name}ã€å·²åˆªé™¤`, 'warning');
            }
        }

        // æ¸…ç©ºç­çµ„è¡¨å–®
        function clearClassForm() {
            document.getElementById('classId').value = '';
            document.getElementById('className').value = '';
            document.getElementById('classStartTime').value = '';
            document.getElementById('classEndTime').value = '';
            document.getElementById('classWeekday').value = '';
            document.getElementById('classDescription').value = '';
        }

        // è¼‰å…¥ç­çµ„è³‡æ–™
        function loadClassesData() {
            const saved = localStorage.getItem('classesData');
            if (saved) {
                classes = JSON.parse(saved);
                displayClasses();
            }
        }

        // é–‹å§‹é»å
        function startAttendance() {
            const date = document.getElementById('attendanceDate').value;
            const className = document.getElementById('attendanceClass').value;
            
            if (!date || !className) {
                showNotification('è«‹é¸æ“‡æ—¥æœŸå’Œç­åˆ¥', 'error');
                return;
            }
            
            currentAttendanceDate = date;
            currentAttendanceClass = className;
            
            // ç²å–è©²ç­åˆ¥çš„å­¸å“¡
            const classStudents = students.filter(s => s.class === className);
            
            if (classStudents.length === 0) {
                showNotification(`${className} æ²’æœ‰å­¸å“¡è³‡æ–™`, 'warning');
                return;
            }
            
            // é¡¯ç¤ºé»ååˆ—è¡¨
            displayAttendanceList(classStudents);
            document.getElementById('attendanceListCard').style.display = 'block';
            
            // è¨­ç½®é»åæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            setupAttendanceButtons();
            
            showNotification(`é–‹å§‹ ${className} çš„é»å`, 'success');
        }
        
        // é¡¯ç¤ºé»ååˆ—è¡¨
        function displayAttendanceList(classStudents) {
            const container = document.getElementById('attendanceStudentsList');
            
            container.innerHTML = classStudents.map(student => `
                <div class="student-item" style="margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                            ${student.name}
                            ${student.nickname ? `<span style="color: #666; font-size: 14px;">(${student.nickname})</span>` : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success attendance-btn" data-student-id="${student.id}" data-status="å‡ºå¸­" 
                                style="padding: 10px 20px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                            âœ… å‡ºå¸­
                        </button>
                        <button class="btn btn-warning attendance-btn" data-student-id="${student.id}" data-status="è«‹å‡" 
                                style="padding: 10px 20px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                            ğŸ¥ è«‹å‡
                        </button>
                        <button class="btn btn-primary attendance-btn" data-student-id="${student.id}" data-status="é²åˆ°" 
                                style="padding: 10px 20px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                            â° é²åˆ°
                        </button>
                        </div>
                </div>
            `).join('');
        }
        
        // æ¨™è¨˜å‡ºå¸­ç‹€æ…‹
        function markAttendance(studentId, status) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // ç§»é™¤è©²å­¸å“¡çš„èˆŠè¨˜éŒ„
            todayAttendance = todayAttendance.filter(att => 
                !(att.studentId === studentId && att.date === currentAttendanceDate && att.className === currentAttendanceClass)
            );
            
            // æ·»åŠ æ–°è¨˜éŒ„
            todayAttendance.push({
                id: 'ATT_' + Date.now(),
                date: currentAttendanceDate,
                className: currentAttendanceClass,
                studentId: studentId,
                studentName: student.name,
                status: status,
                createdAt: new Date().toLocaleString('zh-TW')
            });
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ - ä½¿ç”¨æ–°çš„ data å±¬æ€§
            const studentButtons = document.querySelectorAll(`button[data-student-id="${studentId}"]`);
            studentButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.opacity = '1';
                btn.style.transform = 'scale(1)';
            });
            
            const clickedButton = document.querySelector(`button[data-student-id="${studentId}"][data-status="${status}"]`);
            if (clickedButton) {
                clickedButton.classList.add('active');
                clickedButton.style.opacity = '0.8';
                clickedButton.style.transform = 'scale(0.95)';
            }
            
            showNotification(`${student.name} æ¨™è¨˜ç‚º ${status}`, 'success');
        }

        // è¨­ç½®é»åæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
        function setupAttendanceButtons() {
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('attendance-btn')) {
                    event.preventDefault();
                    const studentId = event.target.getAttribute('data-student-id');
                    const status = event.target.getAttribute('data-status');
                    if (studentId && status) {
                        markAttendance(studentId, status);
                    }
                }
            });
        }
        
        // å„²å­˜é»åè¨˜éŒ„
        async function saveAttendance() {
            if (todayAttendance.length === 0) {
                showNotification('æ²’æœ‰é»åè¨˜éŒ„å¯å„²å­˜', 'warning');
                return;
            }
            
            // å„²å­˜åˆ°æœ¬åœ°
            localStorage.setItem('todayAttendance', JSON.stringify(todayAttendance));
            displayTodayAttendance();
            
            // åŒæ­¥åˆ° Google Sheets
            try {
                showNotification('æ­£åœ¨åŒæ­¥é»åè¨˜éŒ„åˆ° Google Sheets...', 'warning');
                
                // æº–å‚™åŒæ­¥è³‡æ–™
                const attendanceForSync = todayAttendance.map(record => {
                    const student = currentStudents.find(s => s.id === record.studentId);
                    return {
                        date: record.date,
                        class: record.className,
                        studentId: record.studentId,
                        studentName: student ? student.name : record.studentId,
                        status: record.status
                    };
                });
                
                const response = await fetch(window.location.origin + '/api/sync-attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        attendance: attendanceForSync
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`âœ… å·²å„²å­˜ä¸¦åŒæ­¥ ${todayAttendance.length} ç­†é»åè¨˜éŒ„åˆ° Google Sheets`, 'success');
                } else {
                    throw new Error(result.error || 'åŒæ­¥å¤±æ•—');
                }
                
            } catch (error) {
                console.error('åŒæ­¥é»åè¨˜éŒ„å¤±æ•—:', error);
                showNotification(`âš ï¸ æœ¬åœ°å„²å­˜æˆåŠŸï¼Œä½†åŒæ­¥åˆ° Google Sheets å¤±æ•—: ${error.message}`, 'warning');
            }
            
            // éš±è—é»ååˆ—è¡¨
            document.getElementById('attendanceListCard').style.display = 'none';
        }
        
        // é‡æ–°é»å
        function resetAttendance() {
            if (confirm('ç¢ºå®šè¦é‡æ–°é»åå—ï¼Ÿé€™æœƒæ¸…é™¤ç›®å‰çš„é»åç‹€æ…‹ã€‚')) {
                // æ¸…é™¤ä»Šæ—¥è©²ç­åˆ¥çš„è¨˜éŒ„
                todayAttendance = todayAttendance.filter(att => 
                    !(att.date === currentAttendanceDate && att.className === currentAttendanceClass)
                );
                
                // é‡æ–°é–‹å§‹é»å
                startAttendance();
                showNotification('å·²é‡æ–°é–‹å§‹é»å', 'success');
            }
        }
        
        // è¼‰å…¥ä»Šæ—¥å‡ºå¸­è¨˜éŒ„
        function loadTodayAttendance() {
            const saved = localStorage.getItem('todayAttendance');
            if (saved) {
                todayAttendance = JSON.parse(saved);
            }
            displayTodayAttendance();
        }
        
        // é¡¯ç¤ºä»Šæ—¥å‡ºå¸­è¨˜éŒ„
        function displayTodayAttendance() {
            const list = document.getElementById('todayAttendanceList');
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = todayAttendance.filter(att => att.date === today);
            
            if (todayRecords.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>ğŸ“ é‚„æ²’æœ‰ä»Šæ—¥çš„é»åè¨˜éŒ„</h3>
                        <p>é¸æ“‡ç­åˆ¥ä¸¦é–‹å§‹é»å</p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰ç­åˆ¥åˆ†çµ„
            const groupedByClass = {};
            todayRecords.forEach(att => {
                if (!groupedByClass[att.className]) {
                    groupedByClass[att.className] = [];
                }
                groupedByClass[att.className].push(att);
            });
            
            let html = '';
            Object.keys(groupedByClass).forEach(className => {
                const classRecords = groupedByClass[className];
                html += `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #333; margin-bottom: 15px; font-size: 18px;">ğŸ“š ${className}</h4>
                        ${classRecords.map(att => `
                            <div class="student-item" style="margin-bottom: 10px;">
                                <div>
                                    <div style="font-size: 16px; font-weight: 600; color: #333;">
                                        ${att.studentName}
                                        <span style="color: ${getAttendanceColor(att.status)}; font-weight: 600; margin-left: 10px;">
                                            ${getAttendanceIcon(att.status)} ${att.status}
                                        </span>
                </div>
                                    <div style="color: #999; font-size: 13px;">
                                        ğŸ“ ${att.createdAt}
            </div>
        </div>
                                <div>
                                    <button class="btn btn-danger" onclick="deleteAttendance('${att.id}')" 
                                            title="åˆªé™¤è¨˜éŒ„" style="padding: 8px 12px; font-size: 12px;">
                                        ğŸ—‘ï¸
                                    </button>
            </div>
        </div>
                        `).join('')}
    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        // ç²å–å‡ºå¸­ç‹€æ…‹é¡è‰²
        function getAttendanceColor(status) {
            switch (status) {
                case 'å‡ºå¸­': return '#28a745';
                case 'ç¼ºå¸­': return '#dc3545';
                case 'è«‹å‡': return '#6c757d';
                case 'é²åˆ°': return '#ffc107';
                default: return '#007bff';
            }
        }

        // ç²å–å‡ºå¸­ç‹€æ…‹åœ–æ¨™
        function getAttendanceIcon(status) {
            switch (status) {
                case 'å‡ºå¸­': return 'âœ…';
                case 'ç¼ºå¸­': return 'âŒ';
                case 'è«‹å‡': return 'ğŸ¥';
                case 'é²åˆ°': return 'â°';
                default: return 'ğŸ“';
            }
        }

        // åˆªé™¤å‡ºå¸­è¨˜éŒ„
        function deleteAttendance(id) {
            const att = todayAttendance.find(a => a.id === id);
            if (!att) return;
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${att.studentName}ã€çš„é»åè¨˜éŒ„å—ï¼Ÿ`)) {
                todayAttendance = todayAttendance.filter(a => a.id !== id);
                localStorage.setItem('todayAttendance', JSON.stringify(todayAttendance));
                displayTodayAttendance();
                showNotification(`ğŸ—‘ï¸ å·²åˆªé™¤é»åè¨˜éŒ„`, 'warning');
            }
        }
    </script>
</body>
</html> 