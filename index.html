<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學員管理系統 - Vercel版</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f7fa; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .card { background: white; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 30px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.18); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 5px; transition: all 0.3s ease; font-weight: 500; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 8px; 
            font-size: 16px; transition: border-color 0.3s ease; 
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        .student-list { max-height: 500px; overflow-y: auto; }
        .student-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 20px; border-bottom: 1px solid #eee; border-radius: 8px; 
            margin-bottom: 10px; background: #f8f9fa; transition: all 0.3s ease;
        }
        .student-item:hover { background: #e9ecef; transform: translateX(5px); }
        .notification { 
            position: fixed; top: 20px; right: 20px; padding: 16px 24px; 
            border-radius: 12px; color: white; font-weight: 600; z-index: 1000; 
            opacity: 0; transition: all 0.3s ease; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .notification.success { background: linear-gradient(135deg, #28a745, #20c997); }
        .notification.error { background: linear-gradient(135deg, #dc3545, #e74c3c); }
        .notification.warning { background: linear-gradient(135deg, #ffc107, #f39c12); color: #333; }
        .notification.show { opacity: 1; transform: translateY(0); }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-left: 10px; }
        .status-online { background: #28a745; box-shadow: 0 0 10px rgba(40,167,69,0.5); }
        .status-offline { background: #dc3545; box-shadow: 0 0 10px rgba(220,53,69,0.5); }
        .tabs { 
            display: flex; border-bottom: 2px solid #e9ecef; margin-bottom: 30px; 
            background: white; border-radius: 12px 12px 0 0; overflow: hidden;
        }
        .tab { 
            padding: 18px 30px; cursor: pointer; border: none; background: none; 
            font-size: 16px; font-weight: 500; transition: all 0.3s ease; 
        }
        .tab.active { background: #007bff; color: white; }
        .tab:not(.active):hover { background: #f8f9fa; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
            padding: 25px; border-radius: 12px; text-align: center; 
            border-left: 4px solid #007bff; transition: transform 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .sync-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; }
        .sync-card { text-align: center; padding: 30px; border-radius: 12px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); }
        .loading { text-align: center; padding: 40px; color: #666; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state h3 { margin-bottom: 10px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎓 學員管理系統</h1>
            <p>Vercel + Google Sheets 雲端同步版</p>
            <div style="margin-top: 15px;">
                <span>伺服器狀態:</span>
                <span class="status-indicator status-offline" id="serverStatus"></span>
                <span id="statusText">檢測中...</span>
            </div>
        </div>

        <!-- 標籤頁導航 -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('students')">👥 學員管理</button>
            <button class="tab" onclick="showTab('sync')">☁️ 雲端同步</button>
            <button class="tab" onclick="showTab('stats')">📊 統計報表</button>
        </div>

        <!-- 學員管理標籤 -->
        <div id="studentsTab" class="tab-content active">
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #333;">➕ 新增學員</h3>
                <div class="grid-form">
                    <div class="form-group">
                        <label>學員姓名 *</label>
                        <input type="text" id="studentName" placeholder="請輸入學員姓名" required>
                    </div>
                    <div class="form-group">
                        <label>別名/英文名</label>
                        <input type="text" id="studentNickname" placeholder="別名或英文名 (選填)">
                    </div>
                    <div class="form-group">
                        <label>班別</label>
                        <select id="studentClass">
                            <option value="">請選擇班別</option>
                            <option value="數學班">數學班</option>
                            <option value="英文班">英文班</option>
                            <option value="中文班">中文班</option>
                            <option value="科學班">科學班</option>
                            <option value="音樂班">音樂班</option>
                            <option value="美術班">美術班</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>聯絡電話</label>
                        <input type="tel" id="studentPhone" placeholder="聯絡電話">
                    </div>
                    <div class="form-group">
                        <label>電子信箱</label>
                        <input type="email" id="studentEmail" placeholder="電子信箱">
                    </div>
                    <div class="form-group">
                        <label>狀態</label>
                        <select id="studentStatus">
                            <option value="在讀">在讀</option>
                            <option value="休學">休學</option>
                            <option value="畢業">畢業</option>
                            <option value="退學">退學</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>備註</label>
                    <textarea id="studentRemarks" placeholder="其他備註資訊" rows="3"></textarea>
                </div>
                <div style="margin-top: 25px;">
                    <button class="btn btn-success" onclick="addStudent()">➕ 新增學員</button>
                    <button class="btn btn-primary" onclick="loadStudents()">🔄 重新載入</button>
                    <button class="btn btn-warning" onclick="clearForm()">🧹 清空表單</button>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 20px; color: #333;">📋 學員列表</h3>
                <div class="student-list" id="studentList">
                    <div class="loading">載入中...</div>
                </div>
            </div>
        </div>

        <!-- 雲端同步標籤 -->
        <div id="syncTab" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #333;">☁️ Google Sheets 同步</h3>
                <div class="sync-grid">
                    <div class="sync-card">
                        <h4 style="color: #28a745; margin-bottom: 15px;">📤 上傳到雲端</h4>
                        <button class="btn btn-success" onclick="syncToCloud()" style="width: 100%; margin-bottom: 15px;">
                            ☁️ 同步學員到雲端
                        </button>
                        <p style="font-size: 14px; color: #666; line-height: 1.5;">
                            將本地學員資料上傳到 Google Sheets，覆蓋雲端現有資料
                        </p>
                    </div>
                    <div class="sync-card">
                        <h4 style="color: #007bff; margin-bottom: 15px;">📥 從雲端載入</h4>
                        <button class="btn btn-primary" onclick="loadFromCloud()" style="width: 100%; margin-bottom: 15px;">
                            📥 從雲端載入
                        </button>
                        <p style="font-size: 14px; color: #666; line-height: 1.5;">
                            從 Google Sheets 載入學員資料，覆蓋本地現有資料
                        </p>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="color: #333; margin-bottom: 10px;">📋 同步狀態</h4>
                    <p id="syncStatus" style="color: #666;">尚未進行同步</p>
                </div>
            </div>
        </div>

        <!-- 統計報表標籤 -->
        <div id="statsTab" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #333;">📊 統計報表</h3>
                <div class="stats-grid">
                    <div class="stat-card" style="border-left-color: #007bff;">
                        <h4 style="color: #007bff; margin-bottom: 10px;">總學員數</h4>
                        <p style="font-size: 32px; font-weight: bold; margin: 10px 0; color: #333;" id="totalStudents">0</p>
                    </div>
                    <div class="stat-card" style="border-left-color: #28a745;">
                        <h4 style="color: #28a745; margin-bottom: 10px;">在讀學員</h4>
                        <p style="font-size: 32px; font-weight: bold; margin: 10px 0; color: #333;" id="activeStudents">0</p>
                    </div>
                    <div class="stat-card" style="border-left-color: #ffc107;">
                        <h4 style="color: #f39c12; margin-bottom: 10px;">休學學員</h4>
                        <p style="font-size: 32px; font-weight: bold; margin: 10px 0; color: #333;" id="suspendedStudents">0</p>
                    </div>
                    <div class="stat-card" style="border-left-color: #6c757d;">
                        <h4 style="color: #6c757d; margin-bottom: 10px;">畢業學員</h4>
                        <p style="font-size: 32px; font-weight: bold; margin: 10px 0; color: #333;" id="graduatedStudents">0</p>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="updateStatistics()">🔄 更新統計</button>
                    <button class="btn btn-success" onclick="exportStudentList()">📄 匯出學員清單</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知元素 -->
    <div id="notification" class="notification"></div>

    <script>
        // 全域變數
        let students = [];
        const API_BASE = ''; // Vercel 會自動處理相對路徑

        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 學員管理系統啟動中...');
            await checkServerStatus();
            await loadStudents();
            updateStatistics();
            showNotification('系統啟動完成！', 'success');
        });

        // 檢查伺服器狀態
        async function checkServerStatus() {
            try {
                document.getElementById('statusText').textContent = '檢測中...';
                const response = await fetch('/api/get-students');
                
                if (response.ok) {
                    document.getElementById('serverStatus').className = 'status-indicator status-online';
                    document.getElementById('statusText').textContent = '線上';
                    console.log('✅ API 伺服器連線正常');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('serverStatus').className = 'status-indicator status-offline';
                document.getElementById('statusText').textContent = '離線';
                console.log('⚠️ API 伺服器離線，使用本地模式');
            }
        }

        // 標籤頁切換
        function showTab(tabName) {
            // 移除所有 active 類別
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 啟用選中的標籤
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // 如果切換到統計頁面，更新統計
            if (tabName === 'stats') {
                updateStatistics();
            }
        }

        // 顯示通知
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // 新增學員
        async function addStudent() {
            const name = document.getElementById('studentName').value.trim();
            if (!name) {
                showNotification('請輸入學員姓名', 'error');
                return;
            }

            const student = {
                id: Date.now().toString(),
                name: name,
                nickname: document.getElementById('studentNickname').value.trim(),
                class: document.getElementById('studentClass').value,
                phone: document.getElementById('studentPhone').value.trim(),
                email: document.getElementById('studentEmail').value.trim(),
                status: document.getElementById('studentStatus').value,
                remarks: document.getElementById('studentRemarks').value.trim(),
                createdAt: new Date().toLocaleDateString('zh-TW')
            };

            students.push(student);
            localStorage.setItem('studentData', JSON.stringify(students));
            
            clearForm();
            displayStudents();
            updateStatistics();
            showNotification(`學員 ${name} 已新增`, 'success');
        }

        // 清空表單
        function clearForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('studentNickname').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentEmail').value = '';
            document.getElementById('studentStatus').value = '在讀';
            document.getElementById('studentRemarks').value = '';
        }

        // 載入學員資料
        async function loadStudents() {
            // 先從本地載入
            const localData = localStorage.getItem('studentData');
            if (localData) {
                try {
                    students = JSON.parse(localData);
                    console.log(`📚 載入 ${students.length} 筆本地學員資料`);
                } catch (error) {
                    console.error('本地資料解析失敗:', error);
                    students = [];
                }
            } else {
                students = [];
            }
            
            displayStudents();
            updateStatistics();
        }

        // 顯示學員列表
        function displayStudents() {
            const list = document.getElementById('studentList');
            
            if (students.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>📚 還沒有學員資料</h3>
                        <p>點擊上方的「新增學員」開始建立你的學員名冊</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = students.map(student => `
                <div class="student-item">
                    <div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">
                            ${student.name}
                            ${student.nickname ? `<span style="color: #666; font-weight: 400;">(${student.nickname})</span>` : ''}
                        </div>
                        <div style="color: #666; font-size: 14px;">
                            <span style="margin-right: 15px;">📚 ${student.class || '未分配班別'}</span>
                            <span style="color: ${getStatusColor(student.status)}; font-weight: 500;">● ${student.status}</span>
                        </div>
                        <div style="color: #999; font-size: 12px; margin-top: 3px;">
                            ${student.createdAt} 建立
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteStudent('${student.id}')" 
                                title="刪除學員">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        // 取得狀態顏色
        function getStatusColor(status) {
            switch (status) {
                case '在讀': return '#28a745';
                case '休學': return '#ffc107';
                case '畢業': return '#6c757d';
                case '退學': return '#dc3545';
                default: return '#007bff';
            }
        }

        // 刪除學員
        function deleteStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;
            
            if (confirm(`確定要刪除學員「${student.name}」嗎？此操作無法復原。`)) {
                students = students.filter(s => s.id !== id);
                localStorage.setItem('studentData', JSON.stringify(students));
                displayStudents();
                updateStatistics();
                showNotification(`學員 ${student.name} 已刪除`, 'warning');
            }
        }

        // 同步到雲端
        async function syncToCloud() {
            if (students.length === 0) {
                showNotification('沒有學員資料可同步', 'warning');
                return;
            }

            try {
                showNotification('正在同步到雲端...', 'warning');
                document.getElementById('syncStatus').textContent = '正在上傳資料到 Google Sheets...';
                
                const response = await fetch('/api/sync-students', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ students })
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification(result.message, 'success');
                    document.getElementById('syncStatus').textContent = `✅ ${result.message} (${new Date().toLocaleString('zh-TW')})`;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('同步失敗:', error);
                showNotification('同步失敗: ' + error.message, 'error');
                document.getElementById('syncStatus').textContent = `❌ 同步失敗: ${error.message}`;
            }
        }

        // 從雲端載入
        async function loadFromCloud() {
            try {
                showNotification('正在從雲端載入...', 'warning');
                document.getElementById('syncStatus').textContent = '正在從 Google Sheets 載入資料...';
                
                const response = await fetch('/api/get-students');
                const result = await response.json();
                
                if (result.success && result.students) {
                    students = result.students;
                    localStorage.setItem('studentData', JSON.stringify(students));
                    displayStudents();
                    updateStatistics();
                    showNotification(`成功載入 ${result.count} 筆學員資料`, 'success');
                    document.getElementById('syncStatus').textContent = `✅ 成功載入 ${result.count} 筆資料 (${new Date().toLocaleString('zh-TW')})`;
                } else {
                    throw new Error(result.error || '載入失敗');
                }
            } catch (error) {
                console.error('載入失敗:', error);
                showNotification('載入失敗: ' + error.message, 'error');
                document.getElementById('syncStatus').textContent = `❌ 載入失敗: ${error.message}`;
            }
        }

        // 更新統計
        function updateStatistics() {
            const total = students.length;
            const active = students.filter(s => s.status === '在讀').length;
            const suspended = students.filter(s => s.status === '休學').length;
            const graduated = students.filter(s => s.status === '畢業').length;

            document.getElementById('totalStudents').textContent = total;
            document.getElementById('activeStudents').textContent = active;
            document.getElementById('suspendedStudents').textContent = suspended;
            document.getElementById('graduatedStudents').textContent = graduated;
        }

        // 匯出學員清單
        function exportStudentList() {
            if (students.length === 0) {
                showNotification('沒有學員資料可匯出', 'warning');
                return;
            }

            const data = {
                exportDate: new Date().toISOString(),
                totalStudents: students.length,
                students: students
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `學員清單_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('學員清單已匯出', 'success');
        }

        // 錯誤處理
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
        });

        // 服務 Worker 註冊 (PWA 支援)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // 這裡可以註冊 service worker
            });
        }
    </script>
</body>
</html> 