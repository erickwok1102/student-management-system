<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å“¡ç³»çµ± - CORSä¿®å¾©ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; }
        .header h1 { color: white; font-size: 2em; margin-bottom: 10px; }
        .login-container { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 5px; transition: all 0.3s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { flex: 1; padding: 15px; background: rgba(255,255,255,0.1); color: white; border: none; cursor: pointer; border-radius: 10px 10px 0 0; margin-right: 5px; }
        .tab.active { background: white; color: #333; }
        .tab-content { background: white; padding: 20px; border-radius: 0 15px 15px 15px; }
        .student-list { max-height: 400px; overflow-y: auto; }
        .student-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; font-weight: bold; z-index: 1000; opacity: 0; transition: opacity 0.3s; }
        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.warning { background: #ffc107; color: #333; }
        .notification.show { opacity: 1; }
        .connection-status { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-left: 10px; }
        .connection-status.connected { background: #28a745; }
        .connection-status.disconnected { background: #dc3545; }
        .settings-panel { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <h2 style="text-align: center; margin-bottom: 30px;">ğŸ” ç®¡ç†å“¡ç™»å…¥</h2>
        <div class="form-group">
            <label>å¯†ç¢¼:</label>
            <input type="password" id="loginPassword" placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼">
        </div>
        <button class="btn btn-primary" onclick="login()" style="width: 100%;">ç™»å…¥</button>
    </div>

    <div id="mainSystem" style="display: none;">
        <div class="container">
            <div class="header">
                <h1>ğŸ‘¨â€ğŸ’¼ ç®¡ç†å“¡ç³»çµ±</h1>
                <p>å­¸å“¡ç®¡ç† & Google Sheets åŒæ­¥ (CORSä¿®å¾©ç‰ˆ)</p>
                <button class="btn btn-danger" onclick="logout()" style="float: right;">ğŸšª ç™»å‡º</button>
                <div style="clear: both;"></div>
            </div>

            <!-- è¨­å®šé¢æ¿ -->
            <div class="settings-panel">
                <h3>ğŸ”§ ç³»çµ±è¨­å®š</h3>
                <div style="display: flex; gap: 20px; margin-top: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Google Sheets API Key:</label>
                        <input type="text" id="apiKeyInput" placeholder="è«‹è¼¸å…¥ API Key">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Google Sheets ID:</label>
                        <input type="text" id="sheetIdInput" placeholder="è«‹è¼¸å…¥ Sheet ID">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Apps Script URL:</label>
                        <input type="text" id="appsScriptInput" placeholder="è«‹è¼¸å…¥ Apps Script URL">
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                    <button class="btn btn-success" onclick="testConnection()">ğŸ”— æ¸¬è©¦é€£æ¥</button>
                    <span id="connectionStatus">é€£æ¥ç‹€æ…‹: <span class="connection-status disconnected"></span></span>
                </div>
            </div>

            <!-- æ¨™ç±¤é  -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('students')">ğŸ‘¥ å­¸å“¡ç®¡ç†</button>
                <button class="tab" onclick="showTab('sync')">â˜ï¸ é›²ç«¯åŒæ­¥</button>
            </div>

            <!-- å­¸å“¡ç®¡ç† -->
            <div id="studentsTab" class="tab-content">
                <h3>ğŸ‘¥ å­¸å“¡ç®¡ç†</h3>
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>å­¸å“¡å§“å *:</label>
                        <input type="text" id="studentName" placeholder="è«‹è¼¸å…¥å­¸å“¡å§“å">
                    </div>
                    <div class="form-group">
                        <label>åˆ¥å/è‹±æ–‡å:</label>
                        <input type="text" id="studentNickname" placeholder="åˆ¥åæˆ–è‹±æ–‡å (é¸å¡«)">
                    </div>
                    <div class="form-group">
                        <label>ç­åˆ¥:</label>
                        <select id="studentClass">
                            <option value="">è«‹é¸æ“‡ç­åˆ¥</option>
                            <option value="æ•¸å­¸ç­">æ•¸å­¸ç­</option>
                            <option value="è‹±æ–‡ç­">è‹±æ–‡ç­</option>
                            <option value="ä¸­æ–‡ç­">ä¸­æ–‡ç­</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>é›»è©±:</label>
                        <input type="text" id="studentPhone" placeholder="é›»è©±è™Ÿç¢¼">
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="studentEmail" placeholder="é›»å­ä¿¡ç®±">
                    </div>
                    <div class="form-group">
                        <label>ç‹€æ…‹:</label>
                        <select id="studentStatus">
                            <option value="åœ¨è®€">åœ¨è®€</option>
                            <option value="ä¼‘å­¸">ä¼‘å­¸</option>
                            <option value="ç•¢æ¥­">ç•¢æ¥­</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>å‚™è¨»:</label>
                    <textarea id="studentRemarks" placeholder="å…¶ä»–å‚™è¨»è³‡è¨Š"></textarea>
                </div>
                <button class="btn btn-success" onclick="addStudent()">â• æ–°å¢å­¸å“¡</button>
                <button class="btn btn-primary" onclick="loadStudentData()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                
                <div class="student-list" id="studentList"></div>
            </div>

            <!-- é›²ç«¯åŒæ­¥ -->
            <div id="syncTab" class="tab-content" style="display: none;">
                <h3>â˜ï¸ é›²ç«¯åŒæ­¥</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h4>ğŸ“¤ ä¸Šå‚³åˆ°é›²ç«¯</h4>
                        <button class="btn btn-success" onclick="syncStudentsToCloud()" style="width: 100%; margin-bottom: 10px;">â˜ï¸ åŒæ­¥å­¸å“¡åˆ°é›²ç«¯</button>
                        <button class="btn btn-success" onclick="syncAllToCloud()" style="width: 100%;">ğŸ“¤ åŒæ­¥æ‰€æœ‰æ•¸æ“š</button>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h4>ğŸ“¥ å¾é›²ç«¯è¼‰å…¥</h4>
                        <button class="btn btn-primary" onclick="loadFromCloud()" style="width: 100%; margin-bottom: 10px;">ğŸ“¥ å¾é›²ç«¯è¼‰å…¥</button>
                        <button class="btn btn-primary" onclick="loadAllFromCloud()" style="width: 100%;">ğŸ“¥ è¼‰å…¥æ‰€æœ‰æ•¸æ“š</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // å…¨å±€è®Šæ•¸
        let students = [];
        let apiKey = '';
        let spreadsheetId = '';
        let appsScriptUrl = '';

        // ç™»å…¥åŠŸèƒ½
        function login() {
            const password = document.getElementById('loginPassword').value;
            if (password === 'admin123') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                loadSettings();
                loadStudentData();
            } else {
                showNotification('å¯†ç¢¼éŒ¯èª¤', 'error');
            }
        }

        function logout() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainSystem').style.display = 'none';
            document.getElementById('loginPassword').value = '';
        }

        // æ¨™ç±¤é åˆ‡æ›
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').style.display = 'block';
        }

        // é€šçŸ¥ç³»çµ±
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // è¨­å®šç®¡ç†
        function saveSettings() {
            apiKey = document.getElementById('apiKeyInput').value;
            spreadsheetId = document.getElementById('sheetIdInput').value;
            appsScriptUrl = document.getElementById('appsScriptInput').value;
            
            localStorage.setItem('apiKey', apiKey);
            localStorage.setItem('spreadsheetId', spreadsheetId);
            localStorage.setItem('appsScriptUrl', appsScriptUrl);
            
            showNotification('è¨­å®šå·²å„²å­˜');
        }

        function loadSettings() {
            apiKey = localStorage.getItem('apiKey') || '';
            spreadsheetId = localStorage.getItem('spreadsheetId') || '';
            appsScriptUrl = localStorage.getItem('appsScriptUrl') || '';
            
            document.getElementById('apiKeyInput').value = apiKey;
            document.getElementById('sheetIdInput').value = spreadsheetId;
            document.getElementById('appsScriptInput').value = appsScriptUrl;
        }

        // æ¸¬è©¦é€£æ¥
        async function testConnection() {
            if (!apiKey || !spreadsheetId || !appsScriptUrl) {
                showNotification('è«‹å…ˆå¡«å¯«æ‰€æœ‰è¨­å®š', 'error');
                return;
            }

            try {
                // æ¸¬è©¦ Apps Script
                const response = await fetch(appsScriptUrl, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    document.querySelector('.connection-status').className = 'connection-status connected';
                    showNotification('é€£æ¥æˆåŠŸï¼');
                } else {
                    throw new Error('é€£æ¥å¤±æ•—');
                }
            } catch (error) {
                document.querySelector('.connection-status').className = 'connection-status disconnected';
                showNotification('é€£æ¥å¤±æ•—: ' + error.message, 'error');
            }
        }

        // å­¸å“¡ç®¡ç†
        function addStudent() {
            const name = document.getElementById('studentName').value;
            if (!name) {
                showNotification('è«‹è¼¸å…¥å­¸å“¡å§“å', 'error');
                return;
            }

            const student = {
                id: Date.now().toString(),
                name: name,
                nickname: document.getElementById('studentNickname').value,
                class: document.getElementById('studentClass').value,
                phone: document.getElementById('studentPhone').value,
                email: document.getElementById('studentEmail').value,
                status: document.getElementById('studentStatus').value,
                remarks: document.getElementById('studentRemarks').value,
                createdAt: new Date().toLocaleDateString()
            };

            students.push(student);
            localStorage.setItem('studentData', JSON.stringify(students));
            loadStudentData();
            clearForm();
            showNotification('å­¸å“¡å·²æ–°å¢');
        }

        function clearForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('studentNickname').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentEmail').value = '';
            document.getElementById('studentStatus').value = 'åœ¨è®€';
            document.getElementById('studentRemarks').value = '';
        }

        function loadStudentData() {
            const data = localStorage.getItem('studentData');
            if (data) {
                students = JSON.parse(data);
            }
            displayStudents();
        }

        function displayStudents() {
            const list = document.getElementById('studentList');
            list.innerHTML = '';

            students.forEach(student => {
                const item = document.createElement('div');
                item.className = 'student-item';
                item.innerHTML = `
                    <div>
                        <strong>${student.name}</strong> ${student.nickname ? `(${student.nickname})` : ''}
                        <br>
                        <small>ç­åˆ¥: ${student.class} | ç‹€æ…‹: ${student.status} | å‰µå»º: ${student.createdAt}</small>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteStudent('${student.id}')">ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function deleteStudent(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å­¸å“¡å—ï¼Ÿ')) {
                students = students.filter(s => s.id !== id);
                localStorage.setItem('studentData', JSON.stringify(students));
                loadStudentData();
                showNotification('å­¸å“¡å·²åˆªé™¤');
            }
        }

        // é›²ç«¯åŒæ­¥ - ä¿®å¾©ç‰ˆ
        async function syncStudentsToCloud() {
            if (!appsScriptUrl) {
                showNotification('è«‹å…ˆè¨­ç½® Apps Script URL', 'error');
                return;
            }

            try {
                const studentRows = [
                    ['ID', 'å§“å', 'åˆ¥å', 'ç­åˆ¥', 'é›»è©±', 'Email', 'ç‹€æ…‹', 'å‚™è¨»', 'å‰µå»ºæ—¥æœŸ']
                ];
                
                students.forEach(student => {
                    studentRows.push([
                        student.id,
                        student.name,
                        student.nickname || '',
                        student.class || '',
                        student.phone || '',
                        student.email || '',
                        student.status || 'åœ¨è®€',
                        student.remarks || '',
                        student.createdAt || ''
                    ]);
                });

                const response = await fetch(appsScriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'update',
                        worksheet: 'å­¸å“¡è³‡æ–™',
                        data: studentRows
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    showNotification('å­¸å“¡è³‡æ–™å·²åŒæ­¥åˆ°é›²ç«¯');
                } else {
                    throw new Error(result.message || 'åŒæ­¥å¤±æ•—');
                }
            } catch (error) {
                console.error('åŒæ­¥éŒ¯èª¤:', error);
                showNotification('åŒæ­¥å¤±æ•—: ' + error.message, 'error');
            }
        }

        async function syncAllToCloud() {
            await syncStudentsToCloud();
        }

        async function loadFromCloud() {
            if (!apiKey || !spreadsheetId) {
                showNotification('è«‹å…ˆè¨­ç½® API Key å’Œ Sheet ID', 'error');
                return;
            }

            try {
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/å­¸å“¡è³‡æ–™!A:I?key=${apiKey}`);
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    const newStudents = [];
                    
                    for (let i = 1; i < data.values.length; i++) {
                        const row = data.values[i];
                        if (row[0]) {
                            newStudents.push({
                                id: row[0],
                                name: row[1] || '',
                                nickname: row[2] || '',
                                class: row[3] || '',
                                phone: row[4] || '',
                                email: row[5] || '',
                                status: row[6] || 'åœ¨è®€',
                                remarks: row[7] || '',
                                createdAt: row[8] || new Date().toLocaleDateString()
                            });
                        }
                    }
                    
                    students = newStudents;
                    localStorage.setItem('studentData', JSON.stringify(students));
                    loadStudentData();
                    showNotification('å­¸å“¡è³‡æ–™å·²å¾é›²ç«¯è¼‰å…¥');
                }
            } catch (error) {
                showNotification('è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
            }
        }

        async function loadAllFromCloud() {
            await loadFromCloud();
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            loadSettings();
            loadStudentData();
        };
    </script>
</body>
</html> 